<?xml version="1.0" encoding="utf-8"?><feed xmlns="http://www.w3.org/2005/Atom" xml:lang="en"><generator uri="https://jekyllrb.com/" version="4.2.2">Jekyll</generator><link href="https://andreasvolkmann.github.io//feed.xml" rel="self" type="application/atom+xml" /><link href="https://andreasvolkmann.github.io//" rel="alternate" type="text/html" hreflang="en" /><updated>2024-04-28T17:42:08-07:00</updated><id>https://andreasvolkmann.github.io//feed.xml</id><title type="html">Andreas Volkmann</title><subtitle>A personal page for showcasing projects and talking about my interests.
</subtitle><author><name>Andreas Volkmann</name><email>avolkmann@me.com</email></author><entry><title type="html">‚ô®Ô∏è Onsen City</title><link href="https://andreasvolkmann.github.io//blog/2024-04-28-onsen-city/" rel="alternate" type="text/html" title="‚ô®Ô∏è Onsen City" /><published>2024-04-28T00:00:00-07:00</published><updated>2024-04-28T00:00:00-07:00</updated><id>https://andreasvolkmann.github.io//blog/onsen-city</id><content type="html" xml:base="https://andreasvolkmann.github.io//blog/2024-04-28-onsen-city/"><![CDATA[<ol id="markdown-toc">
  <li><a href="#yuyama-no-sato-ÊπØÂ±±„ÅÆÈáå" id="markdown-toc-yuyama-no-sato-ÊπØÂ±±„ÅÆÈáå">Yuyama no Sato ÊπØÂ±±„ÅÆÈáå</a></li>
  <li><a href="#ebisu-ÊπØÂ±ã„Åà„Å≥„Åô" id="markdown-toc-ebisu-ÊπØÂ±ã„Åà„Å≥„Åô">Ebisu ÊπØÂ±ã„Åà„Å≥„Åô</a></li>
  <li><a href="#nabeyama-ÈçãÂ±±„ÅÆÊπØ" id="markdown-toc-nabeyama-ÈçãÂ±±„ÅÆÊπØ">Nabeyama ÈçãÂ±±„ÅÆÊπØ</a></li>
  <li><a href="#kannawa-ÈâÑËº™Ê∏©Ê≥â" id="markdown-toc-kannawa-ÈâÑËº™Ê∏©Ê≥â">Kannawa ÈâÑËº™Ê∏©Ê≥â</a></li>
  <li><a href="#shibaseki-Á¥´Èñ¢Ê∏©Ê≥â" id="markdown-toc-shibaseki-Á¥´Èñ¢Ê∏©Ê≥â">Shibaseki Á¥´Èñ¢Ê∏©Ê≥â</a></li>
  <li><a href="#suginoi-area" id="markdown-toc-suginoi-area">Suginoi area</a>    <ol>
      <li><a href="#horita-Â†ÄÁî∞Ê∏©Ê≥â" id="markdown-toc-horita-Â†ÄÁî∞Ê∏©Ê≥â">Horita Â†ÄÁî∞Ê∏©Ê≥â</a></li>
      <li><a href="#mugen-no-sato-Â§¢Âπª„ÅÆÈáå" id="markdown-toc-mugen-no-sato-Â§¢Âπª„ÅÆÈáå">Mugen no Sato Â§¢Âπª„ÅÆÈáå</a></li>
      <li><a href="#suginoi-hotel-Êùâ‰πÉ‰∫ï„Éõ„ÉÜ„É´" id="markdown-toc-suginoi-hotel-Êùâ‰πÉ‰∫ï„Éõ„ÉÜ„É´">Suginoi Hotel Êùâ‰πÉ‰∫ï„Éõ„ÉÜ„É´</a></li>
    </ol>
  </li>
</ol>

<p>Finally made it to Beppu, AKA Onsen City!</p>

<p>Initially, I was doubtful whether this was the best choice for a great Onsen experience in Japan.</p>

<p>Most reports I read didn‚Äôt praise it too highly and generally dedicated little time to it.</p>

<p>Beppu turned out to be my favorite place this time and I ended up pulling in extra days to extend my stay here.</p>

<p>I highly recommend going if you enjoy onsen, as there is a lot of variety, and it‚Äôs a great place to relax.</p>

<p>I‚Äôll showcase a few of my favorite places below.</p>

<h1 id="yuyama-no-sato-ÊπØÂ±±„ÅÆÈáå">Yuyama no Sato ÊπØÂ±±„ÅÆÈáå</h1>

<p>This onsen village lies just behind Myoban (ÊòéÁ§¨), so I kind of count it into the same area.</p>

<p>After a quick checkin with the owner, who built the entire place himself,
there‚Äôs a small 5 min hike through a small bamboo forest, down to then onsen.</p>

<p>Since we didn‚Äôt meet anyone else here, this would be my secret tip.</p>

<p>  <hy-img root-margin="512px"  src="/assets/img/yuyama.png" alt="Yuyama Main Bath" >    <noscript><img data-ignore  src="/assets/img/yuyama.png" alt="Yuyama Main Bath" /></noscript>    <span class="loading" slot="loading" hidden>      <span class="icon-cog"></span>    </span>  </hy-img></p>

<p>  <hy-img root-margin="512px"  src="/assets/img/yuyama_2.png" alt="Yuyama waterfall" >    <noscript><img data-ignore  src="/assets/img/yuyama_2.png" alt="Yuyama waterfall" /></noscript>    <span class="loading" slot="loading" hidden>      <span class="icon-cog"></span>    </span>  </hy-img></p>

<p>  <hy-img root-margin="512px"  src="/assets/img/yuyama_3.png" alt="Yuyama river" >    <noscript><img data-ignore  src="/assets/img/yuyama_3.png" alt="Yuyama river" /></noscript>    <span class="loading" slot="loading" hidden>      <span class="icon-cog"></span>    </span>  </hy-img></p>

<p>There is an abundance of different pools, with the temperature on the hotter side.</p>

<h1 id="ebisu-ÊπØÂ±ã„Åà„Å≥„Åô">Ebisu ÊπØÂ±ã„Åà„Å≥„Åô</h1>

<p>Located in Myoban (ÊòéÁ§¨). They have both shared and private baths.</p>

<p>  <hy-img root-margin="512px"  src="/assets/img/ebisu_1.png" alt="Ebisu" >    <noscript><img data-ignore  src="/assets/img/ebisu_1.png" alt="Ebisu" /></noscript>    <span class="loading" slot="loading" hidden>      <span class="icon-cog"></span>    </span>  </hy-img>
  <hy-img root-margin="512px"  src="/assets/img/ebisu_2.png" alt="Ebisu geranium" >    <noscript><img data-ignore  src="/assets/img/ebisu_2.png" alt="Ebisu geranium" /></noscript>    <span class="loading" slot="loading" hidden>      <span class="icon-cog"></span>    </span>  </hy-img>
  <hy-img root-margin="512px"  src="/assets/img/ebisu_3.png" alt="Ebisu outdoor" >    <noscript><img data-ignore  src="/assets/img/ebisu_3.png" alt="Ebisu outdoor" /></noscript>    <span class="loading" slot="loading" hidden>      <span class="icon-cog"></span>    </span>  </hy-img>
  <hy-img root-margin="512px"  src="/assets/img/ebisu_4.png" alt="Ebisu private" >    <noscript><img data-ignore  src="/assets/img/ebisu_4.png" alt="Ebisu private" /></noscript>    <span class="loading" slot="loading" hidden>      <span class="icon-cog"></span>    </span>  </hy-img></p>

<h1 id="nabeyama-ÈçãÂ±±„ÅÆÊπØ">Nabeyama ÈçãÂ±±„ÅÆÊπØ</h1>

<p>There are a few free onsen pools in the mountains a small hike away from Myoban (ÊòéÁ§¨).</p>

<p>The water wasn‚Äôt quite warm enough when I got there, so it can be hit or miss, but the hike is nice and the views good, too.</p>

<h1 id="kannawa-ÈâÑËº™Ê∏©Ê≥â">Kannawa ÈâÑËº™Ê∏©Ê≥â</h1>

<p>Cozy little district with steam coming out of the ground everywhere.</p>

<p>Cats chilling, sometimes hiding their head in a crack in the ground to keep warm.</p>

<p>Tons of small ~100¬• Onsen which make it fun to hop from one to the other.</p>

<h1 id="shibaseki-Á¥´Èñ¢Ê∏©Ê≥â">Shibaseki Á¥´Èñ¢Ê∏©Ê≥â</h1>

<p>Don‚Äôt have any pictures of this one, but very worth a visit.</p>

<p>They have a very hot indoor pool, a relaxing outdoor pool, and an amazing sauna!</p>

<p>The locals are super fun here :)</p>

<h1 id="suginoi-area">Suginoi area</h1>

<p>This refers to the south-western part of Beppu, where the Suginoi Hotel is located.</p>

<p>Since these places are closely located, I group them under this moniker.</p>

<h2 id="horita-Â†ÄÁî∞Ê∏©Ê≥â">Horita Â†ÄÁî∞Ê∏©Ê≥â</h2>
<p>  <hy-img root-margin="512px"  src="/assets/img/horita.png" alt="Horita Men's bath" >    <noscript><img data-ignore  src="/assets/img/horita.png" alt="Horita Men's bath" /></noscript>    <span class="loading" slot="loading" hidden>      <span class="icon-cog"></span>    </span>  </hy-img></p>

<h2 id="mugen-no-sato-Â§¢Âπª„ÅÆÈáå">Mugen no Sato Â§¢Âπª„ÅÆÈáå</h2>

<p>Consists of multiple private onsen, which you can rent for 1h for very little money (I think 1000?).</p>

<p>  <hy-img root-margin="512px"  src="/assets/img/mugen-no-sato-yu.png" alt="Mugen no Sato private bath" >    <noscript><img data-ignore  src="/assets/img/mugen-no-sato-yu.png" alt="Mugen no Sato private bath" /></noscript>    <span class="loading" slot="loading" hidden>      <span class="icon-cog"></span>    </span>  </hy-img></p>

<p>You can also steam your own food here, using the steam from the water.</p>

<p>  <hy-img root-margin="512px"  src="/assets/img/mugen-no-sato-mushi.png" alt="Mugen no Sato steam cooking area" >    <noscript><img data-ignore  src="/assets/img/mugen-no-sato-mushi.png" alt="Mugen no Sato steam cooking area" /></noscript>    <span class="loading" slot="loading" hidden>      <span class="icon-cog"></span>    </span>  </hy-img></p>

<p>Recommend to capitalize on this and bring lots of raw ingredients.</p>

<p>Things like Kabocha turn out great.</p>

<h2 id="suginoi-hotel-Êùâ‰πÉ‰∫ï„Éõ„ÉÜ„É´">Suginoi Hotel Êùâ‰πÉ‰∫ï„Éõ„ÉÜ„É´</h2>

<p>This hotel has a rooftop outdoor pool area for swimming (heated) and an onsen area with amazing views over the Beppu bay.</p>

<p>Suggest to time your visit for sunset and enjoy the evening here.</p>

<p>  <hy-img root-margin="512px"  src="/assets/img/suginoi_1.avif" alt="Suginoi Onsen" >    <noscript><img data-ignore  src="/assets/img/suginoi_1.avif" alt="Suginoi Onsen" /></noscript>    <span class="loading" slot="loading" hidden>      <span class="icon-cog"></span>    </span>  </hy-img></p>

<p>  <hy-img root-margin="512px"  src="/assets/img/suginoi_2.jpg" alt="Suginoi Swimming Pools" >    <noscript><img data-ignore  src="/assets/img/suginoi_2.jpg" alt="Suginoi Swimming Pools" /></noscript>    <span class="loading" slot="loading" hidden>      <span class="icon-cog"></span>    </span>  </hy-img></p>

<hr />

<p>For more Onsen, see <a href="/blog/2022-10-30-onsen">some of my favorite hot springs</a>.</p>]]></content><author><name>Andreas Volkmann</name><email>avolkmann@me.com</email></author><category term="blog" /><summary type="html"><![CDATA[An entire city of onsen exceeding expectations]]></summary><media:thumbnail xmlns:media="http://search.yahoo.com/mrss/" url="https://andreasvolkmann.github.io//assets/img/onsen_beppu.jpg" /><media:content medium="image" url="https://andreasvolkmann.github.io//assets/img/onsen_beppu.jpg" xmlns:media="http://search.yahoo.com/mrss/" /></entry><entry><title type="html">‚öóÔ∏è Distilled knowledge</title><link href="https://andreasvolkmann.github.io//blog/2023-10-07-first-prompt/" rel="alternate" type="text/html" title="‚öóÔ∏è Distilled knowledge" /><published>2023-10-07T00:00:00-07:00</published><updated>2023-10-07T00:00:00-07:00</updated><id>https://andreasvolkmann.github.io//blog/first-prompt</id><content type="html" xml:base="https://andreasvolkmann.github.io//blog/2023-10-07-first-prompt/"><![CDATA[<ol id="markdown-toc">
  <li><a href="#the-intersection-of-programming-and-language" id="markdown-toc-the-intersection-of-programming-and-language">The intersection of programming and language</a></li>
  <li><a href="#distilling-prompts" id="markdown-toc-distilling-prompts">Distilling prompts</a>    <ol>
      <li><a href="#less-is-more" id="markdown-toc-less-is-more">Less is more</a></li>
      <li><a href="#forcing-the-model-" id="markdown-toc-forcing-the-model-">Forcing the model ‚Ä¶</a></li>
      <li><a href="#native-code-intuition" id="markdown-toc-native-code-intuition">Native code intuition</a></li>
    </ol>
  </li>
  <li><a href="#language-efficiency" id="markdown-toc-language-efficiency">Language efficiency</a></li>
  <li><a href="#outro" id="markdown-toc-outro">Outro</a></li>
</ol>

<p>For this post I want to record some of my first impressions of LLMs and prompting,
as well as some of the insights I believe to have gained.
It will be interesting to revisit this later on and see how it held up.</p>

<h2 id="the-intersection-of-programming-and-language">The intersection of programming and language</h2>

<p>I anticipate a new paradigm at the intersection of programming and language understanding.</p>

<p>LLMs are now capable enough so that software engineers can take off-the-shelf models and build applications with them.
In order to instruct the model, prompts are written in natural language, just like the outputs.
The hurdle of data science is no longer.</p>

<p>Anyone can write such prompts, but to truly develop reliable, effective prompts,
it seems to me one has to develop an understanding and intuition about the way the LLM speaks and comprehends language.</p>

<p>At the same time, it‚Äôs not enough to just be good at prompting.
One also needs a methodical approach to evaluate the results of the model.
This is where programming concepts like unit testing come in handy.
If you want to take your prompts to the next level, find a metric that measures the output quality,
then apply TDD (Test Driven Development) to push the prompt to its limits, by continuously testing and refining.</p>

<p>This is already being done at the model level, yielding the below chart,
which can help visualize the strengths &amp; weaknesses of each model.
<a href="https://browse.arxiv.org/pdf/2309.16583.pdf">  <hy-img root-margin="512px"  src="/assets/img/llm_model_strength_weakness.png" alt="Model Strengths &amp; Weaknesses" >    <noscript><img data-ignore  src="/assets/img/llm_model_strength_weakness.png" alt="Model Strengths &amp; Weaknesses" /></noscript>    <span class="loading" slot="loading" hidden>      <span class="icon-cog"></span>    </span>  </hy-img></a></p>

<p>Once you‚Äôve tried to combine plain programming with LLM prompts,
you might agree with me that this is the next big step for our industry.</p>

<p>I recommend <a href="https://open.spotify.com/episode/3MK8V1DbT7d5YEBlrdbBdQ">this Latent Space episode</a>, which coins the term
AI Engineer to define software engineers moving closer to the ML space to get enough proficiency to effectively apply
LLMs to produce new applications.</p>

<h2 id="distilling-prompts">Distilling prompts</h2>

<p>The art of prompting is still in its infancy and no exact science.
I don‚Äôt claim to have all the answers, but the following has worked well for me.</p>

<blockquote>
  <ul>
    <li>Most of this applies to GPT 3.5 0613</li>
    <li>Primarily targeting Reductive Operations, such as Summarization and Extraction</li>
  </ul>
</blockquote>

<p>When writing prompts, I have observed the following tendencies.</p>

<h3 id="less-is-more">Less is more</h3>

<blockquote>
  <p>You are like this tea cup, so full that nothing more can be added. Come
back to me when the cup is empty. Come back to me with an empty mind.</p>

  <p><em>Laozi</em></p>
</blockquote>

<p>Being overly prescriptive, wordy, and detailed.</p>

<p>Lots of rules, and when something doesn‚Äôt quite turn out how we want it to, we add another special case sentence.
The prompt ends up overloaded so that any single change, formatting or content, breaks it.
In such cases it is better to go back to zero, and come back witn an empty mind / prompt.</p>

<p>Try to distill your prompt down to the most essential meaning.
Every single word in your prompt matters, and there should be a reason for why you include it.</p>

<p>Just like we do with language and code,
in order to really convey our intent,
we distill our prompt down to its essence.</p>

<blockquote>
  <p>Distillation is at the very heart of all effective communication.
The more important it is that your audience hear and take action on your message,
the more distilled that message needs to be.</p>

  <p><em>Building a Second Brain by Tiago Forte</em></p>
</blockquote>

<p>Lastly, it‚Äôs worth noting that the same meaning phrased differently can lead to radically different results.
So rather than throw more words at it, I prefer to find few words which trigger the right response.</p>

<h3 id="forcing-the-model-">Forcing the model ‚Ä¶</h3>

<p>‚Ä¶ to do something it isn‚Äôt good at.</p>

<p>Outputting JSON or producing answers that require non-language thinking.</p>

<p>Instead of trying to control the output with rules and confusing the model with complex instructions where even we have to think,
I found that starting out with a highly distilled version (as little as a single sentence)
can shed some light on what the model is good at natively.</p>

<p>So rather than trying to bend the model to your will, try to <em>cooperate</em>!</p>

<p>I found that oftentimes you don‚Äôt have to instruct 3.5 about the output format at all.
It tends to produce colon-delimited key-value pairs if only you change your wording slightly.
<code class="language-plaintext highlighter-rouge">Provide X, Y, Z ...</code> seems to work well, where XYZ are properties that start with a captial letter.</p>

<p>You can save yourself lots of trouble by simply going with the flow of whatever the LLM is comfortable with.</p>

<h3 id="native-code-intuition">Native code intuition</h3>

<p>GPT 3.5 seems to have very good intuition about coding concepts.
As software engineers, this gives us superpowers, as we can boil down complex intent into sometimes single characters.</p>

<p>As an example, if you use extraction prompts like the above, you can easily communicate that you want certain
properties to be nullable/optional: <code class="language-plaintext highlighter-rouge">Provide X, Y?, Z ...</code>.
Just by appending <code class="language-plaintext highlighter-rouge">?</code> to the property, the model will often prefer to omit rather than invent outputs.</p>

<h2 id="language-efficiency">Language efficiency</h2>
<p>One other thing I observed is that English is a pretty good language for prompts. 
Usually one of the drawbacks of English is that it requires a lot of characters compared to languages like Chinese.</p>

<p>Twitter used to have a really low character limit per tweet, which was easily consumed in ‚Äúwestern‚Äù languages.
Character-based writing systems can simply fit more meaning into a single tweet.
It‚Äôs part of the reason why
<a href="https://fortune.com/2022/11/23/elon-musk-twitter-japan-users-layoffs-moderation/">Musk stated that Twitter‚Äôs ideal market isn‚Äôt the U.S.‚Äîit‚Äôs Japan</a> (behind paywall but you can sidestep with reader).
I explore some of the reasons why Japanese is more concise in <a href="/blog/2021-07-25-topic-markers-in-language-design">Language features across the boundary</a>.</p>

<p>However, what matters in prompts are tokens, not characters, and from my experience the tokenization of English is quite efficient. 
A lot of words are encoded as a single token, which means they can compete with Chinese characters. 
<a href="https://platform.openai.com/tokenizer">  <hy-img root-margin="512px"  src="/assets/img/gpt_tokenizer.png" alt="GPT Tokenizer" >    <noscript><img data-ignore  src="/assets/img/gpt_tokenizer.png" alt="GPT Tokenizer" /></noscript>    <span class="loading" slot="loading" hidden>      <span class="icon-cog"></span>    </span>  </hy-img></a></p>

<h2 id="outro">Outro</h2>

<p>The above is just a snapshot of my current ideas. Excited to see where things are at in a few months.
Currently reading <a href="https://www.goodreads.com/book/show/59616977-building-a-second-brain">Building a Second Brain by Tiago Forte</a>,
and it is amazing how much of it applies to LLMs / prompting.</p>

<blockquote>
  <p>[‚Ä¶] if you‚Äôre stuck on a task, break it down into smaller steps.</p>
</blockquote>

<p>This aligns with <a href="https://arxiv.org/abs/2201.11903">the Chain-of-Thought principle</a> for prompts.</p>

<blockquote>
  <p>As you distill your ideas, they naturally improve, because when you drop the merely good parts, the great parts can shine more brightly.</p>
</blockquote>

<p>Similar to what I wrote about distillation above.</p>

<p>Lastly, I found this example from the book very interesting:</p>

<blockquote>
  <p>Coppola‚Äôs strategy for making the complex, multifaceted film rested on a technique he learned studying theater at Hofstra College, known as a ‚Äú<strong>prompt book</strong>.‚Äù</p>

  <p>Coppola considered the prompt book that emerged from this process the most important asset in the production of his now classic film: ‚Äúthe script was really an unnecessary document; I didn‚Äôt need a script because I could have made the movie just from this notebook.‚Äù</p>
</blockquote>

<p>Basically <a href="https://en.wikipedia.org/wiki/Francis_Ford_Coppola">Coppola</a> was prompting himself with this book, which enabled him to produce The Godfather without the full script.
Sounds like he had enough training data :)</p>]]></content><author><name>Andreas Volkmann</name><email>avolkmann@me.com</email></author><category term="blog" /><summary type="html"><![CDATA[To attain knowledge, add things every day. To attain wisdom, remove things every day. (*Laozi*)]]></summary></entry><entry><title type="html">üé® DRY the paint on your Cross Cutting Concerns</title><link href="https://andreasvolkmann.github.io//blog/2023-02-12-dry-srp-caching/" rel="alternate" type="text/html" title="üé® DRY the paint on your Cross Cutting Concerns" /><published>2023-02-12T00:00:00-08:00</published><updated>2023-02-12T00:00:00-08:00</updated><id>https://andreasvolkmann.github.io//blog/dry-srp-caching</id><content type="html" xml:base="https://andreasvolkmann.github.io//blog/2023-02-12-dry-srp-caching/"><![CDATA[<ol id="markdown-toc">
  <li><a href="#scenario" id="markdown-toc-scenario">Scenario</a>    <ol>
      <li><a href="#requirements" id="markdown-toc-requirements">Requirements</a></li>
    </ol>
  </li>
  <li><a href="#techniques" id="markdown-toc-techniques">Techniques</a>    <ol>
      <li><a href="#simple-approach" id="markdown-toc-simple-approach">Simple approach</a></li>
      <li><a href="#dynamic-dispatch" id="markdown-toc-dynamic-dispatch">Dynamic dispatch</a></li>
      <li><a href="#query-pattern" id="markdown-toc-query-pattern">Query pattern</a></li>
      <li><a href="#aspect-oriented-programming-aop" id="markdown-toc-aspect-oriented-programming-aop">Aspect Oriented Programming (AOP)</a></li>
    </ol>
  </li>
  <li><a href="#conclusion" id="markdown-toc-conclusion">Conclusion</a></li>
</ol>

<p>There are many techniques of varying sophistication to achieve clean cross cutting concerns. 
Let‚Äôs walk through some of them and discuss their pros and cons.</p>

<blockquote>
  <p>This post mostly serves as a reference for myself, to gather my thoughts.
I won‚Äôt bother with implementation details and sample code may not compile.</p>
</blockquote>

<h1 id="scenario">Scenario</h1>

<p>Imagine we have a repository that fetches weather data from a database.</p>

<p>It could look similar to the below, but assume many more methods.</p>
<div class="language-csharp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">public</span> <span class="k">interface</span> <span class="nc">IWeatherRepository</span>
<span class="p">{</span>
    <span class="n">WeatherForecast</span> <span class="nf">GetForecast</span><span class="p">();</span>

    <span class="kt">int</span> <span class="nf">GetTemperature</span><span class="p">();</span>
<span class="p">}</span>
</code></pre></div></div>

<h2 id="requirements">Requirements</h2>
<p>We will evaluate the techniques based on the following requirements:</p>

<ol>
  <li>We don‚Äôt really care about the implementation, 
but we want to start applying some caching to avoid repeated database calls, 
as we have a lot of read requests coming in and the data won‚Äôt change for some time.
    <ul>
      <li>Bonus points for not needing to duplicate the caching code in each method.</li>
    </ul>
  </li>
  <li>Initially we can use a memory cache, but later we might want to switch to a distributed cache.
    <ul>
      <li>Bonus points for least amount of changes needed to switch the caching implementation.</li>
    </ul>
  </li>
  <li>We want to apply other cross-cutting concerns to the repository, like logging.
    <ul>
      <li>Bonus points for ease of extensibility and maintainability.</li>
    </ul>
  </li>
  <li>Lastly, we want to be able to test the repository without caching and logging.</li>
</ol>

<h1 id="techniques">Techniques</h1>

<h2 id="simple-approach">Simple approach</h2>
<p>Often the first approach that comes to mind is to inject a cache and add the caching logic to each of the methods.</p>

<div class="language-csharp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">public</span> <span class="k">class</span> <span class="nc">WeatherRepositoryWithCache</span> <span class="p">:</span> <span class="n">IWeatherRepository</span>
<span class="p">{</span>
    <span class="k">private</span> <span class="k">readonly</span> <span class="n">IMemoryCache</span> <span class="n">cache</span><span class="p">;</span>

    <span class="k">public</span> <span class="n">WeatherForecast</span> <span class="nf">GetForecast</span><span class="p">()</span> <span class="p">=&gt;</span> <span class="n">cache</span><span class="p">.</span><span class="nf">GetOrCreate</span><span class="p">(</span>
        <span class="k">nameof</span><span class="p">(</span><span class="n">GetForecast</span><span class="p">),</span>
        <span class="n">entry</span> <span class="p">=&gt;</span> <span class="n">Extensions</span><span class="p">.</span><span class="nf">GetDemoForecast</span><span class="p">());</span>

    <span class="k">public</span> <span class="k">virtual</span> <span class="kt">int</span> <span class="nf">GetTemperature</span><span class="p">()</span> <span class="p">=&gt;</span> <span class="n">cache</span><span class="p">.</span><span class="nf">GetOrCreate</span><span class="p">(</span>
        <span class="k">nameof</span><span class="p">(</span><span class="n">GetTemperature</span><span class="p">),</span>
        <span class="n">entry</span> <span class="p">=&gt;</span> <span class="k">new</span> <span class="nf">Random</span><span class="p">().</span><span class="nf">Next</span><span class="p">(-</span><span class="m">10</span><span class="p">,</span> <span class="m">40</span><span class="p">));</span>
<span class="p">}</span>
</code></pre></div></div>

<p>It might seem simple at first, but once you start applying this at scale,
you will quickly realize that this is not maintainable.
Think about tens of repository classes, each with tens of methods.</p>

<h2 id="dynamic-dispatch">Dynamic dispatch</h2>
<p>By overriding the methods in our repository, we can achieve separation of concerns between
the business logic and the caching.</p>

<div class="language-csharp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">public</span> <span class="k">class</span> <span class="nc">CachedWeatherRepository</span> <span class="p">:</span> <span class="n">WeatherRepository</span>
<span class="p">{</span>
    <span class="k">private</span> <span class="k">readonly</span> <span class="n">MemoryCache</span> <span class="n">cache</span><span class="p">;</span>

    <span class="k">public</span> <span class="k">override</span> <span class="n">WeatherForecast</span> <span class="nf">GetForecast</span><span class="p">()</span>
    <span class="p">{</span>
        <span class="kt">var</span> <span class="n">key</span> <span class="p">=</span> <span class="k">new</span> <span class="nf">DateOnly</span><span class="p">();</span>
        <span class="k">return</span> <span class="n">cache</span><span class="p">.</span><span class="n">GetOrCreate</span><span class="p">&lt;</span><span class="n">WeatherForecast</span><span class="p">&gt;(</span>
            <span class="n">key</span><span class="p">,</span>
            <span class="n">entry</span> <span class="p">=&gt;</span> <span class="k">base</span><span class="p">.</span><span class="nf">GetForecast</span><span class="p">());</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<p>Now we have a semi-central place for caching, although it still has to be duplicated per repository class.
We also still have to duplicate the caching logic in each method.</p>

<p>Note that this requires the methods to be virtual. We can work around this limitation with the decorator pattern.</p>

<p>Given <code class="language-plaintext highlighter-rouge">n</code> repositories, and <code class="language-plaintext highlighter-rouge">m</code> cross-cutting concerns, we would need <code class="language-plaintext highlighter-rouge">n * m</code> subclasses.
Simple code, but not maintainable.</p>

<h2 id="query-pattern">Query pattern</h2>
<p>This approach combines several patterns to achieve high flexibility.</p>

<p>The central idea is to treat any request to the database as a query object, which is passed to an executor.
Contrary to their name, these query objects actually implement the command pattern,
meaning they encapsulate a set of instructions that can be defined separately from their execution.</p>

<p>Usually, you will have some interface like this at the top level:</p>
<div class="language-csharp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">interface</span> <span class="nc">IQuery</span><span class="p">&lt;</span><span class="n">T</span><span class="p">&gt;</span>
<span class="p">{</span>
    <span class="n">T</span> <span class="nf">Execute</span><span class="p">();</span>
<span class="p">}</span>
</code></pre></div></div>

<p>Important is that these queries can be newed without any dependencies.
We can then isolate the query specification / construction by using a factory.
The concrete implementation depends on your database.</p>

<div class="language-csharp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">public</span> <span class="k">sealed</span> <span class="k">class</span> <span class="nc">QueryFactory</span>
<span class="p">{</span>
    <span class="k">public</span> <span class="n">IQuery</span><span class="p">&lt;</span><span class="n">WeatherForecast</span><span class="p">&gt;</span> <span class="nf">BuildForecastQuery</span><span class="p">()</span> <span class="p">=&gt;</span> <span class="k">new</span> <span class="nf">QueryExpression</span><span class="p">(...);</span>
    
    <span class="k">public</span> <span class="n">IQuery</span><span class="p">&lt;</span><span class="kt">int</span><span class="p">&gt;</span> <span class="nf">BuildTemperatureQuery</span><span class="p">()</span> <span class="p">=&gt;</span> <span class="k">new</span> <span class="nf">QueryExpression</span><span class="p">(...);</span>
<span class="p">}</span>
</code></pre></div></div>

<p>Using the decorator pattern, we can wrap the core query logic with additional behavior.</p>

<p>Combining this, you will end up with something like this:</p>
<div class="language-csharp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">public</span> <span class="k">class</span> <span class="nc">QueryWeatherRepository</span> <span class="p">:</span> <span class="n">IWeatherRepository</span>
<span class="p">{</span>
    <span class="k">private</span> <span class="k">readonly</span> <span class="n">QueryExecutor</span> <span class="n">queryExecutor</span><span class="p">;</span>
    <span class="k">private</span> <span class="k">readonly</span> <span class="n">QueryFactory</span> <span class="n">queryFactory</span><span class="p">;</span>
    
    <span class="k">public</span> <span class="n">WeatherForecast</span> <span class="nf">GetForecast</span><span class="p">()</span>
    <span class="p">{</span>
        <span class="kt">var</span> <span class="n">query</span> <span class="p">=</span> <span class="n">queryFactory</span><span class="p">.</span><span class="nf">BuildForecastQuery</span><span class="p">()</span>
            <span class="p">.</span><span class="nf">UseCaching</span><span class="p">()</span> <span class="c1">// extensions that leverage the decorator pattern</span>
            <span class="p">.</span><span class="nf">UseLogging</span><span class="p">();</span>
        <span class="k">return</span> <span class="n">queryExecutor</span><span class="p">.</span><span class="nf">Execute</span><span class="p">(</span><span class="n">query</span><span class="p">);</span>
    <span class="p">}</span>
</code></pre></div></div>

<p>No subclassing, no virtual methods, no need to duplicate the caching or logging logic.</p>

<p>A downside is that you have to think and come up with a setup for this.</p>

<p>Let‚Äôs check off the requirements:</p>
<ul>
  <li>No duplicated caching logic</li>
  <li>Switching caching implementation only touches a single class (caching decorator)</li>
  <li>We can add any cross-cutting concern by adding a decorator</li>
  <li>We can test the queries independently</li>
</ul>

<p>One more thing to observe is how our code becomes much more declarative and high level.
Our repository no longer dishes out specific, brittle instructions. 
Rather, we specify the behavior we would like to see and rely on the framework to execute it.</p>

<h2 id="aspect-oriented-programming-aop">Aspect Oriented Programming (AOP)</h2>
<p>Although I haven‚Äôt had a chance to try AOP in C# yet,
I am familiar with <a href="https://en.wikipedia.org/wiki/AspectJ">AspectJ</a> and <a href="/blog/2020-02-20-spring-kotlin-gradle-aop/">Spring AOP</a>.</p>

<p><a href="https://www.postsharp.net/caching">PostSharp</a> is similar to Spring, with the main downside that it is commercial.
We can add caching with a few attributes:</p>

<div class="language-csharp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">[</span><span class="nf">CacheConfiguration</span><span class="p">(</span><span class="n">AbsoluteExpiration</span> <span class="p">=</span> <span class="m">10</span><span class="p">)]</span>
<span class="k">public</span> <span class="k">sealed</span> <span class="k">class</span> <span class="nc">WeatherRepository</span> <span class="p">:</span> <span class="n">IWeatherRepository</span>
<span class="p">{</span>
    <span class="p">[</span><span class="n">Cache</span><span class="p">]</span>
    <span class="k">public</span> <span class="n">WeatherForecast</span> <span class="nf">GetForecast</span><span class="p">()</span> <span class="p">=&gt;</span> <span class="k">throw</span> <span class="nf">NotImplementedException</span><span class="p">();</span>
<span class="p">}</span>
</code></pre></div></div>

<p>This is easily the cleanest approach, requiring the least amount of code.
You can add more behavior like logging or retry simply by adding the corresponding attributes.</p>

<p>It feels like magic, which is sometimes claimed to be a bad thing.
I for one believe AOP is a true boon to software development.
One downside is the framework buy-in.</p>

<p>Even if you don‚Äôt use AOP in your daily work,
I still highly recommend learning about it on your own time.
It gives you a new perspective that will help you
identify and solve architectural problems in your code.</p>

<p>In particular, I found this course to be a great learning resource:</p>
<ul>
  <li><a href="https://www.pluralsight.com/courses/aspect-oriented-programming-spring-aspectj">Aspect Oriented Programming (AOP) using Spring AOP and AspectJ
by Eberhard Wolff</a></li>
</ul>

<h1 id="conclusion">Conclusion</h1>

<p>My personal favorite is the AOP approach, when available.
Otherwise the query pattern is a good alternative that offers a lot of flexibility.</p>

<p>The simpler patterns can be used during POC,
but any non-trivial app will benefit from a clear-defined architecture.</p>]]></content><author><name>Andreas Volkmann</name><email>avolkmann@me.com</email></author><category term="blog" /><summary type="html"><![CDATA[Techniques to achieve clean cross cutting concerns]]></summary></entry><entry><title type="html">‚ô®Ô∏è My favorite hot springs</title><link href="https://andreasvolkmann.github.io//blog/2022-10-30-onsen/" rel="alternate" type="text/html" title="‚ô®Ô∏è My favorite hot springs" /><published>2022-10-30T00:00:00-07:00</published><updated>2022-10-30T00:00:00-07:00</updated><id>https://andreasvolkmann.github.io//blog/onsen</id><content type="html" xml:base="https://andreasvolkmann.github.io//blog/2022-10-30-onsen/"><![CDATA[<ol id="markdown-toc">
  <li><a href="#yakushima" id="markdown-toc-yakushima">Yakushima</a></li>
  <li><a href="#ischia" id="markdown-toc-ischia">Ischia</a></li>
  <li><a href="#s√£o-miguel" id="markdown-toc-s√£o-miguel">S√£o Miguel</a>    <ol>
      <li><a href="#furnas" id="markdown-toc-furnas">Furnas</a></li>
    </ol>
  </li>
  <li><a href="#conclusion" id="markdown-toc-conclusion">Conclusion</a></li>
</ol>

<p>The best (and most) hot springs are, no doubt, in onsen-country, Japan ‚ô®Ô∏è.
However, there are still worthwhile alternatives in sometimes unexpected locations
that I would recommend checking out. 
So instead of covering some of the famous onsen towns of Japan, let‚Äôs talk about some of the lesser-known options.</p>

<p>In particular, I am very fond of Êµ∑‰∏≠Ê∏©Ê≥â, meaning hot springs in the ocean.
These hot springs developed naturally on the coast, which makes them quite unique.</p>

<h1 id="yakushima">Yakushima</h1>
<p>This small island south of the Japanese mainland is one of my favorite places in Japan, 
not least because of its amazing hot springs!</p>

<p>  <hy-img root-margin="512px"  src="/assets/img/yakushima.jpg" alt="Yakushima is beautiful" >    <noscript><img data-ignore  src="/assets/img/yakushima.jpg" alt="Yakushima is beautiful" /></noscript>    <span class="loading" slot="loading" hidden>      <span class="icon-cog"></span>    </span>  </hy-img></p>

<p>The <a href="https://www.town.yakushima.kagoshima.jp/cust-facility/1421/">Hirauchi Kaichuu Onsen - Âπ≥ÂÜÖÊµ∑‰∏≠Ê∏©Ê≥â</a> lies at the coast of the island and its basins
are filled with ocean water. 
It‚Äôs basically free, but you are encouraged to donate a few hundred yen to the locals maintaining it.</p>

<p>  <hy-img root-margin="512px"  src="/assets/img/onsen_hirauchi.jpg" alt="The Hirauchi hot spring" >    <noscript><img data-ignore  src="/assets/img/onsen_hirauchi.jpg" alt="The Hirauchi hot spring" /></noscript>    <span class="loading" slot="loading" hidden>      <span class="icon-cog"></span>    </span>  </hy-img></p>

<p>One of the coolest experiences is to come here in the night and enjoy the starry sky whilst taking a hot bath.
There are various temperatures to choose from in the basins, but a little caution is required as some can get very hot.</p>

<p>We were here at the end of the year and the weather was amazing.
Moderate temperature, sunny sky, tasty local produce like Ponkan, superb nature, and hot springs in the night 
made Yakushima one of my favorite destinations.</p>

<h1 id="ischia">Ischia</h1>
<p>Ischia is an island off the coast of Napoli in Italy.</p>

<p>  <hy-img root-margin="512px"  src="/assets/img/ischia.jpg" alt="Ischia is an island" >    <noscript><img data-ignore  src="/assets/img/ischia.jpg" alt="Ischia is an island" /></noscript>    <span class="loading" slot="loading" hidden>      <span class="icon-cog"></span>    </span>  </hy-img></p>

<p>It‚Äôs a popular tourist destination and unfortunately we made the mistake of coming here during the summer, 
meaning it was very crowded and our overall experience wasn‚Äôt the best.</p>

<p>Besides some negative experiences, 
what saved the trip was our discovery of a hot spring in the ocean in the island‚Äôs southern part.</p>

<p>  <hy-img root-margin="512px"  src="/assets/img/onsen_baia_di_sorgeto.jpg" alt="Baia di Sorgeto Ischia" >    <noscript><img data-ignore  src="/assets/img/onsen_baia_di_sorgeto.jpg" alt="Baia di Sorgeto Ischia" /></noscript>    <span class="loading" slot="loading" hidden>      <span class="icon-cog"></span>    </span>  </hy-img></p>

<p>Baia di Sorgeto is a little more difficult to access, but worth it every time.
We spent every evening here. As it is entirely natural, this onsen is also free.
There are a number of other (commercial) hot springs on the island, but they were all closed due to Covid.
Even so, I felt the trip was worth it because Baia di Sorgeto was outstanding.</p>

<h1 id="s√£o-miguel">S√£o Miguel</h1>
<p>In the middle of the atlantic ocean lie the Azores, a group of Portugese islands, the biggest of which is S√£o Miguel.</p>

<p>  <hy-img root-margin="512px"  src="/assets/img/sao_miguel.jpg" alt="S√£o Miguel" >    <noscript><img data-ignore  src="/assets/img/sao_miguel.jpg" alt="S√£o Miguel" /></noscript>    <span class="loading" slot="loading" hidden>      <span class="icon-cog"></span>    </span>  </hy-img></p>

<p>I decided to visit because of the many similarities to Japan / Yakushima: 
A volcanic island with lush, green vegetation, warm but rainy weather, tea plantations, and of course hot springs ‚ô®Ô∏è.</p>

<p>It‚Äôs a bit difficult to get here, as there aren‚Äôt many international flights, 
so the most likely route is via Portugal‚Äôs mainland.</p>

<p>Anyway it‚Äôs worth the effort, as this island has so much to offer.</p>

<p>Caldeira Velha is like a little trip through the jungle, with hot springs along the way. 
Although there is only one smaller basin with really hot water, it‚Äôs a very atmospheric and relaxing journey.
  <hy-img root-margin="512px"  src="/assets/img/onsen_caldeiravelha.jpg" alt="Caldeira Velha" >    <noscript><img data-ignore  src="/assets/img/onsen_caldeiravelha.jpg" alt="Caldeira Velha" /></noscript>    <span class="loading" slot="loading" hidden>      <span class="icon-cog"></span>    </span>  </hy-img></p>

<hr />

<p>Then there is Termas das Caldeiras, a smaller hot spring bath. 
We put this one off because it seemed too small from the reviews.
In the end we did have an opportunity to try it, and it became one of our favorite experiences.
The pools are small but we were lucky that there were few people and at some point we were even alone.
Later on someone performed a few songs on a handpan.
This was the best meditative atmosphere in any hot spring here.
This place also has probably the hottest pool available.</p>

<hr />

<p>There is also an onsen in the sea, but we had no luck with the tide, so the water wasn‚Äôt warm enough.
  <hy-img root-margin="512px"  src="/assets/img/onsen_ponta_ferraria.jpg" alt="Ponta Ferraria" >    <noscript><img data-ignore  src="/assets/img/onsen_ponta_ferraria.jpg" alt="Ponta Ferraria" /></noscript>    <span class="loading" slot="loading" hidden>      <span class="icon-cog"></span>    </span>  </hy-img>
This hot spring goes by the name Ponta Ferraria, but it‚Äôs a little further away from everything so we didn‚Äôt try again.</p>

<h2 id="furnas">Furnas</h2>
<p>Then there is the little onsen town Furnas. I recommend staying here to maximize your time in the hot springs.
Furnas is quite popular among locals and tourists, so expect a lot of traffic. 
Therefore, it‚Äôs better to be close by and flexible so that you can time your visits and spend extended time 
in the hot springs without having to worry about getting back home.</p>

<p>First up, the Po√ßa da Dona Beija, which consists of several medium-size pools of depth.
Definitely check it out, but be aware that it gets busy towards the evening.</p>

<hr />

<p>The main attraction is Parque Terra Nostra, which is a botanical garden with several hot spring baths included.
One of these is actually a gigantic pool in which you can swim freely.</p>

<p>  <hy-img root-margin="512px"  src="/assets/img/onsen_terra_nostra.jpg" alt="Terra Nostra" >    <noscript><img data-ignore  src="/assets/img/onsen_terra_nostra.jpg" alt="Terra Nostra" /></noscript>    <span class="loading" slot="loading" hidden>      <span class="icon-cog"></span>    </span>  </hy-img></p>

<p>The park itself is well worth seeing, but that onsen pool is truly a rare sight to behold! 
It‚Äôs extremely satisfying to swim in the thermal water and you can find temperature differences throughout the pool.</p>

<hr />

<p>Outside Japan, hot spring temperatures are usually lower and you rarely encounter foot-onsens, 
i.e. hot springs which you put your feet into.
Furnas actually has one of those! It‚Äôs called Po√ßa da Tia Silvina, and it‚Äôs exceptionally hot.
This foot onsen it located on the river bank in Furnas and is free. 
Recommend to grab some desserts from the Gl√≥ria Moniz bakery and come down here to relax.
Might have to bring an umbrella :)</p>

<p>Lastly, they also make food with the thermal heat, which results in a dish called Cozido das Furnas. 
This is definitely worth trying! Amazing to see the many use cases thermal heat can fit into.</p>

<h1 id="conclusion">Conclusion</h1>
<p>Hot springs are amazing and I wish they could be found anywhere. 
In recent years I found a few hot springs that can make up for their general absence throughout Europe.
I hope to visit many more in other parts of the world.</p>]]></content><author><name>Andreas Volkmann</name><email>avolkmann@me.com</email></author><category term="blog" /><summary type="html"><![CDATA[Explore these fascinating hot springs around the globe.]]></summary></entry><entry><title type="html">Dataverse Performance - Flow Iteration</title><link href="https://andreasvolkmann.github.io//blog/2022-04-09-dataverse-perf-flow-loops/" rel="alternate" type="text/html" title="Dataverse Performance - Flow Iteration" /><published>2022-04-09T00:00:00-07:00</published><updated>2022-04-09T00:00:00-07:00</updated><id>https://andreasvolkmann.github.io//blog/dataverse-perf-flow-loops</id><content type="html" xml:base="https://andreasvolkmann.github.io//blog/2022-04-09-dataverse-perf-flow-loops/"><![CDATA[<ol id="markdown-toc">
  <li><a href="#control" id="markdown-toc-control">Control</a></li>
  <li><a href="#data-operations" id="markdown-toc-data-operations">Data Operations</a>    <ol>
      <li><a href="#select" id="markdown-toc-select">Select</a></li>
      <li><a href="#filter" id="markdown-toc-filter">Filter</a></li>
      <li><a href="#change-of-approach" id="markdown-toc-change-of-approach">Change of approach</a></li>
    </ol>
  </li>
  <li><a href="#conclusion" id="markdown-toc-conclusion">Conclusion</a></li>
</ol>

<p>Flows are a great tool for automation and integration,
but whilst the low/no code paradigm aims to make programming more accessible,
it also introduces some pitfalls that are not immediately obvious to both casual and professional programmers.</p>

<p>Performance is a frequently problematic area,
as the restricted Flow development environment makes it hard to see why things are slow
and doesn‚Äôt provide many options to address the issues.</p>

<h1 id="control">Control</h1>
<p>One issue I‚Äôve seen come up again and again in Flows is the use of imperative iteration.
  <hy-img root-margin="512px"  src="/assets/img/flow-control.png" alt="Flow control" >    <noscript><img data-ignore  src="/assets/img/flow-control.png" alt="Flow control" /></noscript>    <span class="loading" slot="loading" hidden>      <span class="icon-cog"></span>    </span>  </hy-img></p>

<p>In other words, the two control actions <code class="language-plaintext highlighter-rouge">Apply to each</code> and <code class="language-plaintext highlighter-rouge">Do until</code>.
At first glance, they seem like the go-to actions for looping.</p>

<p>Turns out you are better off avoiding them unless absolutely necessary, seeing as the performance is abyssmal.
Consider this simple, bare-bones <code class="language-plaintext highlighter-rouge">Do until</code>, with a single action to increment an integer inside:
  <hy-img root-margin="512px"  src="/assets/img/flow-loop-slow.png" alt="Flow loops are slow" >    <noscript><img data-ignore  src="/assets/img/flow-loop-slow.png" alt="Flow loops are slow" /></noscript>    <span class="loading" slot="loading" hidden>      <span class="icon-cog"></span>    </span>  </hy-img></p>

<p>60 iterations took 12 seconds!
This is completely unexpected for someone coming from traditional programming.</p>

<p>When using these control actions, what you‚Äôd likely expect to happen behind the scenes is something like the following:</p>
<div class="language-kotlin highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">while</span> <span class="p">(</span><span class="n">i</span> <span class="p">&lt;</span> <span class="mi">60</span><span class="p">)</span> <span class="p">{</span>
  <span class="n">i</span><span class="p">++</span>
<span class="p">}</span>
</code></pre></div></div>

<p>This should take mere nanoseconds, so how come it took 12 whole seconds in the Flow?</p>

<p>There is significant overhead associated with each iteration, leading to long durations and potential timeouts.
Unlike a traditional while or for loop, the control actions spawn a sub process for each iteration.</p>

<p>Now imagine running this with 1000s of iterations. You can freeze your whole system if you‚Äôre not careful here.</p>

<p>As you can see, simple loops are very counter-intuitive in Flows.
In order to rectify the situation, oftentimes the concurrency is upped.
This does lead to faster execution, but increases the load on the system and can impact quota usage.
  <hy-img root-margin="512px"  src="/assets/img/flow-concurrency.png" alt="Flow concurrency maxed out" >    <noscript><img data-ignore  src="/assets/img/flow-concurrency.png" alt="Flow concurrency maxed out" /></noscript>    <span class="loading" slot="loading" hidden>      <span class="icon-cog"></span>    </span>  </hy-img>
Besides, you‚Äôll hit the max eventually.</p>

<p>Surely, there‚Äôs gotta be a better way, right? After all, loops are such a fundamental part of any program.</p>

<h1 id="data-operations">Data Operations</h1>
<p>The antidote to the <code class="language-plaintext highlighter-rouge">Control loop</code> slowness comes in the form of <code class="language-plaintext highlighter-rouge">Data operations</code>.</p>

<p>  <hy-img root-margin="512px"  src="/assets/img/flow-data-operations.png" alt="Flow data operations are fast" >    <noscript><img data-ignore  src="/assets/img/flow-data-operations.png" alt="Flow data operations are fast" /></noscript>    <span class="loading" slot="loading" hidden>      <span class="icon-cog"></span>    </span>  </hy-img></p>

<p>Data operations are to control loops as imperative programming is to declarative.
They are basically higher order functions.</p>

<p>Let‚Äôs see some quick examples as proof of their speed.</p>

<h2 id="select">Select</h2>
<p>One example could be the transformation of a set of row objects to an array of their ids.
  <hy-img root-margin="512px"  src="/assets/img/flow-loop.png" alt="Flow loop" >    <noscript><img data-ignore  src="/assets/img/flow-loop.png" alt="Flow loop" /></noscript>    <span class="loading" slot="loading" hidden>      <span class="icon-cog"></span>    </span>  </hy-img>
The imperative <code class="language-plaintext highlighter-rouge">Apply to each</code> loop takes ~3 minutes for 300 records,
even though the individual append operation takes less than a second.
The functional <code class="language-plaintext highlighter-rouge">Select</code> operation completes within 1 second.</p>

<h2 id="filter">Filter</h2>
<p>Looping over 100 items, even without any logic in the condition, takes a significant amount of time.
  <hy-img root-margin="512px"  src="/assets/img/flow-filter.png" alt="Flow filter" >    <noscript><img data-ignore  src="/assets/img/flow-filter.png" alt="Flow filter" /></noscript>    <span class="loading" slot="loading" hidden>      <span class="icon-cog"></span>    </span>  </hy-img></p>

<p>The functional <code class="language-plaintext highlighter-rouge">Filter array</code> operation completes in less than a second, as we would expect from such a workload.</p>

<hr />

<p>As we can see, data operations have the performance characteristics
which we originally expected to see form the imperative approach.</p>

<p>There is hardly ever a reason not to use them, as long as the functional outcome is the same.
One area that cannot be covered is the integration with external systems. 
Making a call to a system that expects a single data record cannot be optimized.</p>

<p>If you own the API, you can attempt a batch approach instead of one-by-one calls,
and parse the data with data operations.</p>

<h2 id="change-of-approach">Change of approach</h2>
<p>As with the transition from imperative to functional,
a different mindset is often required to effectively utilize data operations.</p>

<p>I encourage you to leave complex control structures and mutation behind,
and instead focus on pure, higher-order functions processing collections rather than single records.</p>

<p>The best way to learn is to take up languages that naturally promote functional concepts. 
Although most mainstream languages support higher order functions by now,
I personally learned a lot from diving into Kotlin,
which I believe is the perfect bridge between imperative OO and functional.</p>

<h1 id="conclusion">Conclusion</h1>
<p>As a general guideline:
Avoid looping over arrays of even medium size (100s).
Prefer data operations like <code class="language-plaintext highlighter-rouge">Select</code>, <code class="language-plaintext highlighter-rouge">Compose</code>, <code class="language-plaintext highlighter-rouge">Join</code>, <code class="language-plaintext highlighter-rouge">Filter</code> to manipulate and transform multiple records at once.
(Analogous to functional &gt; imperative in OO)</p>

<p>Reserve the control loops for situations where data operations cannot be used.</p>]]></content><author><name>Andreas Volkmann</name><email>avolkmann@me.com</email></author><category term="blog" /><summary type="html"><![CDATA[Addressing common performance bottlenecks in Flows. There is more to loops than meets the eye. Once again, functional beats imperative.]]></summary></entry><entry><title type="html">Language features across the boundary</title><link href="https://andreasvolkmann.github.io//blog/2021-07-25-topic-markers-in-language-design/" rel="alternate" type="text/html" title="Language features across the boundary" /><published>2021-07-25T00:00:00-07:00</published><updated>2021-07-25T00:00:00-07:00</updated><id>https://andreasvolkmann.github.io//blog/topic-markers-in-language-design</id><content type="html" xml:base="https://andreasvolkmann.github.io//blog/2021-07-25-topic-markers-in-language-design/"><![CDATA[<ol id="markdown-toc">
  <li><a href="#topic-markers" id="markdown-toc-topic-markers">Topic markers</a>    <ol>
      <li><a href="#implicit-topics" id="markdown-toc-implicit-topics">Implicit topics</a></li>
    </ol>
  </li>
  <li><a href="#programming-analog" id="markdown-toc-programming-analog">Programming analog</a>    <ol>
      <li><a href="#extension-functions-with-receivers" id="markdown-toc-extension-functions-with-receivers">Extension functions with receivers</a>        <ol>
          <li><a href="#further-parallels" id="markdown-toc-further-parallels">Further parallels</a></li>
        </ol>
      </li>
    </ol>
  </li>
  <li><a href="#conclusion" id="markdown-toc-conclusion">Conclusion</a></li>
</ol>

<p>In western languages we are used to repeatedly re-declare the topic we are talking about.
There is hardly a sentence without a pronoun,
and we often have to find <a href="https://owl.purdue.edu/owl/general_writing/academic_writing/sentence_variety/for_repeated_subjects_or_topics.html">creative ways</a>
to reduce repetition, in order not to sound dry and robotic.</p>

<p>Imagine a typical conversation between person <code class="language-plaintext highlighter-rouge">A</code> and <code class="language-plaintext highlighter-rouge">B</code>:</p>
<div class="language-yml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="na">A</span><span class="pi">:</span> <span class="s">How is your new teacher?</span>
<span class="na">B</span><span class="pi">:</span> <span class="s">I don't like him. He's too strict.</span>
<span class="na">A</span><span class="pi">:</span> <span class="s">Is he worse than Mr. X?</span>
<span class="na">B</span><span class="pi">:</span> <span class="s">No, but he still thinks it's the 80s.</span>
<span class="nn">...</span>
</code></pre></div></div>

<p>This could go on for quite a bit,
but after the first sentence it should be clear to everyone what the topic is.
Then why do we have to repeatedly refer to it?</p>

<p>Think about introducing yourself to an audience.
Nobody is in doubt who you are talking about, 
yet practically every sentence will contain an <code class="language-plaintext highlighter-rouge">I</code> or <code class="language-plaintext highlighter-rouge">my</code>.</p>

<p>Growing up with such a language, this feels normal. 
Although, as developers, we tend to get an allergic reaction when seeing excessive repetition.</p>

<p>Once we discover an elegant alternative, 
we realize that languages like English, German, Danish are really quite verbose. 
They are said to be <a href="https://en.wikipedia.org/wiki/Topic-prominent_language">subject-prominent</a>.</p>

<h1 id="topic-markers">Topic markers</h1>

<p>Some natural languages, like Japanese and Korean, support a feature called <a href="https://en.wikipedia.org/wiki/Topic_marker">topic markers</a>.
They allow you to declare a topic, and then largely omit referencing it throughout the conversation.</p>

<p>Going back to the previous example, once the topic is established, we can stop referring to it.</p>
<div class="language-yml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="na">A</span><span class="pi">:</span> <span class="s">How is new teacher?</span>
<span class="na">B</span><span class="pi">:</span> <span class="s">Don't like. Too strict.</span>
<span class="na">A</span><span class="pi">:</span> <span class="s">Worse than Mr. X?</span>
<span class="na">B</span><span class="pi">:</span> <span class="s">No, but still thinks it's the 80s.</span>
<span class="nn">...</span>
</code></pre></div></div>

<p>This sounds unnatural in English, but is the default in Japanese.
In fact, we can omit nearly all pronouns, as they are usually inferred from the context:</p>
<ul>
  <li>When <code class="language-plaintext highlighter-rouge">A</code> asks <code class="language-plaintext highlighter-rouge">B</code> a question, <code class="language-plaintext highlighter-rouge">B</code> is not in doubt whose teacher <code class="language-plaintext highlighter-rouge">A</code> is talking about.</li>
  <li>When <code class="language-plaintext highlighter-rouge">B</code> states her opinion, both know who about.</li>
  <li>As long as the topic doesn‚Äôt change, there is no need to refer to the teacher with pronouns.</li>
</ul>

<h2 id="implicit-topics">Implicit topics</h2>
<p>Context-heavy languages assume a lot of implicit information, allowing for very succinct communication.
Japanese is known for being on the extreme end of the context-heavy scala, 
as almost every sentence will omit some information.</p>

<blockquote>
  <p>In high context cultures many of the words you might think of as essential in another linguistic setting become unnecessary or out of place. Japanese is one such language, where things are often implied by context and mutual understanding.</p>

  <p><a href="https://www.italki.com/article/877/omitting-the-subject-in-japanese?hl=en">Source</a></p>
</blockquote>

<p><a href="https://en.wikipedia.org/wiki/Japanese_grammar#Thematic_wa">A classic</a> 
is the sentence <code class="language-plaintext highlighter-rouge">ÂÉï„ÅØ„Ç¶„Éä„ÇÆ„Å†</code>, which can be interpreted as <code class="language-plaintext highlighter-rouge">I am an eel</code>, which doesn‚Äôt make much sense.
The implicit context is that we are in a restaurant, where the sentence is used to state your order, 
as in <code class="language-plaintext highlighter-rouge">I'd like the eel, please</code>.</p>

<p>More generally, you omit pronouns in most conversations.
When talking about yourself, stating your thoughts, or telling a story about your kids, you won‚Äôt have to 
 say <code class="language-plaintext highlighter-rouge">I</code> / <code class="language-plaintext highlighter-rouge">my</code>. Once you open your mouth, it is clear that you are the topic.
When seeing a colleague and asking a question, you won‚Äôt say <code class="language-plaintext highlighter-rouge">You</code>. 
The other person understands that he is the one being asked.</p>

<p>Once I went to a book store, where a band was playing. 
Just as I entered, they stopped playing, 
and I went up to one of the members to ask whether they would continue later.
The entire conversation was:</p>
<div class="language-yml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="na">Me</span><span class="pi">:</span> <span class="s">„ÇÇ„ÅÜÁµÇ„Çè„Å£„ÅüÔºü</span> <span class="c1"># ~ Already finished?</span>
<span class="na">He</span><span class="pi">:</span> <span class="s">„Åæ„Å†„ÄÇ</span>       <span class="c1"># ~ Still.</span>
</code></pre></div></div>

<p>I was taken aback by the curtness of his answer, but this is really quite common.</p>

<h1 id="programming-analog">Programming analog</h1>

<p>The first similar concept that comes to mind is a plain class, 
from which we can reference other members of the class without qualification.</p>

<p>As mentioned, in Japanese you can omit declaring yourself as the topic.
Let‚Äôs imagine a class about ourselves, called <code class="language-plaintext highlighter-rouge">I</code>.</p>

<div class="language-kotlin highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">class</span> <span class="nc">I</span> <span class="p">{</span>
    <span class="k">private</span> <span class="k">fun</span> <span class="nf">think</span><span class="p">(</span><span class="n">about</span><span class="p">:</span> <span class="nc">String</span><span class="p">)</span> <span class="p">{}</span>
    
    <span class="k">fun</span> <span class="nf">say</span><span class="p">()</span> <span class="p">{</span>
        <span class="nf">think</span><span class="p">(</span><span class="s">"No more subject!"</span><span class="p">)</span>
        <span class="nf">think</span><span class="p">(</span><span class="s">"Context is awesome!"</span><span class="p">)</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<p>As opposed to:</p>
<div class="language-kotlin highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">val</span> <span class="py">i</span> <span class="p">=</span> <span class="nc">I</span><span class="p">()</span>

<span class="k">fun</span> <span class="nf">say</span><span class="p">()</span> <span class="p">{</span>
    <span class="n">i</span><span class="p">.</span><span class="nf">think</span><span class="p">(</span><span class="s">"therefore I am"</span><span class="p">)</span>
    <span class="n">i</span><span class="p">.</span><span class="nf">think</span><span class="p">(</span><span class="s">"repetition is boring"</span><span class="p">)</span>
<span class="p">}</span>
</code></pre></div></div>

<p>Generally, good design will produce classes with low subject repetition.
Similar to how we organize our prose to minimize repetition and keep the reader engaged. 
If we find ourselves frequently referring to the same subject, 
then that is a sign that the code belongs in a (topic) class.</p>

<p>This works well when we own the class, but what if the topic is out of our control?</p>

<h2 id="extension-functions-with-receivers">Extension functions with receivers</h2>

<p>Have you ever had to write a function which operates on an external type, like the below?</p>
<div class="language-kotlin highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">fun</span> <span class="nf">mutate</span><span class="p">(</span><span class="k">external</span><span class="p">:</span> <span class="nc">External</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">external</span><span class="p">.</span><span class="n">name</span> <span class="p">=</span> <span class="s">"Test"</span>
    <span class="k">external</span><span class="p">.</span><span class="n">age</span> <span class="p">=</span> <span class="mi">10_000</span>
    <span class="k">external</span><span class="p">.</span><span class="n">location</span> <span class="p">=</span> <span class="nf">getCurrentLocation</span><span class="p">()</span>
    <span class="k">external</span><span class="p">.</span><span class="n">status</span> <span class="p">=</span> <span class="o">..</span><span class="p">.</span>
    <span class="k">external</span><span class="p">.</span><span class="n">yetAnotherField</span> <span class="p">=</span> <span class="o">..</span><span class="p">.</span> 
    <span class="c1">/// 10 more fields to set</span>
<span class="p">}</span>
</code></pre></div></div>
<p>This is super annoying. We basically want a way to declare <code class="language-plaintext highlighter-rouge">external</code> as our topic, 
and then stop referring to it in every single line, as if it was a function of the class itself.</p>

<p>In Kotlin, <a href="https://kotlinlang.org/docs/extensions.html#extension-functions">extension functions</a> 
are declared by defining a receiver type for the function.
Within its scope, the receiver becomes <code class="language-plaintext highlighter-rouge">this</code>, and can be omitted.</p>

<div class="language-kotlin highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">fun</span> <span class="nc">External</span><span class="p">.</span><span class="nf">mutate</span><span class="p">()</span> <span class="p">{</span>
    <span class="n">name</span> <span class="p">=</span> <span class="s">"Test"</span>
    <span class="n">age</span> <span class="p">=</span> <span class="mi">10_000</span>
    <span class="n">location</span> <span class="p">=</span> <span class="nf">getCurrentLocation</span><span class="p">()</span>
    <span class="n">status</span> <span class="p">=</span> <span class="o">..</span><span class="p">.</span>
    <span class="o">..</span><span class="p">.</span>
<span class="p">}</span>
</code></pre></div></div>

<p>Such receivers can be thought of as topic markers, 
indicating that the following block of code will invoke the topic without explicitly referencing it.</p>

<p>The standard library contains generic helper functions, like <code class="language-plaintext highlighter-rouge">apply</code> to facilitate this inline.</p>

<div class="language-kotlin highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nc">StringBuilder</span><span class="p">().</span><span class="nf">apply</span> <span class="p">{</span>
    <span class="nf">append</span><span class="p">(</span><span class="s">"Hello "</span><span class="p">)</span>
    <span class="n">names</span><span class="p">.</span><span class="nf">forEach</span> <span class="p">{</span> <span class="nf">append</span><span class="p">(</span><span class="n">it</span><span class="p">).</span><span class="nf">append</span><span class="p">(</span><span class="s">","</span><span class="p">)</span> <span class="p">}</span>
    <span class="nf">setLength</span><span class="p">(</span><span class="n">length</span> <span class="p">-</span> <span class="mi">1</span><span class="p">)</span>
    <span class="nf">append</span><span class="p">(</span><span class="s">"!"</span><span class="p">)</span>
<span class="p">}.</span><span class="nf">toString</span><span class="p">()</span> <span class="c1">// Hello A, B!</span>
</code></pre></div></div>

<p>Without <code class="language-plaintext highlighter-rouge">apply</code>, we would have to declare the subject in every line, sometimes even twice.
We could actually create a similar helper for the Japanese topic marker <code class="language-plaintext highlighter-rouge">„ÅØ</code>:</p>
<div class="language-kotlin highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">infix</span> <span class="k">fun</span> <span class="p">&lt;</span><span class="nc">T</span><span class="p">&gt;</span> <span class="nc">T</span><span class="p">.</span><span class="err">„ÅØ(</span><span class="nf">block</span><span class="p">:</span> <span class="nc">T</span><span class="p">.()</span> <span class="p">-&gt;</span> <span class="nc">Unit</span><span class="p">)</span> <span class="p">=</span> <span class="nf">block</span><span class="p">()</span>

<span class="nc">RestaurantOrder</span><span class="p">()</span> <span class="err">„ÅØ</span> <span class="p">{</span> <span class="nf">unagi</span><span class="p">()</span> <span class="p">}</span>
</code></pre></div></div>

<p>Receivers are frequently leveraged to enable custom DSLs / <a href="https://kotlinlang.org/docs/type-safe-builders.html">type-safe builders</a>. 
For example, a type-safe way to build html in code:</p>
<div class="language-kotlin highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nf">html</span> <span class="p">{</span>
    <span class="nf">header</span> <span class="p">{</span>
        <span class="nf">stylesheet</span><span class="p">(</span><span class="n">color</span> <span class="p">=</span> <span class="s">"blue"</span><span class="p">)</span>
    <span class="p">}</span>
    <span class="nf">body</span> <span class="p">{</span>
        <span class="nf">form</span> <span class="p">{</span>
            <span class="nf">textColumn</span><span class="p">(</span><span class="s">"name"</span><span class="p">)</span>
        <span class="p">}</span>
        <span class="nf">button</span><span class="p">(</span><span class="s">"OK"</span><span class="p">)</span>
    <span class="p">}</span>
    <span class="nf">footer</span><span class="p">()</span>
<span class="p">}</span>
</code></pre></div></div>

<p>Another cool thing here is the notion of nested receivers / topics, just as in natural language.
The <code class="language-plaintext highlighter-rouge">textColumn</code> only makes sense in the context of a form in a body in html.</p>

<p>Going back to the eel example, how could we express this in code?
First, we can always assume an implicit context of <code class="language-plaintext highlighter-rouge">I</code>.
Next, we are in a restaurant and, facing the waiter, it is clear that we intend to order food.</p>

<div class="language-kotlin highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">class</span> <span class="nc">I</span> <span class="p">{</span>
    <span class="k">fun</span> <span class="nc">RestaurantOrder</span><span class="p">.</span><span class="nf">unagi</span><span class="p">()</span> <span class="p">=</span> <span class="nf">order</span><span class="p">(</span><span class="nc">Menu</span><span class="p">.</span><span class="nc">EelOnRice</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
<span class="p">}</span>

<span class="nc">I</span> <span class="p">{</span> <span class="c1">// implicit I</span>
    <span class="nf">restaurant</span> <span class="p">{</span> <span class="c1">// when in restaurant</span>
        <span class="nf">order</span> <span class="p">{</span> <span class="c1">// when about to order</span>
            <span class="nf">unagi</span><span class="p">()</span> <span class="c1">// when in the right context, a single word is sufficient</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>
<p>Notice that we can define <a href="https://kotlinlang.org/docs/extensions.html#declaring-extensions-as-members">local extensions</a>! 
This really allows us to express the concept of sub-topics, 
i.e. the unagi restaurant order only applies to me.</p>

<h3 id="further-parallels">Further parallels</h3>
<p>In Japanese, adding back the omitted subject references still leads to grammatically correct sentences,
but they will be perceived as awkward, and you will have trouble making yourself understood.
This is analogous to unclean code with excessive duplication, or unnecessary qualifications.
For others reading your code, this noise is an impairment to understanding your true intent.</p>

<h1 id="conclusion">Conclusion</h1>
<p>In programming, topics are generally handled by defining classes of cohesive members, 
which can operate on the topic without explicit references. 
Kotlin adds the magic by allowing the same behavior on external types via extensions.
Bonus points for local extensions!</p>

<p>Natural languages like Japanese have a special topic marker particle 
which feels similar to defining the receiver on an extension function.
In context-heavy languages we can omit a lot of implicit information, 
often leading to much shorter, concise sentences.</p>

<p>To me, both Kotlin and Japanese have a sense of elegance, 
as it is super easy to produce highly expressive and concise output.</p>]]></content><author><name>Andreas Volkmann</name><email>avolkmann@me.com</email></author><category term="blog" /><summary type="html"><![CDATA[Topic markers and context can help keep you DRY]]></summary></entry><entry><title type="html">Clean Architecture with ArchUnit</title><link href="https://andreasvolkmann.github.io//blog/2021-04-24-clean-arch-unit/" rel="alternate" type="text/html" title="Clean Architecture with ArchUnit" /><published>2021-04-24T00:00:00-07:00</published><updated>2021-04-24T00:00:00-07:00</updated><id>https://andreasvolkmann.github.io//blog/clean-arch-unit</id><content type="html" xml:base="https://andreasvolkmann.github.io//blog/2021-04-24-clean-arch-unit/"><![CDATA[<ol id="markdown-toc">
  <li><a href="#setup" id="markdown-toc-setup">Setup</a></li>
  <li><a href="#rules" id="markdown-toc-rules">Rules</a></li>
  <li><a href="#conclusion" id="markdown-toc-conclusion">Conclusion</a></li>
</ol>

<p>In a <a href="/blog/2020-02-20-spring-kotlin-gradle-aop">previous post</a>
I discussed ways in which AOP can help in defining our architecture, 
even allowing us to verify architectural rules at compile time.</p>

<p>While this approach certainly does work, it has a few drawbacks, like its reliance on 
AOP, which is not always an option. 
Furthermore, the way these rules are defined is slightly unnatural.</p>

<p>A more idiomatic way of automatically verifying one‚Äôs architecture is <a href="https://www.archunit.org/">ArchUnit</a>,
which enables us to define our rules as unit tests.</p>

<p>Originally a Java library, the project has since been ported to C#, 
which makes sense, considering <s>Java</s> Kotlin and C# are the same language.
If a truly useful library is created in either of these, 
it will eventually be ported to the others, 
just like for <a href="https://en.wikipedia.org/wiki/AspectJ">AspectJ</a> we now got <a href="https://www.postsharp.net/">PostSharp</a>.</p>

<p>Anyway, this is convenient for me, 
since I wanted to take a look at enforcing a clean architecture in C# today. 
(Please read <a href="https://blog.cleancoder.com/uncle-bob/2012/08/13/the-clean-architecture.html">Uncle Bob‚Äôs post</a>)
<a href="https://blog.cleancoder.com/uncle-bob/2012/08/13/the-clean-architecture.html">  <hy-img root-margin="512px"  src="/assets/img/CleanArchitecture.jpg" alt="Overview of the Clean Architecture" >    <noscript><img data-ignore  src="/assets/img/CleanArchitecture.jpg" alt="Overview of the Clean Architecture" /></noscript>    <span class="loading" slot="loading" hidden>      <span class="icon-cog"></span>    </span>  </hy-img></a></p>

<p>In the Java ArchUnit, there is out of the box support for both <code class="language-plaintext highlighter-rouge">layered</code> and <code class="language-plaintext highlighter-rouge">onion</code> architectures, 
but not in the dotnet ports.</p>

<p>I won‚Äôt be going for a full-blown onion / clean arch as my purpose is to slowly evolve 
and improve the architecture of my project. Taking things from 0 to 100 in one step is 
likely not gonna benefit anyone, and it is easier to adapt to small, incremental changes.
So, while the end goal is a clean architecture, 
for now I just want to implement some simple layer checks, 
similar to the ones shown in the image below.</p>

<p>  <hy-img root-margin="512px"  src="/assets/img/layer-check.png" alt="Overview of the Clean Architecture" >    <noscript><img data-ignore  src="/assets/img/layer-check.png" alt="Overview of the Clean Architecture" /></noscript>    <span class="loading" slot="loading" hidden>      <span class="icon-cog"></span>    </span>  </hy-img></p>

<h2 id="setup">Setup</h2>

<p>I found two candidates for ArchUnit-style tests:</p>
<ul>
  <li><a href="https://github.com/TNG/ArchUnitNET">ArchUnitNET</a></li>
  <li><a href="https://github.com/BenMorris/NetArchTest">NetArchTest</a></li>
</ul>

<p>I decided to go with the former, as it is from TNG, the same team as the original library.</p>

<p>After installing, I noticed there is no assert support for <code class="language-plaintext highlighter-rouge">MSTest</code>, 
so I recommend to just copy the related classes from <a href="https://github.com/TNG/ArchUnitNET/tree/master/ArchUnitNET.xUnit">the xUnit folder</a>.</p>

<p><a href="https://github.com/AndreasVolkmann/archNet/tree/master/TestProject1/Arch">Here</a> is what I ended up with.</p>

<h2 id="rules">Rules</h2>

<p>The individual layers can be defined like this:</p>
<div class="language-c# highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kt">var</span> <span class="n">serviceLayer</span>     <span class="p">=</span> <span class="nf">Types</span><span class="p">().</span><span class="nf">That</span><span class="p">().</span><span class="nf">ResideInNamespace</span><span class="p">(</span><span class="s">".Service"</span><span class="p">);</span>
<span class="kt">var</span> <span class="n">controllerLayer</span>  <span class="p">=</span> <span class="nf">Types</span><span class="p">().</span><span class="nf">That</span><span class="p">().</span><span class="nf">ResideInNamespace</span><span class="p">(</span><span class="s">".Controller"</span><span class="p">);</span>
<span class="kt">var</span> <span class="n">peristenceLayer</span>  <span class="p">=</span> <span class="nf">Types</span><span class="p">().</span><span class="nf">That</span><span class="p">().</span><span class="nf">ResideInNamespace</span><span class="p">(</span><span class="s">".Repository"</span><span class="p">);</span>
</code></pre></div></div>

<p>Let‚Äôs start with our first rule: 
None of our code should depend on any controller / inbound port.</p>

<div class="language-c# highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">[</span><span class="n">TestMethod</span><span class="p">]</span>
<span class="k">public</span> <span class="k">void</span> <span class="nf">LayeredArch_Controller</span><span class="p">()</span>
<span class="p">{</span>
    <span class="kt">var</span> <span class="n">rule</span> <span class="p">=</span> <span class="nf">Types</span><span class="p">().</span><span class="nf">That</span><span class="p">().</span><span class="nf">AreNot</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="n">controllerLayer</span><span class="p">)</span>
        <span class="p">.</span><span class="nf">Should</span><span class="p">().</span><span class="nf">NotDependOnAny</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="n">controllerLayer</span><span class="p">);</span>

    <span class="n">rule</span><span class="p">.</span><span class="nf">Check</span><span class="p">(</span><span class="n">Architecture</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div></div>

<p>The next rule prevents access from the persistence layer to the service layer.</p>
<div class="language-c# highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nf">Types</span><span class="p">().</span><span class="nf">That</span><span class="p">().</span><span class="nf">Are</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="n">peristenceLayer</span><span class="p">)</span>
    <span class="p">.</span><span class="nf">Should</span><span class="p">().</span><span class="nf">NotDependOnAny</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="n">serviceLayer</span><span class="p">);</span>
</code></pre></div></div>

<p>And lastly, only allow the service layer to access the persistence layer.</p>
<div class="language-c# highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nf">Types</span><span class="p">().</span><span class="nf">That</span><span class="p">().</span><span class="nf">AreNot</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="n">serviceLayer</span><span class="p">)</span>
    <span class="p">.</span><span class="nf">Should</span><span class="p">().</span><span class="nf">NotDependOnAny</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="n">peristenceLayer</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div></div>

<p>The complete test class is available <a href="https://github.com/AndreasVolkmann/archNet/blob/master/TestProject1/Arch/ArchitectureTests.cs">here</a>.</p>

<h2 id="conclusion">Conclusion</h2>

<p>ArchUnit provides an elegant way of defining architectural rules, helping you enforce
your design. 
Whilst the AOP compile-time approach is great, too, I prefer an AOP-independent solution.</p>

<p>It would be great to have the layer and onion dsl ported to C#, too.</p>

<p>I will be experimenting with the layers and slowly approach a clean architecture.</p>]]></content><author><name>Andreas Volkmann</name><email>avolkmann@me.com</email></author><category term="blog" /><summary type="html"><![CDATA[Enforcing a layered architecture with tests]]></summary></entry><entry><title type="html">Arkenv v3.2.0 - available on maven central</title><link href="https://andreasvolkmann.github.io//blog/2021-04-03-arkenv-new-release/" rel="alternate" type="text/html" title="Arkenv v3.2.0 - available on maven central" /><published>2021-04-03T00:00:00-07:00</published><updated>2021-04-03T00:00:00-07:00</updated><id>https://andreasvolkmann.github.io//blog/arkenv-new-release</id><content type="html" xml:base="https://andreasvolkmann.github.io//blog/2021-04-03-arkenv-new-release/"><![CDATA[<ol id="markdown-toc">
  <li><a href="#background" id="markdown-toc-background">Background</a></li>
  <li><a href="#new-repository" id="markdown-toc-new-repository">New repository</a></li>
  <li><a href="#new-features" id="markdown-toc-new-features">New features</a>    <ol>
      <li><a href="#plain-class-support" id="markdown-toc-plain-class-support">Plain class support</a>        <ol>
          <li><a href="#constructor-injection" id="markdown-toc-constructor-injection">Constructor injection</a></li>
          <li><a href="#modules" id="markdown-toc-modules">Modules</a></li>
        </ol>
      </li>
      <li><a href="#new-feature-syntax" id="markdown-toc-new-feature-syntax">New feature syntax</a></li>
    </ol>
  </li>
  <li><a href="#breaking-changes" id="markdown-toc-breaking-changes">Breaking changes</a></li>
  <li><a href="#further-information" id="markdown-toc-further-information">Further information</a></li>
</ol>

<p>I am happy to announce that we have migrated from JCenter to <a href="https://search.maven.org/search?q=arkenv">Maven Central</a>, and are
releasing version <code class="language-plaintext highlighter-rouge">3.2.0</code> with new features, including plain class support and constructor injection.
Before we dive into the news, I want to take a look back at how we got here.</p>

<p>  <hy-img root-margin="512px"  src="https://raw.githubusercontent.com/aPureBase/arkenv/master/docs/arkenv_logo.png" alt="Arkenv logo" >    <noscript><img data-ignore  src="https://raw.githubusercontent.com/aPureBase/arkenv/master/docs/arkenv_logo.png" alt="Arkenv logo" /></noscript>    <span class="loading" slot="loading" hidden>      <span class="icon-cog"></span>    </span>  </hy-img></p>

<p>Throughout its lifetime, <a href="https://github.com/aPureBase/arkenv">Arkenv</a> has offered many great learning opportunities, 
and having the chance to create such a project is something I wish upon every developer.</p>

<p>Even though it is in no way a complex, or groundbreaking venture, 
I still consider it an important stepping stone, being my first open-source library.
Keeping the scope small and manageable is probably an advantage when starting out.</p>

<h2 id="background">Background</h2>
<p>There were two primary reasons for the conception of Arkenv.</p>

<p>Firstly, we were looking for a way to seamlessly bridge the changing configuration needs in 
different environments with minimal developer intervention.
Starting out with command line libraries like <a href="https://github.com/cbeust/jcommander">JCommander</a>, 
we soon realized that we wanted a central abstraction to define our external configuration,
which didn‚Äôt depend on the configuration source. 
Pretty much like <a href="https://spring.io/blog/2020/04/23/spring-tips-configuration">Environment</a> in Spring.</p>

<p>For example, we wanted to be able to go from a command line-driven environment to an
environment variable-driven one without having to add code or recompile.</p>

<p>Secondly, I really wanted to try to build something with <a href="https://kotlinlang.org/docs/delegated-properties.html">Kotlin delegates</a>.
Another issue we had with many existing, annotation-based libraries, was the lack of type-safety 
and null support. 
Quickly, we saw that delegates were a perfect fit for these criteria, and the first version
with CLI and ENV support didn‚Äôt fill more than a few lines.</p>

<p>The idea was to declare an immutable property, with nullability indicating whether it is optional or not,
and whose name is used to resolve it.</p>
<div class="language-kotlin highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">val</span> <span class="py">port</span><span class="p">:</span> <span class="nc">Int</span> <span class="k">by</span> <span class="nf">argument</span><span class="p">()</span>
</code></pre></div></div>
<p>Once declared, it can be provided via CLI <code class="language-plaintext highlighter-rouge">--port 443</code>, environment variable <code class="language-plaintext highlighter-rouge">PORT=443</code>,
or in a profile (properties, yaml) <code class="language-plaintext highlighter-rouge">port: 443</code>.</p>

<p>Later on we added support for other sources, like <a href="https://apurebase.gitlab.io/arkenv/features/dot-env-files/">.env files</a>
 and <a href="https://apurebase.gitlab.io/arkenv/features/docker-secrets/">Docker secrets</a>.</p>

<h2 id="new-repository">New repository</h2>
<p>With the announcement of JCenter ending support of their popular repository, 
many open-source projects had to migrate to Maven Central.
We could have lived without this interruption, but on the other hand,
it is great to be able to go with the default repository.</p>

<p>From now on, all new releases will be available here.</p>

<div class="language-kotlin highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nf">repositories</span> <span class="p">{</span>
    <span class="nf">mavenCentral</span><span class="p">()</span>
<span class="p">}</span>

<span class="nf">implementation</span><span class="p">(</span><span class="s">"com.apurebase"</span><span class="p">,</span> <span class="s">"arkenv"</span><span class="p">,</span> <span class="s">"3.2.0"</span><span class="p">)</span>
<span class="nf">implementation</span><span class="p">(</span><span class="s">"com.apurebase"</span><span class="p">,</span> <span class="s">"arkenv-yaml"</span><span class="p">,</span> <span class="s">"3.2.0"</span><span class="p">)</span> <span class="c1">// for yaml support</span>
</code></pre></div></div>

<h2 id="new-features">New features</h2>

<h3 id="plain-class-support">Plain class support</h3>

<p>It is no longer necessary to extend <code class="language-plaintext highlighter-rouge">Arkenv</code> when defining an argument class.</p>

<div class="language-kotlin highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">object</span> <span class="nc">Configuration</span> <span class="p">{</span>
    <span class="kd">val</span> <span class="py">port</span><span class="p">:</span> <span class="nc">Int</span> <span class="k">by</span> <span class="nf">argument</span><span class="p">()</span>
<span class="p">}</span>

<span class="nc">Arkenv</span><span class="p">.</span><span class="nf">parse</span><span class="p">(</span><span class="nc">Arguments</span><span class="p">,</span> <span class="n">args</span><span class="p">)</span>
</code></pre></div></div>

<p>Plain classes do not have a <code class="language-plaintext highlighter-rouge">help</code> argument by default.</p>

<h4 id="constructor-injection">Constructor injection</h4>
<p>Instead of declaring arguments, one can now let <code class="language-plaintext highlighter-rouge">Arkenv</code> inject directly
into the constructor of a plain class.</p>

<div class="language-kotlin highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">class</span> <span class="nc">Configuration</span><span class="p">(</span><span class="kd">val</span> <span class="py">port</span><span class="p">:</span> <span class="nc">Int</span><span class="p">)</span>

<span class="c1">// construct an instance with the parse factory function</span>
<span class="kd">val</span> <span class="py">configuration</span> <span class="p">=</span> <span class="nc">Arkenv</span><span class="p">.</span><span class="n">parse</span><span class="p">&lt;</span><span class="nc">Configuration</span><span class="p">&gt;(</span><span class="n">args</span><span class="p">)</span>
</code></pre></div></div>

<p>Consequently, we cannot apply any config to these arguments, 
but default values are supported natively.</p>

<h4 id="modules">Modules</h4>
<p>The above approaches can be combined freely, and both support modules, too.
In plain classes, modules are declared with a delegate, i.e. <code class="language-plaintext highlighter-rouge">by module()</code>.
The module delegate function also accepts a configuration lambda with prefix support.</p>

<div class="language-kotlin highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">class</span> <span class="nc">SubConfig</span><span class="p">(</span><span class="kd">val</span> <span class="py">country</span><span class="p">:</span> <span class="nc">String</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">val</span> <span class="py">port</span><span class="p">:</span> <span class="nc">Int</span> <span class="k">by</span> <span class="nf">argument</span><span class="p">()</span>
<span class="p">}</span>

<span class="kd">object</span>  <span class="nc">Configuration</span> <span class="p">{</span>
    <span class="kd">val</span> <span class="py">subModule</span> <span class="k">by</span> <span class="n">module</span><span class="p">&lt;</span><span class="nc">SubConfig</span><span class="p">&gt;()</span>
<span class="p">}</span>

<span class="nc">Arkenv</span><span class="p">.</span><span class="nf">parse</span><span class="p">(</span><span class="nc">Configuration</span><span class="p">,</span> <span class="n">args</span><span class="p">)</span>
<span class="nc">Configuration</span><span class="p">.</span><span class="n">subModule</span><span class="p">.</span><span class="n">port</span> <span class="c1">// member access</span>
</code></pre></div></div>

<p>The above <code class="language-plaintext highlighter-rouge">SubConfig</code> class accepts constructor parameters and declares arguments in its body.</p>

<p>The <code class="language-plaintext highlighter-rouge">Configuration</code> object declares a module that is automatically created on parse.</p>

<h3 id="new-feature-syntax">New feature syntax</h3>
<p>Features can now be configured with <code class="language-plaintext highlighter-rouge">+</code> and <code class="language-plaintext highlighter-rouge">-</code>.</p>

<div class="language-kotlin highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">val</span> <span class="py">configuration</span> <span class="p">=</span> <span class="nc">Arkenv</span><span class="p">.</span><span class="n">parse</span><span class="p">&lt;</span><span class="nc">Configuration</span><span class="p">&gt;(</span><span class="n">args</span><span class="p">)</span> <span class="p">{</span>
    <span class="p">+</span><span class="nc">ProfileFeature</span><span class="p">(</span><span class="n">prefix</span> <span class="p">=</span> <span class="s">"app"</span><span class="p">)</span>
<span class="p">}</span>
</code></pre></div></div>

<h2 id="breaking-changes">Breaking changes</h2>
<p>Most extension functions have moved to the <code class="language-plaintext highlighter-rouge">util</code> package.
This will break your build when upgrading, but should be easy to fix,
by importing the correct packages.</p>

<div class="language-kotlin highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">//import com.apurebase.arkenv.parse</span>
<span class="k">import</span> <span class="nn">com.apurebase.arkenv.util.parse</span>
</code></pre></div></div>

<h2 id="further-information">Further information</h2>
<p>Log any bugs or feature requests on <a href="https://github.com/aPureBase/arkenv">Github</a>.</p>

<p>üìÉ Please visit <a href="https://apurebase.gitlab.io/arkenv/">https://apurebase.gitlab.io/arkenv/</a> for in-depth documentation.</p>

<p>ü§ù Ask any questions in the Arkenv channel in the <a href="https://kotlinlang.slack.com/messages/CGF74HD19/">official Kotlin Slack</a>.</p>]]></content><author><name>Andreas Volkmann</name><email>avolkmann@me.com</email></author><category term="blog" /><summary type="html"><![CDATA[New repository, new features, and a look at how we got here]]></summary></entry><entry><title type="html">The x++ Chain of Command</title><link href="https://andreasvolkmann.github.io//blog/2021-01-25-xpp-chain-of-command/" rel="alternate" type="text/html" title="The x++ Chain of Command" /><published>2021-01-25T00:00:00-08:00</published><updated>2021-01-25T00:00:00-08:00</updated><id>https://andreasvolkmann.github.io//blog/xpp-chain-of-command</id><content type="html" xml:base="https://andreasvolkmann.github.io//blog/2021-01-25-xpp-chain-of-command/"><![CDATA[<ol id="markdown-toc">
  <li><a href="#extending-code" id="markdown-toc-extending-code">Extending code</a></li>
  <li><a href="#next" id="markdown-toc-next">Next</a></li>
  <li><a href="#parallels" id="markdown-toc-parallels">Parallels</a></li>
</ol>

<p>One of my favorite features of the x++ programming language is the ability 
to extend classes by creating a chain of command, also referred to as <code class="language-plaintext highlighter-rouge">CoC</code>.</p>

<p>It allows multiple consumers to seamlessly augment existing code side-by-side 
with minimal work required from the owner.</p>

<p>This is especially valuable for software where customization is the norm 
and multiple independent parties want to customize the same code.</p>

<p>The result is a flexible extension model conforming to the open/closed principle.</p>

<h2 id="extending-code">Extending code</h2>
<p>Given a class <code class="language-plaintext highlighter-rouge">OrderSubmitService</code> as defined below, we want to customize 
the validation behavior when an order is submitted.</p>

<p>Inheritance is not an option, as the class is final.
Furthermore, this approach requires that the class can be substituted at its call site,
which is often not possible.</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// file: "OrderSubmitService.xpp"</span>
<span class="kd">public</span> <span class="kd">final</span> <span class="kd">class</span> <span class="nc">OrderSubmitService</span> <span class="c1">// final class, no inheritance</span>
<span class="o">{</span>
    <span class="kd">protected</span> <span class="nc">SimpleOrder</span> <span class="n">simpleOrder</span><span class="o">;</span>

    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">submitOrder</span><span class="o">()</span>
    <span class="o">{</span>
        <span class="k">if</span> <span class="o">(</span><span class="k">this</span><span class="o">.</span><span class="na">validateOrder</span><span class="o">())</span>
        <span class="o">{</span>
            <span class="n">simpleOrder</span><span class="o">.</span><span class="na">submit</span><span class="o">();</span>
        <span class="o">}</span>
    <span class="o">}</span>

    <span class="kd">protected</span> <span class="kt">boolean</span> <span class="nf">validateOrder</span><span class="o">()</span>
    <span class="o">{</span>
        <span class="k">return</span> <span class="n">simpleOrder</span><span class="o">.</span><span class="na">Amount</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="o">;</span> <span class="c1">// we want to customize this</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div>

<p>Ideally, we would like to just add our custom logic to the <code class="language-plaintext highlighter-rouge">validateOrder</code> method.</p>

<h2 id="next">Next</h2>
<p>In order to create a chain of command, we create a new class with the <code class="language-plaintext highlighter-rouge">_Extension</code> suffix 
and add a reference to the target class in the <code class="language-plaintext highlighter-rouge">ExtensionOf</code> attribute.</p>

<p>Then we are free to declare any public or protected methods from the target class
and define custom behavior.</p>

<p>In the below example we add another validation step to the existing one.</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// file: "OrderSubmitService_Extension.xpp"</span>
<span class="o">[</span><span class="nc">ExtensionOf</span><span class="o">(</span><span class="n">classStr</span><span class="o">(</span><span class="nc">OrderSubmitService</span><span class="o">))]</span>
<span class="kd">public</span> <span class="kd">final</span> <span class="kd">class</span> <span class="nc">OrderSubmitService_Extension</span>
<span class="o">{</span>
    <span class="kd">protected</span> <span class="kt">boolean</span> <span class="nf">validateOrder</span><span class="o">()</span>
    <span class="o">{</span>
        <span class="kt">boolean</span> <span class="n">isAvailable</span> <span class="o">=</span> <span class="k">this</span><span class="o">.</span><span class="na">simpleOrder</span><span class="o">.</span><span class="na">IsAvailable</span><span class="o">;</span> <span class="c1">// access to protected members</span>
        <span class="k">return</span> <span class="n">next</span> <span class="nf">validateOrder</span><span class="o">()</span> <span class="o">&amp;&amp;</span> <span class="n">isAvailable</span><span class="o">;</span> <span class="c1">// calling next is mandatory</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div>

<p>Calling next invokes the next extension in the chain, until it reaches the base implementation.</p>

<p>In this way, independent parties can add more layers of code on top of the core,
which can be locked down to prevent unintended side effects.</p>

<p>Looking at the code, this seems oddly familiar.</p>

<h2 id="parallels">Parallels</h2>

<p>There are no other languages with CoC support, AFAIK, but one parallel came to mind.</p>

<p>We can achieve similar results with <code class="language-plaintext highlighter-rouge">@Around</code> advice in AOP as shown in the Kotlin Spring code below.</p>

<div class="language-kotlin highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// file: "OrderSubmitServiceExtension.kt"</span>
<span class="nd">@Aspect</span>
<span class="nd">@Component</span>
<span class="kd">class</span> <span class="nc">OrderSubmitServiceExtension</span> <span class="p">{</span>

  <span class="nd">@Around</span><span class="p">(</span><span class="s">"execution(* OrderSubmitService.validateOrder(..)) &amp;&amp; target(orderSubmitService)"</span><span class="p">)</span>
  <span class="k">fun</span> <span class="nf">validateOrder</span><span class="p">(</span><span class="n">next</span><span class="p">:</span> <span class="nc">ProceedingJoinPoint</span><span class="p">,</span> <span class="n">orderSubmitService</span><span class="p">:</span> <span class="nc">OrderSubmitService</span><span class="p">):</span> <span class="nc">Boolean</span> <span class="p">{</span>
    <span class="kd">val</span> <span class="py">isAvailable</span> <span class="p">=</span> <span class="n">orderSubmitService</span><span class="p">.</span><span class="n">simpleOrder</span><span class="p">.</span><span class="nc">IsAvailable</span>
    <span class="k">return</span> <span class="n">next</span><span class="p">.</span><span class="nf">proceed</span><span class="p">()</span> <span class="p">&amp;&amp;</span> <span class="n">isAvailable</span> <span class="k">as</span> <span class="nc">Boolean</span>
  <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<p>There are some major differences and changes needed to make this work, 
like not being able to access protected members, 
but otherwise it is really cool to observe the similarities here.</p>

<p>Calling <code class="language-plaintext highlighter-rouge">next</code> in x++ is required, but we can ignore the result in both. 
Both provide access to the target class.</p>

<p>Whereas AOP is commonly leveraged to address cross-cutting concerns, 
CoC addresses the cross-cutting concern of code extensibility in x++.</p>

<p>The extension model of x++ is of course much more than CoC.
For example, you can also add state to classes via extensions.
But I have to say, I really came to appreciate the power of the Chain of Command 
in creating elegant, extensible solutions with minimal boilerplate.</p>]]></content><author><name>Andreas Volkmann</name><email>avolkmann@me.com</email></author><category term="blog" /><summary type="html"><![CDATA[Multi-tenant class extension without stepping on each other's toes.]]></summary></entry><entry><title type="html">Spring AOP - Feature Switches</title><link href="https://andreasvolkmann.github.io//blog/2020-11-25-spring-aop-feature-switches/" rel="alternate" type="text/html" title="Spring AOP - Feature Switches" /><published>2020-11-25T00:00:00-08:00</published><updated>2020-11-25T00:00:00-08:00</updated><id>https://andreasvolkmann.github.io//blog/spring-aop-feature-switches</id><content type="html" xml:base="https://andreasvolkmann.github.io//blog/2020-11-25-spring-aop-feature-switches/"><![CDATA[<ol id="markdown-toc">
  <li><a href="#the-aspect" id="markdown-toc-the-aspect">The Aspect</a></li>
</ol>

<p>One idea I recently happened upon is handling feature switches in an aspect.
Essentially, we want to externally control whether certain code should execute or not.</p>

<p>This is really a cross-cutting concern, and thereby a top contender for AOP!
One way to identify candidates for AOP is looking for those small bits of code that are scattered around your code base 
which do not really contribute to the single responsibility of the class.</p>

<p>For feature switches it is annoying having to always inject some feature manager and start things off with:</p>
<div class="language-kotlin highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">val</span> <span class="py">isEnabled</span> <span class="p">=</span> <span class="n">featureSwitchManager</span><span class="p">.</span><span class="nf">isEnabled</span><span class="p">(</span><span class="n">feature</span><span class="p">)</span>

<span class="k">if</span> <span class="p">(</span><span class="n">isEnabled</span><span class="p">)</span> <span class="p">{</span>
    <span class="c1">// actual code</span>
<span class="p">}</span>
</code></pre></div></div>

<p>This is a kind of meta capability that our code shouldn‚Äôt have to worry about. 
Additionally, we are usually happier testing the code without all this extra noise.</p>

<h2 id="the-aspect">The Aspect</h2>

<p>The source is available <a href="https://github.com/AndreasVolkmann/playground/blob/master/src/main/kotlin/me/avo/cosmos/aspect/FeatureAspect.kt">here</a>.</p>

<div class="language-kotlin highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nd">@Aspect</span>
<span class="nd">@Component</span>
<span class="kd">class</span> <span class="nc">FeatureAspect</span><span class="p">(</span>
    <span class="k">private</span> <span class="kd">val</span> <span class="py">featureSwitchManager</span><span class="p">:</span> <span class="nc">FeatureSwitchManager</span>
<span class="p">)</span> <span class="p">{</span>

    <span class="nd">@Pointcut</span><span class="p">(</span><span class="n">value</span> <span class="p">=</span> <span class="s">"execution(public * *(..))"</span><span class="p">)</span>
    <span class="k">fun</span> <span class="nf">anyPublicMethod</span><span class="p">()</span> <span class="p">=</span> <span class="nc">Unit</span>

    <span class="nd">@Around</span><span class="p">(</span><span class="s">"anyPublicMethod() &amp;&amp; @annotation(annotation)"</span><span class="p">)</span>
    <span class="k">fun</span> <span class="nf">proceedIfEnabled</span><span class="p">(</span><span class="n">joinPoint</span><span class="p">:</span> <span class="nc">ProceedingJoinPoint</span><span class="p">,</span> <span class="k">annotation</span><span class="p">:</span> <span class="nc">FeatureSwitch</span><span class="p">):</span> <span class="nc">Any</span><span class="p">?</span> <span class="p">{</span>
        <span class="kd">val</span> <span class="py">featureName</span> <span class="p">=</span> <span class="k">annotation</span><span class="p">.</span><span class="n">name</span><span class="p">.</span><span class="nf">takeIf</span><span class="p">(</span><span class="nc">String</span><span class="o">::</span><span class="n">isNotBlank</span><span class="p">)</span>
            <span class="o">?:</span> <span class="k">throw</span> <span class="nc">FeatureNameBlankException</span><span class="p">(</span><span class="n">joinPoint</span><span class="p">.</span><span class="n">signature</span><span class="p">)</span>

        <span class="k">return</span> <span class="k">when</span> <span class="p">(</span><span class="n">featureSwitchManager</span><span class="p">.</span><span class="nf">isEnabled</span><span class="p">(</span><span class="n">featureName</span><span class="p">))</span> <span class="p">{</span>
            <span class="k">true</span> <span class="p">-&gt;</span> <span class="n">joinPoint</span><span class="p">.</span><span class="nf">proceed</span><span class="p">()</span>
            <span class="k">false</span> <span class="p">-&gt;</span> <span class="k">null</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<p>The implementation is super simple. 
We define a pointcut for any public methods with the <code class="language-plaintext highlighter-rouge">@FeatureSwitch</code> annotation,
and pass the provided feature name to the <code class="language-plaintext highlighter-rouge">FeatureSwitchManager</code>, implementing the actual feature check.</p>

<p>An example of a consuming service:</p>

<div class="language-kotlin highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nd">@Service</span>
<span class="kd">class</span> <span class="nc">MessageService</span> <span class="p">{</span>

    <span class="nd">@FeatureSwitch</span><span class="p">(</span><span class="s">"MessageService"</span><span class="p">)</span>
    <span class="k">fun</span> <span class="nf">run</span><span class="p">()</span> <span class="p">{</span>
        <span class="n">logger</span><span class="p">.</span><span class="nf">info</span><span class="p">(</span><span class="s">"Running message service!"</span><span class="p">)</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<p>Now the run method can be enabled by passing <code class="language-plaintext highlighter-rouge">true</code> in the application properties:</p>
<div class="language-yml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="na">MessageService</span><span class="pi">:</span>
  <span class="na">enabled</span><span class="pi">:</span> <span class="no">true</span>
</code></pre></div></div>

<p>And there you have it.
A simple AOP solution, taking care of feature switch boilerplate code.</p>]]></content><author><name>Andreas Volkmann</name><email>avolkmann@me.com</email></author><category term="blog" /><summary type="html"><![CDATA[Handle feature switch checks with AOP.]]></summary></entry></feed>