<?xml version="1.0" encoding="utf-8"?><feed xmlns="http://www.w3.org/2005/Atom" xml:lang="en"><generator uri="https://jekyllrb.com/" version="4.2.2">Jekyll</generator><link href="https://andreasvolkmann.github.io//feed.xml" rel="self" type="application/atom+xml" /><link href="https://andreasvolkmann.github.io//" rel="alternate" type="text/html" hreflang="en" /><updated>2022-04-09T20:20:00+02:00</updated><id>https://andreasvolkmann.github.io//feed.xml</id><title type="html">Andreas Volkmann</title><subtitle>A personal page for showcasing projects and talking about my interests.
</subtitle><author><name>Andreas Volkmann</name><email>avolkmann@me.com</email></author><entry><title type="html">Dataverse Performance - Flow Iteration</title><link href="https://andreasvolkmann.github.io//blog/2022-04-09-dataverse-perf-flow-loops/" rel="alternate" type="text/html" title="Dataverse Performance - Flow Iteration" /><published>2022-04-09T00:00:00+02:00</published><updated>2022-04-09T00:00:00+02:00</updated><id>https://andreasvolkmann.github.io//blog/dataverse-perf-flow-loops</id><content type="html" xml:base="https://andreasvolkmann.github.io//blog/2022-04-09-dataverse-perf-flow-loops/"><![CDATA[<ol id="markdown-toc">
  <li><a href="#control" id="markdown-toc-control">Control</a></li>
  <li><a href="#data-operations" id="markdown-toc-data-operations">Data Operations</a>    <ol>
      <li><a href="#select" id="markdown-toc-select">Select</a></li>
      <li><a href="#filter" id="markdown-toc-filter">Filter</a></li>
      <li><a href="#change-of-approach" id="markdown-toc-change-of-approach">Change of approach</a></li>
    </ol>
  </li>
  <li><a href="#conclusion" id="markdown-toc-conclusion">Conclusion</a></li>
</ol>

<p>Flows are a great tool for automation and integration,
but whilst the low/no code paradigm aims to make programming more accessible,
it also introduces some pitfalls that are not immediately obvious to both casual and professional programmers.</p>

<p>Performance is a frequently problematic area,
as the restricted Flow development environment makes it hard to see why things are slow
and doesn‚Äôt provide many options to address the issues.</p>

<h1 id="control">Control</h1>
<p>One issue I‚Äôve seen come up again and again in Flows is the use of imperative iteration.
  <hy-img root-margin="512px"  src="/assets/img/flow-control.png" alt="Flow control" >    <noscript><img data-ignore  src="/assets/img/flow-control.png" alt="Flow control" /></noscript>    <span class="loading" slot="loading" hidden>      <span class="icon-cog"></span>    </span>  </hy-img></p>

<p>In other words, the two control actions <code class="language-plaintext highlighter-rouge">Apply to each</code> and <code class="language-plaintext highlighter-rouge">Do until</code>.
At first glance, they seem like the go-to actions for looping.</p>

<p>Turns out you are better off avoiding them unless absolutely necessary, seeing as the performance is abyssmal.
Consider this simple, bare-bones <code class="language-plaintext highlighter-rouge">Do until</code>, with a single action to increment an integer inside:
  <hy-img root-margin="512px"  src="/assets/img/flow-loop-slow.png" alt="Flow loops are slow" >    <noscript><img data-ignore  src="/assets/img/flow-loop-slow.png" alt="Flow loops are slow" /></noscript>    <span class="loading" slot="loading" hidden>      <span class="icon-cog"></span>    </span>  </hy-img></p>

<p>60 iterations took 12 seconds!
This is completely unexpected for someone coming from traditional programming.</p>

<p>When using these control actions, what you‚Äôd likely expect to happen behind the scenes is something like the following:</p>
<div class="language-kotlin highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">while</span> <span class="p">(</span><span class="n">i</span> <span class="p">&lt;</span> <span class="mi">60</span><span class="p">)</span> <span class="p">{</span>
  <span class="n">i</span><span class="p">++</span>
<span class="p">}</span>
</code></pre></div></div>

<p>This should take mere nanoseconds, so how come it took 12 whole seconds in the Flow?</p>

<p>There is significant overhead associated with each iteration, leading to long durations and potential timeouts.
Unlike a traditional while or for loop, the control actions spawn a sub process for each iteration.</p>

<p>Now imagine running this with 1000s of iterations. You can freeze your whole system if you‚Äôre not careful here.</p>

<p>As you can see, simple loops are very counter-intuitive in Flows.
In order to rectify the situation, oftentimes the concurrency is upped.
This does lead to faster execution, but increases the load on the system and can impact quota usage.
  <hy-img root-margin="512px"  src="/assets/img/flow-concurrency.png" alt="Flow concurrency maxed out" >    <noscript><img data-ignore  src="/assets/img/flow-concurrency.png" alt="Flow concurrency maxed out" /></noscript>    <span class="loading" slot="loading" hidden>      <span class="icon-cog"></span>    </span>  </hy-img>
Besides, you‚Äôll hit the max eventually.</p>

<p>Surely, there‚Äôs gotta be a better way, right? After all, loops are such a fundamental part of any program.</p>

<h1 id="data-operations">Data Operations</h1>
<p>The antidote to the <code class="language-plaintext highlighter-rouge">Control loop</code> slowness comes in the form of <code class="language-plaintext highlighter-rouge">Data operations</code>.</p>

<p>  <hy-img root-margin="512px"  src="/assets/img/flow-data-operations.png" alt="Flow data operations are fast" >    <noscript><img data-ignore  src="/assets/img/flow-data-operations.png" alt="Flow data operations are fast" /></noscript>    <span class="loading" slot="loading" hidden>      <span class="icon-cog"></span>    </span>  </hy-img></p>

<p>Data operations are to control loops as imperative programming is to declarative.
They are basically higher order functions.</p>

<p>Let‚Äôs see some quick examples as proof of their speed.</p>

<h2 id="select">Select</h2>
<p>One example could be the transformation of a set of row objects to an array of their ids.
  <hy-img root-margin="512px"  src="/assets/img/flow-loop.png" alt="Flow loop" >    <noscript><img data-ignore  src="/assets/img/flow-loop.png" alt="Flow loop" /></noscript>    <span class="loading" slot="loading" hidden>      <span class="icon-cog"></span>    </span>  </hy-img>
The imperative <code class="language-plaintext highlighter-rouge">Apply to each</code> loop takes ~3 minutes for 300 records,
even though the individual append operation takes less than a second.
The functional <code class="language-plaintext highlighter-rouge">Select</code> operation completes within 1 second.</p>

<h2 id="filter">Filter</h2>
<p>Looping over 100 items, even without any logic in the condition, takes a significant amount of time.
  <hy-img root-margin="512px"  src="/assets/img/flow-filter.png" alt="Flow filter" >    <noscript><img data-ignore  src="/assets/img/flow-filter.png" alt="Flow filter" /></noscript>    <span class="loading" slot="loading" hidden>      <span class="icon-cog"></span>    </span>  </hy-img></p>

<p>The functional <code class="language-plaintext highlighter-rouge">Filter array</code> operation completes in less than a second, as we would expect from such a workload.</p>

<hr />

<p>As we can see, data operations have the performance characteristics
which we originally expected to see form the imperative approach.</p>

<p>There is hardly ever a reason not to use them, as long as the functional outcome is the same.
One area that cannot be covered is the integration with external systems. 
Making a call to a system that expects a single data record cannot be optimized.</p>

<p>If you own the API, you can attempt a batch approach instead of one-by-one calls,
and parse the data with data operations.</p>

<h2 id="change-of-approach">Change of approach</h2>
<p>As with the transition from imperative to functional,
a different mindset is often required to effectively utilize data operations.</p>

<p>I encourage you to leave complex control structures and mutation behind,
and instead focus on pure, higher-order functions processing collections rather than single records.</p>

<p>The best way to learn is to take up languages that naturally promote functional concepts. 
Although most mainstream languages support higher order functions by now,
I personally learned a lot from diving into Kotlin,
which I believe is the perfect bridge between imperative OO and functional.</p>

<h1 id="conclusion">Conclusion</h1>
<p>As a general guideline:
Avoid looping over arrays of even medium size (100s).
Prefer data operations like <code class="language-plaintext highlighter-rouge">Select</code>, <code class="language-plaintext highlighter-rouge">Compose</code>, <code class="language-plaintext highlighter-rouge">Join</code>, <code class="language-plaintext highlighter-rouge">Filter</code> to manipulate and transform multiple records at once.
(Analogous to functional &gt; imperative in OO)</p>

<p>Reserve the control loops for situations where data operations cannot be used.</p>]]></content><author><name>Andreas Volkmann</name><email>avolkmann@me.com</email></author><category term="blog" /><summary type="html"><![CDATA[Addressing common performance bottlenecks in Flows. There is more to loops than meets the eye. Once again, functional beats imperative.]]></summary></entry><entry><title type="html">Language features across the boundary</title><link href="https://andreasvolkmann.github.io//blog/2021-07-25-topic-markers-in-language-design/" rel="alternate" type="text/html" title="Language features across the boundary" /><published>2021-07-25T00:00:00+02:00</published><updated>2021-07-25T00:00:00+02:00</updated><id>https://andreasvolkmann.github.io//blog/topic-markers-in-language-design</id><content type="html" xml:base="https://andreasvolkmann.github.io//blog/2021-07-25-topic-markers-in-language-design/"><![CDATA[<ol id="markdown-toc">
  <li><a href="#topic-markers" id="markdown-toc-topic-markers">Topic markers</a>    <ol>
      <li><a href="#implicit-topics" id="markdown-toc-implicit-topics">Implicit topics</a></li>
    </ol>
  </li>
  <li><a href="#programming-analog" id="markdown-toc-programming-analog">Programming analog</a>    <ol>
      <li><a href="#extension-functions-with-receivers" id="markdown-toc-extension-functions-with-receivers">Extension functions with receivers</a>        <ol>
          <li><a href="#further-parallels" id="markdown-toc-further-parallels">Further parallels</a></li>
        </ol>
      </li>
    </ol>
  </li>
  <li><a href="#conclusion" id="markdown-toc-conclusion">Conclusion</a></li>
</ol>

<p>In western languages we are used to repeatedly re-declare the topic we are talking about.
There is hardly a sentence without a pronoun,
and we often have to find <a href="https://owl.purdue.edu/owl/general_writing/academic_writing/sentence_variety/for_repeated_subjects_or_topics.html">creative ways</a>
to reduce repetition, in order not to sound dry and robotic.</p>

<p>Imagine a typical conversation between person <code class="language-plaintext highlighter-rouge">A</code> and <code class="language-plaintext highlighter-rouge">B</code>:</p>
<div class="language-yml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="na">A</span><span class="pi">:</span> <span class="s">How is your new teacher?</span>
<span class="na">B</span><span class="pi">:</span> <span class="s">I don't like him. He's too strict.</span>
<span class="na">A</span><span class="pi">:</span> <span class="s">Is he worse than Mr. X?</span>
<span class="na">B</span><span class="pi">:</span> <span class="s">No, but he still thinks it's the 80s.</span>
<span class="nn">...</span>
</code></pre></div></div>

<p>This could go on for quite a bit,
but after the first sentence it should be clear to everyone what the topic is.
Then why do we have to repeatedly refer to it?</p>

<p>Think about introducing yourself to an audience.
Nobody is in doubt who you are talking about, 
yet practically every sentence will contain an <code class="language-plaintext highlighter-rouge">I</code> or <code class="language-plaintext highlighter-rouge">my</code>.</p>

<p>Growing up with such a language, this feels normal. 
Although, as developers, we tend to get an allergic reaction when seeing excessive repetition.</p>

<p>Once we discover an elegant alternative, 
we realize that languages like English, German, Danish are really quite verbose. 
They are said to be <a href="https://en.wikipedia.org/wiki/Topic-prominent_language">subject-prominent</a>.</p>

<h1 id="topic-markers">Topic markers</h1>

<p>Some natural languages, like Japanese and Korean, support a feature called <a href="https://en.wikipedia.org/wiki/Topic_marker">topic markers</a>.
They allow you to declare a topic, and then largely omit referencing it throughout the conversation.</p>

<p>Going back to the previous example, once the topic is established, we can stop referring to it.</p>
<div class="language-yml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="na">A</span><span class="pi">:</span> <span class="s">How is new teacher?</span>
<span class="na">B</span><span class="pi">:</span> <span class="s">Don't like. Too strict.</span>
<span class="na">A</span><span class="pi">:</span> <span class="s">Worse than Mr. X?</span>
<span class="na">B</span><span class="pi">:</span> <span class="s">No, but still thinks it's the 80s.</span>
<span class="nn">...</span>
</code></pre></div></div>

<p>This sounds unnatural in English, but is the default in Japanese.
In fact, we can omit nearly all pronouns, as they are usually inferred from the context:</p>
<ul>
  <li>When <code class="language-plaintext highlighter-rouge">A</code> asks <code class="language-plaintext highlighter-rouge">B</code> a question, <code class="language-plaintext highlighter-rouge">B</code> is not in doubt whose teacher <code class="language-plaintext highlighter-rouge">A</code> is talking about.</li>
  <li>When <code class="language-plaintext highlighter-rouge">B</code> states her opinion, both know who about.</li>
  <li>As long as the topic doesn‚Äôt change, there is no need to refer to the teacher with pronouns.</li>
</ul>

<h2 id="implicit-topics">Implicit topics</h2>
<p>Context-heavy languages assume a lot of implicit information, allowing for very succinct communication.
Japanese is known for being on the extreme end of the context-heavy scala, 
as almost every sentence will omit some information.</p>

<blockquote>
  <p>In high context cultures many of the words you might think of as essential in another linguistic setting become unnecessary or out of place. Japanese is one such language, where things are often implied by context and mutual understanding.</p>

  <p><a href="https://www.italki.com/article/877/omitting-the-subject-in-japanese?hl=en">Source</a></p>
</blockquote>

<p><a href="https://en.wikipedia.org/wiki/Japanese_grammar#Thematic_wa">A classic</a> 
is the sentence <code class="language-plaintext highlighter-rouge">ÂÉï„ÅØ„Ç¶„Éä„ÇÆ„Å†</code>, which can be interpreted as <code class="language-plaintext highlighter-rouge">I am an eel</code>, which doesn‚Äôt make much sense.
The implicit context is that we are in a restaurant, where the sentence is used to state your order, 
as in <code class="language-plaintext highlighter-rouge">I'd like the eel, please</code>.</p>

<p>More generally, you omit pronouns in most conversations.
When talking about yourself, stating your thoughts, or telling a story about your kids, you won‚Äôt have to 
 say <code class="language-plaintext highlighter-rouge">I</code> / <code class="language-plaintext highlighter-rouge">my</code>. Once you open your mouth, it is clear that you are the topic.
When seeing a colleague and asking a question, you won‚Äôt say <code class="language-plaintext highlighter-rouge">You</code>. 
The other person understands that he is the one being asked.</p>

<p>Once I went to a book store, where a band was playing. 
Just as I entered, they stopped playing, 
and I went up to one of the members to ask whether they would continue later.
The entire conversation was:</p>
<div class="language-yml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="na">Me</span><span class="pi">:</span> <span class="s">„ÇÇ„ÅÜÁµÇ„Çè„Å£„ÅüÔºü</span> <span class="c1"># ~ Already finished?</span>
<span class="na">He</span><span class="pi">:</span> <span class="s">„Åæ„Å†„ÄÇ</span>       <span class="c1"># ~ Still.</span>
</code></pre></div></div>

<p>I was taken aback by the curtness of his answer, but this is really quite common.</p>

<h1 id="programming-analog">Programming analog</h1>

<p>The first similar concept that comes to mind is a plain class, 
from which we can reference other members of the class without qualification.</p>

<p>As mentioned, in Japanese you can omit declaring yourself as the topic.
Let‚Äôs imagine a class about ourselves, called <code class="language-plaintext highlighter-rouge">I</code>.</p>

<div class="language-kotlin highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">class</span> <span class="nc">I</span> <span class="p">{</span>
    <span class="k">private</span> <span class="k">fun</span> <span class="nf">think</span><span class="p">(</span><span class="n">about</span><span class="p">:</span> <span class="nc">String</span><span class="p">)</span> <span class="p">{}</span>
    
    <span class="k">fun</span> <span class="nf">say</span><span class="p">()</span> <span class="p">{</span>
        <span class="nf">think</span><span class="p">(</span><span class="s">"No more subject!"</span><span class="p">)</span>
        <span class="nf">think</span><span class="p">(</span><span class="s">"Context is awesome!"</span><span class="p">)</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<p>As opposed to:</p>
<div class="language-kotlin highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">val</span> <span class="py">i</span> <span class="p">=</span> <span class="nc">I</span><span class="p">()</span>

<span class="k">fun</span> <span class="nf">say</span><span class="p">()</span> <span class="p">{</span>
    <span class="n">i</span><span class="p">.</span><span class="nf">think</span><span class="p">(</span><span class="s">"therefore I am"</span><span class="p">)</span>
    <span class="n">i</span><span class="p">.</span><span class="nf">think</span><span class="p">(</span><span class="s">"repetition is boring"</span><span class="p">)</span>
<span class="p">}</span>
</code></pre></div></div>

<p>Generally, good design will produce classes with low subject repetition.
Similar to how we organize our prose to minimize repetition and keep the reader engaged. 
If we find ourselves frequently referring to the same subject, 
then that is a sign that the code belongs in a (topic) class.</p>

<p>This works well when we own the class, but what if the topic is out of our control?</p>

<h2 id="extension-functions-with-receivers">Extension functions with receivers</h2>

<p>Have you ever had to write a function which operates on an external type, like the below?</p>
<div class="language-kotlin highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">fun</span> <span class="nf">mutate</span><span class="p">(</span><span class="k">external</span><span class="p">:</span> <span class="nc">External</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">external</span><span class="p">.</span><span class="n">name</span> <span class="p">=</span> <span class="s">"Test"</span>
    <span class="k">external</span><span class="p">.</span><span class="n">age</span> <span class="p">=</span> <span class="mi">10_000</span>
    <span class="k">external</span><span class="p">.</span><span class="n">location</span> <span class="p">=</span> <span class="nf">getCurrentLocation</span><span class="p">()</span>
    <span class="k">external</span><span class="p">.</span><span class="n">status</span> <span class="p">=</span> <span class="o">..</span><span class="p">.</span>
    <span class="k">external</span><span class="p">.</span><span class="n">yetAnotherField</span> <span class="p">=</span> <span class="o">..</span><span class="p">.</span> 
    <span class="c1">/// 10 more fields to set</span>
<span class="p">}</span>
</code></pre></div></div>
<p>This is super annoying. We basically want a way to declare <code class="language-plaintext highlighter-rouge">external</code> as our topic, 
and then stop referring to it in every single line, as if it was a function of the class itself.</p>

<p>In Kotlin, <a href="https://kotlinlang.org/docs/extensions.html#extension-functions">extension functions</a> 
are declared by defining a receiver type for the function.
Within its scope, the receiver becomes <code class="language-plaintext highlighter-rouge">this</code>, and can be omitted.</p>

<div class="language-kotlin highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">fun</span> <span class="nc">External</span><span class="p">.</span><span class="nf">mutate</span><span class="p">()</span> <span class="p">{</span>
    <span class="n">name</span> <span class="p">=</span> <span class="s">"Test"</span>
    <span class="n">age</span> <span class="p">=</span> <span class="mi">10_000</span>
    <span class="n">location</span> <span class="p">=</span> <span class="nf">getCurrentLocation</span><span class="p">()</span>
    <span class="n">status</span> <span class="p">=</span> <span class="o">..</span><span class="p">.</span>
    <span class="o">..</span><span class="p">.</span>
<span class="p">}</span>
</code></pre></div></div>

<p>Such receivers can be thought of as topic markers, 
indicating that the following block of code will invoke the topic without explicitly referencing it.</p>

<p>The standard library contains generic helper functions, like <code class="language-plaintext highlighter-rouge">apply</code> to facilitate this inline.</p>

<div class="language-kotlin highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nc">StringBuilder</span><span class="p">().</span><span class="nf">apply</span> <span class="p">{</span>
    <span class="nf">append</span><span class="p">(</span><span class="s">"Hello "</span><span class="p">)</span>
    <span class="n">names</span><span class="p">.</span><span class="nf">forEach</span> <span class="p">{</span> <span class="nf">append</span><span class="p">(</span><span class="n">it</span><span class="p">).</span><span class="nf">append</span><span class="p">(</span><span class="s">","</span><span class="p">)</span> <span class="p">}</span>
    <span class="nf">setLength</span><span class="p">(</span><span class="n">length</span> <span class="p">-</span> <span class="mi">1</span><span class="p">)</span>
    <span class="nf">append</span><span class="p">(</span><span class="s">"!"</span><span class="p">)</span>
<span class="p">}.</span><span class="nf">toString</span><span class="p">()</span> <span class="c1">// Hello A, B!</span>
</code></pre></div></div>

<p>Without <code class="language-plaintext highlighter-rouge">apply</code>, we would have to declare the subject in every line, sometimes even twice.
We could actually create a similar helper for the Japanese topic marker <code class="language-plaintext highlighter-rouge">„ÅØ</code>:</p>
<div class="language-kotlin highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">infix</span> <span class="k">fun</span> <span class="p">&lt;</span><span class="nc">T</span><span class="p">&gt;</span> <span class="nc">T</span><span class="p">.</span><span class="err">„ÅØ(</span><span class="nf">block</span><span class="p">:</span> <span class="nc">T</span><span class="p">.()</span> <span class="p">-&gt;</span> <span class="nc">Unit</span><span class="p">)</span> <span class="p">=</span> <span class="nf">block</span><span class="p">()</span>

<span class="nc">RestaurantOrder</span><span class="p">()</span> <span class="err">„ÅØ</span> <span class="p">{</span> <span class="nf">unagi</span><span class="p">()</span> <span class="p">}</span>
</code></pre></div></div>

<p>Receivers are frequently leveraged to enable custom DSLs / <a href="https://kotlinlang.org/docs/type-safe-builders.html">type-safe builders</a>. 
For example, a type-safe way to build html in code:</p>
<div class="language-kotlin highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nf">html</span> <span class="p">{</span>
    <span class="nf">header</span> <span class="p">{</span>
        <span class="nf">stylesheet</span><span class="p">(</span><span class="n">color</span> <span class="p">=</span> <span class="s">"blue"</span><span class="p">)</span>
    <span class="p">}</span>
    <span class="nf">body</span> <span class="p">{</span>
        <span class="nf">form</span> <span class="p">{</span>
            <span class="nf">textColumn</span><span class="p">(</span><span class="s">"name"</span><span class="p">)</span>
        <span class="p">}</span>
        <span class="nf">button</span><span class="p">(</span><span class="s">"OK"</span><span class="p">)</span>
    <span class="p">}</span>
    <span class="nf">footer</span><span class="p">()</span>
<span class="p">}</span>
</code></pre></div></div>

<p>Another cool thing here is the notion of nested receivers / topics, just as in natural language.
The <code class="language-plaintext highlighter-rouge">textColumn</code> only makes sense in the context of a form in a body in html.</p>

<p>Going back to the eel example, how could we express this in code?
First, we can always assume an implicit context of <code class="language-plaintext highlighter-rouge">I</code>.
Next, we are in a restaurant and, facing the waiter, it is clear that we intend to order food.</p>

<div class="language-kotlin highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">class</span> <span class="nc">I</span> <span class="p">{</span>
    <span class="k">fun</span> <span class="nc">RestaurantOrder</span><span class="p">.</span><span class="nf">unagi</span><span class="p">()</span> <span class="p">=</span> <span class="nf">order</span><span class="p">(</span><span class="nc">Menu</span><span class="p">.</span><span class="nc">EelOnRice</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
<span class="p">}</span>

<span class="nc">I</span> <span class="p">{</span> <span class="c1">// implicit I</span>
    <span class="nf">restaurant</span> <span class="p">{</span> <span class="c1">// when in restaurant</span>
        <span class="nf">order</span> <span class="p">{</span> <span class="c1">// when about to order</span>
            <span class="nf">unagi</span><span class="p">()</span> <span class="c1">// when in the right context, a single word is sufficient</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>
<p>Notice that we can define <a href="https://kotlinlang.org/docs/extensions.html#declaring-extensions-as-members">local extensions</a>! 
This really allows us to express the concept of sub-topics, 
i.e. the unagi restaurant order only applies to me.</p>

<h3 id="further-parallels">Further parallels</h3>
<p>In Japanese, adding back the omitted subject references still leads to grammatically correct sentences,
but they will be perceived as awkward, and you will have trouble making yourself understood.
This is analogous to unclean code with excessive duplication, or unnecessary qualifications.
For others reading your code, this noise is an impairment to understanding your true intent.</p>

<h1 id="conclusion">Conclusion</h1>
<p>In programming, topics are generally handled by defining classes of cohesive members, 
which can operate on the topic without explicit references. 
Kotlin adds the magic by allowing the same behavior on external types via extensions.
Bonus points for local extensions!</p>

<p>Natural languages like Japanese have a special topic marker particle 
which feels similar to defining the receiver on an extension function.
In context-heavy languages we can omit a lot of implicit information, 
often leading to much shorter, concise sentences.</p>

<p>To me, both Kotlin and Japanese have a sense of elegance, 
as it is super easy to produce highly expressive and concise output.</p>]]></content><author><name>Andreas Volkmann</name><email>avolkmann@me.com</email></author><category term="blog" /><summary type="html"><![CDATA[Topic markers and context can help keep you DRY]]></summary></entry><entry><title type="html">Clean Architecture with ArchUnit</title><link href="https://andreasvolkmann.github.io//blog/2021-04-24-clean-arch-unit/" rel="alternate" type="text/html" title="Clean Architecture with ArchUnit" /><published>2021-04-24T00:00:00+02:00</published><updated>2021-04-24T00:00:00+02:00</updated><id>https://andreasvolkmann.github.io//blog/clean-arch-unit</id><content type="html" xml:base="https://andreasvolkmann.github.io//blog/2021-04-24-clean-arch-unit/"><![CDATA[<ol id="markdown-toc">
  <li><a href="#setup" id="markdown-toc-setup">Setup</a></li>
  <li><a href="#rules" id="markdown-toc-rules">Rules</a></li>
  <li><a href="#conclusion" id="markdown-toc-conclusion">Conclusion</a></li>
</ol>

<p>In a <a href="/blog/2020-02-20-spring-kotlin-gradle-aop">previous post</a>
I discussed ways in which AOP can help in defining our architecture, 
even allowing us to verify architectural rules at compile time.</p>

<p>While this approach certainly does work, it has a few drawbacks, like its reliance on 
AOP, which is not always an option. 
Furthermore, the way these rules are defined is slightly unnatural.</p>

<p>A more idiomatic way of automatically verifying one‚Äôs architecture is <a href="https://www.archunit.org/">ArchUnit</a>,
which enables us to define our rules as unit tests.</p>

<p>Originally a Java library, the project has since been ported to C#, 
which makes sense, considering <s>Java</s> Kotlin and C# are the same language.
If a truly useful library is created in either of these, 
it will eventually be ported to the others, 
just like for <a href="https://en.wikipedia.org/wiki/AspectJ">AspectJ</a> we now got <a href="https://www.postsharp.net/">PostSharp</a>.</p>

<p>Anyway, this is convenient for me, 
since I wanted to take a look at enforcing a clean architecture in C# today. 
(Please read <a href="https://blog.cleancoder.com/uncle-bob/2012/08/13/the-clean-architecture.html">Uncle Bob‚Äôs post</a>)
<a href="https://blog.cleancoder.com/uncle-bob/2012/08/13/the-clean-architecture.html">  <hy-img root-margin="512px"  src="/assets/img/CleanArchitecture.jpg" alt="Overview of the Clean Architecture" >    <noscript><img data-ignore  src="/assets/img/CleanArchitecture.jpg" alt="Overview of the Clean Architecture" /></noscript>    <span class="loading" slot="loading" hidden>      <span class="icon-cog"></span>    </span>  </hy-img></a></p>

<p>In the Java ArchUnit, there is out of the box support for both <code class="language-plaintext highlighter-rouge">layered</code> and <code class="language-plaintext highlighter-rouge">onion</code> architectures, 
but not in the dotnet ports.</p>

<p>I won‚Äôt be going for a full-blown onion / clean arch as my purpose is to slowly evolve 
and improve the architecture of my project. Taking things from 0 to 100 in one step is 
likely not gonna benefit anyone, and it is easier to adapt to small, incremental changes.
So, while the end goal is a clean architecture, 
for now I just want to implement some simple layer checks, 
similar to the ones shown in the image below.</p>

<p>  <hy-img root-margin="512px"  src="/assets/img/layer-check.png" alt="Overview of the Clean Architecture" >    <noscript><img data-ignore  src="/assets/img/layer-check.png" alt="Overview of the Clean Architecture" /></noscript>    <span class="loading" slot="loading" hidden>      <span class="icon-cog"></span>    </span>  </hy-img></p>

<h2 id="setup">Setup</h2>

<p>I found two candidates for ArchUnit-style tests:</p>
<ul>
  <li><a href="https://github.com/TNG/ArchUnitNET">ArchUnitNET</a></li>
  <li><a href="https://github.com/BenMorris/NetArchTest">NetArchTest</a></li>
</ul>

<p>I decided to go with the former, as it is from TNG, the same team as the original library.</p>

<p>After installing, I noticed there is no assert support for <code class="language-plaintext highlighter-rouge">MSTest</code>, 
so I recommend to just copy the related classes from <a href="https://github.com/TNG/ArchUnitNET/tree/master/ArchUnitNET.xUnit">the xUnit folder</a>.</p>

<p><a href="https://github.com/AndreasVolkmann/archNet/tree/master/TestProject1/Arch">Here</a> is what I ended up with.</p>

<h2 id="rules">Rules</h2>

<p>The individual layers can be defined like this:</p>
<div class="language-c# highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kt">var</span> <span class="n">serviceLayer</span>     <span class="p">=</span> <span class="nf">Types</span><span class="p">().</span><span class="nf">That</span><span class="p">().</span><span class="nf">ResideInNamespace</span><span class="p">(</span><span class="s">".Service"</span><span class="p">);</span>
<span class="kt">var</span> <span class="n">controllerLayer</span>  <span class="p">=</span> <span class="nf">Types</span><span class="p">().</span><span class="nf">That</span><span class="p">().</span><span class="nf">ResideInNamespace</span><span class="p">(</span><span class="s">".Controller"</span><span class="p">);</span>
<span class="kt">var</span> <span class="n">peristenceLayer</span>  <span class="p">=</span> <span class="nf">Types</span><span class="p">().</span><span class="nf">That</span><span class="p">().</span><span class="nf">ResideInNamespace</span><span class="p">(</span><span class="s">".Repository"</span><span class="p">);</span>
</code></pre></div></div>

<p>Let‚Äôs start with our first rule: 
None of our code should depend on any controller / inbound port.</p>

<div class="language-c# highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">[</span><span class="n">TestMethod</span><span class="p">]</span>
<span class="k">public</span> <span class="k">void</span> <span class="nf">LayeredArch_Controller</span><span class="p">()</span>
<span class="p">{</span>
    <span class="kt">var</span> <span class="n">rule</span> <span class="p">=</span> <span class="nf">Types</span><span class="p">().</span><span class="nf">That</span><span class="p">().</span><span class="nf">AreNot</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="n">controllerLayer</span><span class="p">)</span>
        <span class="p">.</span><span class="nf">Should</span><span class="p">().</span><span class="nf">NotDependOnAny</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="n">controllerLayer</span><span class="p">);</span>

    <span class="n">rule</span><span class="p">.</span><span class="nf">Check</span><span class="p">(</span><span class="n">Architecture</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div></div>

<p>The next rule prevents access from the persistence layer to the service layer.</p>
<div class="language-c# highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nf">Types</span><span class="p">().</span><span class="nf">That</span><span class="p">().</span><span class="nf">Are</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="n">peristenceLayer</span><span class="p">)</span>
    <span class="p">.</span><span class="nf">Should</span><span class="p">().</span><span class="nf">NotDependOnAny</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="n">serviceLayer</span><span class="p">);</span>
</code></pre></div></div>

<p>And lastly, only allow the service layer to access the persistence layer.</p>
<div class="language-c# highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nf">Types</span><span class="p">().</span><span class="nf">That</span><span class="p">().</span><span class="nf">AreNot</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="n">serviceLayer</span><span class="p">)</span>
    <span class="p">.</span><span class="nf">Should</span><span class="p">().</span><span class="nf">NotDependOnAny</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="n">peristenceLayer</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div></div>

<p>The complete test class is available <a href="https://github.com/AndreasVolkmann/archNet/blob/master/TestProject1/Arch/ArchitectureTests.cs">here</a>.</p>

<h2 id="conclusion">Conclusion</h2>

<p>ArchUnit provides an elegant way of defining architectural rules, helping you enforce
your design. 
Whilst the AOP compile-time approach is great, too, I prefer an AOP-independent solution.</p>

<p>It would be great to have the layer and onion dsl ported to C#, too.</p>

<p>I will be experimenting with the layers and slowly approach a clean architecture.</p>]]></content><author><name>Andreas Volkmann</name><email>avolkmann@me.com</email></author><category term="blog" /><summary type="html"><![CDATA[Enforcing a layered architecture with tests]]></summary></entry><entry><title type="html">Arkenv v3.2.0 - available on maven central</title><link href="https://andreasvolkmann.github.io//blog/2021-04-03-arkenv-new-release/" rel="alternate" type="text/html" title="Arkenv v3.2.0 - available on maven central" /><published>2021-04-03T00:00:00+02:00</published><updated>2021-04-03T00:00:00+02:00</updated><id>https://andreasvolkmann.github.io//blog/arkenv-new-release</id><content type="html" xml:base="https://andreasvolkmann.github.io//blog/2021-04-03-arkenv-new-release/"><![CDATA[<ol id="markdown-toc">
  <li><a href="#background" id="markdown-toc-background">Background</a></li>
  <li><a href="#new-repository" id="markdown-toc-new-repository">New repository</a></li>
  <li><a href="#new-features" id="markdown-toc-new-features">New features</a>    <ol>
      <li><a href="#plain-class-support" id="markdown-toc-plain-class-support">Plain class support</a>        <ol>
          <li><a href="#constructor-injection" id="markdown-toc-constructor-injection">Constructor injection</a></li>
          <li><a href="#modules" id="markdown-toc-modules">Modules</a></li>
        </ol>
      </li>
      <li><a href="#new-feature-syntax" id="markdown-toc-new-feature-syntax">New feature syntax</a></li>
    </ol>
  </li>
  <li><a href="#breaking-changes" id="markdown-toc-breaking-changes">Breaking changes</a></li>
  <li><a href="#further-information" id="markdown-toc-further-information">Further information</a></li>
</ol>

<p>I am happy to announce that we have migrated from JCenter to <a href="https://search.maven.org/search?q=arkenv">Maven Central</a>, and are
releasing version <code class="language-plaintext highlighter-rouge">3.2.0</code> with new features, including plain class support and constructor injection.
Before we dive into the news, I want to take a look back at how we got here.</p>

<p>  <hy-img root-margin="512px"  src="https://raw.githubusercontent.com/aPureBase/arkenv/master/docs/arkenv_logo.png" alt="Arkenv logo" >    <noscript><img data-ignore  src="https://raw.githubusercontent.com/aPureBase/arkenv/master/docs/arkenv_logo.png" alt="Arkenv logo" /></noscript>    <span class="loading" slot="loading" hidden>      <span class="icon-cog"></span>    </span>  </hy-img></p>

<p>Throughout its lifetime, <a href="https://github.com/aPureBase/arkenv">Arkenv</a> has offered many great learning opportunities, 
and having the chance to create such a project is something I wish upon every developer.</p>

<p>Even though it is in no way a complex, or groundbreaking venture, 
I still consider it an important stepping stone, being my first open-source library.
Keeping the scope small and manageable is probably an advantage when starting out.</p>

<h2 id="background">Background</h2>
<p>There were two primary reasons for the conception of Arkenv.</p>

<p>Firstly, we were looking for a way to seamlessly bridge the changing configuration needs in 
different environments with minimal developer intervention.
Starting out with command line libraries like <a href="https://github.com/cbeust/jcommander">JCommander</a>, 
we soon realized that we wanted a central abstraction to define our external configuration,
which didn‚Äôt depend on the configuration source. 
Pretty much like <a href="https://spring.io/blog/2020/04/23/spring-tips-configuration">Environment</a> in Spring.</p>

<p>For example, we wanted to be able to go from a command line-driven environment to an
environment variable-driven one without having to add code or recompile.</p>

<p>Secondly, I really wanted to try to build something with <a href="https://kotlinlang.org/docs/delegated-properties.html">Kotlin delegates</a>.
Another issue we had with many existing, annotation-based libraries, was the lack of type-safety 
and null support. 
Quickly, we saw that delegates were a perfect fit for these criteria, and the first version
with CLI and ENV support didn‚Äôt fill more than a few lines.</p>

<p>The idea was to declare an immutable property, with nullability indicating whether it is optional or not,
and whose name is used to resolve it.</p>
<div class="language-kotlin highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">val</span> <span class="py">port</span><span class="p">:</span> <span class="nc">Int</span> <span class="k">by</span> <span class="nf">argument</span><span class="p">()</span>
</code></pre></div></div>
<p>Once declared, it can be provided via CLI <code class="language-plaintext highlighter-rouge">--port 443</code>, environment variable <code class="language-plaintext highlighter-rouge">PORT=443</code>,
or in a profile (properties, yaml) <code class="language-plaintext highlighter-rouge">port: 443</code>.</p>

<p>Later on we added support for other sources, like <a href="https://apurebase.gitlab.io/arkenv/features/dot-env-files/">.env files</a>
 and <a href="https://apurebase.gitlab.io/arkenv/features/docker-secrets/">Docker secrets</a>.</p>

<h2 id="new-repository">New repository</h2>
<p>With the announcement of JCenter ending support of their popular repository, 
many open-source projects had to migrate to Maven Central.
We could have lived without this interruption, but on the other hand,
it is great to be able to go with the default repository.</p>

<p>From now on, all new releases will be available here.</p>

<div class="language-kotlin highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nf">repositories</span> <span class="p">{</span>
    <span class="nf">mavenCentral</span><span class="p">()</span>
<span class="p">}</span>

<span class="nf">implementation</span><span class="p">(</span><span class="s">"com.apurebase"</span><span class="p">,</span> <span class="s">"arkenv"</span><span class="p">,</span> <span class="s">"3.2.0"</span><span class="p">)</span>
<span class="nf">implementation</span><span class="p">(</span><span class="s">"com.apurebase"</span><span class="p">,</span> <span class="s">"arkenv-yaml"</span><span class="p">,</span> <span class="s">"3.2.0"</span><span class="p">)</span> <span class="c1">// for yaml support</span>
</code></pre></div></div>

<h2 id="new-features">New features</h2>

<h3 id="plain-class-support">Plain class support</h3>

<p>It is no longer necessary to extend <code class="language-plaintext highlighter-rouge">Arkenv</code> when defining an argument class.</p>

<div class="language-kotlin highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">object</span> <span class="nc">Configuration</span> <span class="p">{</span>
    <span class="kd">val</span> <span class="py">port</span><span class="p">:</span> <span class="nc">Int</span> <span class="k">by</span> <span class="nf">argument</span><span class="p">()</span>
<span class="p">}</span>

<span class="nc">Arkenv</span><span class="p">.</span><span class="nf">parse</span><span class="p">(</span><span class="nc">Arguments</span><span class="p">,</span> <span class="n">args</span><span class="p">)</span>
</code></pre></div></div>

<p>Plain classes do not have a <code class="language-plaintext highlighter-rouge">help</code> argument by default.</p>

<h4 id="constructor-injection">Constructor injection</h4>
<p>Instead of declaring arguments, one can now let <code class="language-plaintext highlighter-rouge">Arkenv</code> inject directly
into the constructor of a plain class.</p>

<div class="language-kotlin highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">class</span> <span class="nc">Configuration</span><span class="p">(</span><span class="kd">val</span> <span class="py">port</span><span class="p">:</span> <span class="nc">Int</span><span class="p">)</span>

<span class="c1">// construct an instance with the parse factory function</span>
<span class="kd">val</span> <span class="py">configuration</span> <span class="p">=</span> <span class="nc">Arkenv</span><span class="p">.</span><span class="n">parse</span><span class="p">&lt;</span><span class="nc">Configuration</span><span class="p">&gt;(</span><span class="n">args</span><span class="p">)</span>
</code></pre></div></div>

<p>Consequently, we cannot apply any config to these arguments, 
but default values are supported natively.</p>

<h4 id="modules">Modules</h4>
<p>The above approaches can be combined freely, and both support modules, too.
In plain classes, modules are declared with a delegate, i.e. <code class="language-plaintext highlighter-rouge">by module()</code>.
The module delegate function also accepts a configuration lambda with prefix support.</p>

<div class="language-kotlin highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">class</span> <span class="nc">SubConfig</span><span class="p">(</span><span class="kd">val</span> <span class="py">country</span><span class="p">:</span> <span class="nc">String</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">val</span> <span class="py">port</span><span class="p">:</span> <span class="nc">Int</span> <span class="k">by</span> <span class="nf">argument</span><span class="p">()</span>
<span class="p">}</span>

<span class="kd">object</span>  <span class="nc">Configuration</span> <span class="p">{</span>
    <span class="kd">val</span> <span class="py">subModule</span> <span class="k">by</span> <span class="n">module</span><span class="p">&lt;</span><span class="nc">SubConfig</span><span class="p">&gt;()</span>
<span class="p">}</span>

<span class="nc">Arkenv</span><span class="p">.</span><span class="nf">parse</span><span class="p">(</span><span class="nc">Configuration</span><span class="p">,</span> <span class="n">args</span><span class="p">)</span>
<span class="nc">Configuration</span><span class="p">.</span><span class="n">subModule</span><span class="p">.</span><span class="n">port</span> <span class="c1">// member access</span>
</code></pre></div></div>

<p>The above <code class="language-plaintext highlighter-rouge">SubConfig</code> class accepts constructor parameters and declares arguments in its body.</p>

<p>The <code class="language-plaintext highlighter-rouge">Configuration</code> object declares a module that is automatically created on parse.</p>

<h3 id="new-feature-syntax">New feature syntax</h3>
<p>Features can now be configured with <code class="language-plaintext highlighter-rouge">+</code> and <code class="language-plaintext highlighter-rouge">-</code>.</p>

<div class="language-kotlin highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">val</span> <span class="py">configuration</span> <span class="p">=</span> <span class="nc">Arkenv</span><span class="p">.</span><span class="n">parse</span><span class="p">&lt;</span><span class="nc">Configuration</span><span class="p">&gt;(</span><span class="n">args</span><span class="p">)</span> <span class="p">{</span>
    <span class="p">+</span><span class="nc">ProfileFeature</span><span class="p">(</span><span class="n">prefix</span> <span class="p">=</span> <span class="s">"app"</span><span class="p">)</span>
<span class="p">}</span>
</code></pre></div></div>

<h2 id="breaking-changes">Breaking changes</h2>
<p>Most extension functions have moved to the <code class="language-plaintext highlighter-rouge">util</code> package.
This will break your build when upgrading, but should be easy to fix,
by importing the correct packages.</p>

<div class="language-kotlin highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">//import com.apurebase.arkenv.parse</span>
<span class="k">import</span> <span class="nn">com.apurebase.arkenv.util.parse</span>
</code></pre></div></div>

<h2 id="further-information">Further information</h2>
<p>Log any bugs or feature requests on <a href="https://github.com/aPureBase/arkenv">Github</a>.</p>

<p>üìÉ Please visit <a href="https://apurebase.gitlab.io/arkenv/">https://apurebase.gitlab.io/arkenv/</a> for in-depth documentation.</p>

<p>ü§ù Ask any questions in the Arkenv channel in the <a href="https://kotlinlang.slack.com/messages/CGF74HD19/">official Kotlin Slack</a>.</p>]]></content><author><name>Andreas Volkmann</name><email>avolkmann@me.com</email></author><category term="blog" /><summary type="html"><![CDATA[New repository, new features, and a look at how we got here]]></summary></entry><entry><title type="html">The x++ Chain of Command</title><link href="https://andreasvolkmann.github.io//blog/2021-01-25-xpp-chain-of-command/" rel="alternate" type="text/html" title="The x++ Chain of Command" /><published>2021-01-25T00:00:00+01:00</published><updated>2021-01-25T00:00:00+01:00</updated><id>https://andreasvolkmann.github.io//blog/xpp-chain-of-command</id><content type="html" xml:base="https://andreasvolkmann.github.io//blog/2021-01-25-xpp-chain-of-command/"><![CDATA[<ol id="markdown-toc">
  <li><a href="#extending-code" id="markdown-toc-extending-code">Extending code</a></li>
  <li><a href="#next" id="markdown-toc-next">Next</a></li>
  <li><a href="#parallels" id="markdown-toc-parallels">Parallels</a></li>
</ol>

<p>One of my favorite features of the x++ programming language is the ability 
to extend classes by creating a chain of command, also referred to as <code class="language-plaintext highlighter-rouge">CoC</code>.</p>

<p>It allows multiple consumers to seamlessly augment existing code side-by-side 
with minimal work required from the owner.</p>

<p>This is especially valuable for software where customization is the norm 
and multiple independent parties want to customize the same code.</p>

<p>The result is a flexible extension model conforming to the open/closed principle.</p>

<h2 id="extending-code">Extending code</h2>
<p>Given a class <code class="language-plaintext highlighter-rouge">OrderSubmitService</code> as defined below, we want to customize 
the validation behavior when an order is submitted.</p>

<p>Inheritance is not an option, as the class is final.
Furthermore, this approach requires that the class can be substituted at its call site,
which is often not possible.</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// file: "OrderSubmitService.xpp"</span>
<span class="kd">public</span> <span class="kd">final</span> <span class="kd">class</span> <span class="nc">OrderSubmitService</span> <span class="c1">// final class, no inheritance</span>
<span class="o">{</span>
    <span class="kd">protected</span> <span class="nc">SimpleOrder</span> <span class="n">simpleOrder</span><span class="o">;</span>

    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">submitOrder</span><span class="o">()</span>
    <span class="o">{</span>
        <span class="k">if</span> <span class="o">(</span><span class="k">this</span><span class="o">.</span><span class="na">validateOrder</span><span class="o">())</span>
        <span class="o">{</span>
            <span class="n">simpleOrder</span><span class="o">.</span><span class="na">submit</span><span class="o">();</span>
        <span class="o">}</span>
    <span class="o">}</span>

    <span class="kd">protected</span> <span class="kt">boolean</span> <span class="nf">validateOrder</span><span class="o">()</span>
    <span class="o">{</span>
        <span class="k">return</span> <span class="n">simpleOrder</span><span class="o">.</span><span class="na">Amount</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="o">;</span> <span class="c1">// we want to customize this</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div>

<p>Ideally, we would like to just add our custom logic to the <code class="language-plaintext highlighter-rouge">validateOrder</code> method.</p>

<h2 id="next">Next</h2>
<p>In order to create a chain of command, we create a new class with the <code class="language-plaintext highlighter-rouge">_Extension</code> suffix 
and add a reference to the target class in the <code class="language-plaintext highlighter-rouge">ExtensionOf</code> attribute.</p>

<p>Then we are free to declare any public or protected methods from the target class
and define custom behavior.</p>

<p>In the below example we add another validation step to the existing one.</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// file: "OrderSubmitService_Extension.xpp"</span>
<span class="o">[</span><span class="nc">ExtensionOf</span><span class="o">(</span><span class="n">classStr</span><span class="o">(</span><span class="nc">OrderSubmitService</span><span class="o">))]</span>
<span class="kd">public</span> <span class="kd">final</span> <span class="kd">class</span> <span class="nc">OrderSubmitService_Extension</span>
<span class="o">{</span>
    <span class="kd">protected</span> <span class="kt">boolean</span> <span class="nf">validateOrder</span><span class="o">()</span>
    <span class="o">{</span>
        <span class="kt">boolean</span> <span class="n">isAvailable</span> <span class="o">=</span> <span class="k">this</span><span class="o">.</span><span class="na">simpleOrder</span><span class="o">.</span><span class="na">IsAvailable</span><span class="o">;</span> <span class="c1">// access to protected members</span>
        <span class="k">return</span> <span class="n">next</span> <span class="nf">validateOrder</span><span class="o">()</span> <span class="o">&amp;&amp;</span> <span class="n">isAvailable</span><span class="o">;</span> <span class="c1">// calling next is mandatory</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div>

<p>Calling next invokes the next extension in the chain, until it reaches the base implementation.</p>

<p>In this way, independent parties can add more layers of code on top of the core,
which can be locked down to prevent unintended side effects.</p>

<p>Looking at the code, this seems oddly familiar.</p>

<h2 id="parallels">Parallels</h2>

<p>There are no other languages with CoC support, AFAIK, but one parallel came to mind.</p>

<p>We can achieve similar results with <code class="language-plaintext highlighter-rouge">@Around</code> advice in AOP as shown in the Kotlin Spring code below.</p>

<div class="language-kotlin highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// file: "OrderSubmitServiceExtension.kt"</span>
<span class="nd">@Aspect</span>
<span class="nd">@Component</span>
<span class="kd">class</span> <span class="nc">OrderSubmitServiceExtension</span> <span class="p">{</span>

  <span class="nd">@Around</span><span class="p">(</span><span class="s">"execution(* OrderSubmitService.validateOrder(..)) &amp;&amp; target(orderSubmitService)"</span><span class="p">)</span>
  <span class="k">fun</span> <span class="nf">validateOrder</span><span class="p">(</span><span class="n">next</span><span class="p">:</span> <span class="nc">ProceedingJoinPoint</span><span class="p">,</span> <span class="n">orderSubmitService</span><span class="p">:</span> <span class="nc">OrderSubmitService</span><span class="p">):</span> <span class="nc">Boolean</span> <span class="p">{</span>
    <span class="kd">val</span> <span class="py">isAvailable</span> <span class="p">=</span> <span class="n">orderSubmitService</span><span class="p">.</span><span class="n">simpleOrder</span><span class="p">.</span><span class="nc">IsAvailable</span>
    <span class="k">return</span> <span class="n">next</span><span class="p">.</span><span class="nf">proceed</span><span class="p">()</span> <span class="p">&amp;&amp;</span> <span class="n">isAvailable</span> <span class="k">as</span> <span class="nc">Boolean</span>
  <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<p>There are some major differences and changes needed to make this work, 
like not being able to access protected members, 
but otherwise it is really cool to observe the similarities here.</p>

<p>Calling <code class="language-plaintext highlighter-rouge">next</code> in x++ is required, but we can ignore the result in both. 
Both provide access to the target class.</p>

<p>Whereas AOP is commonly leveraged to address cross-cutting concerns, 
CoC addresses the cross-cutting concern of code extensibility in x++.</p>

<p>The extension model of x++ is of course much more than CoC.
For example, you can also add state to classes via extensions.
But I have to say, I really came to appreciate the power of the Chain of Command 
in creating elegant, extensible solutions with minimal boilerplate.</p>]]></content><author><name>Andreas Volkmann</name><email>avolkmann@me.com</email></author><category term="blog" /><summary type="html"><![CDATA[Multi-tenant class extension without stepping on each other's toes.]]></summary></entry><entry><title type="html">Spring AOP - Feature Switches</title><link href="https://andreasvolkmann.github.io//blog/2020-11-25-spring-aop-feature-switches/" rel="alternate" type="text/html" title="Spring AOP - Feature Switches" /><published>2020-11-25T00:00:00+01:00</published><updated>2020-11-25T00:00:00+01:00</updated><id>https://andreasvolkmann.github.io//blog/spring-aop-feature-switches</id><content type="html" xml:base="https://andreasvolkmann.github.io//blog/2020-11-25-spring-aop-feature-switches/"><![CDATA[<ol id="markdown-toc">
  <li><a href="#the-aspect" id="markdown-toc-the-aspect">The Aspect</a></li>
</ol>

<p>One idea I recently happened upon is handling feature switches in an aspect.
Essentially, we want to externally control whether certain code should execute or not.</p>

<p>This is really a cross-cutting concern, and thereby a top contender for AOP!
One way to identify candidates for AOP is looking for those small bits of code that are scattered around your code base 
which do not really contribute to the single responsibility of the class.</p>

<p>For feature switches it is annoying having to always inject some feature manager and start things off with:</p>
<div class="language-kotlin highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">val</span> <span class="py">isEnabled</span> <span class="p">=</span> <span class="n">featureSwitchManager</span><span class="p">.</span><span class="nf">isEnabled</span><span class="p">(</span><span class="n">feature</span><span class="p">)</span>

<span class="k">if</span> <span class="p">(</span><span class="n">isEnabled</span><span class="p">)</span> <span class="p">{</span>
    <span class="c1">// actual code</span>
<span class="p">}</span>
</code></pre></div></div>

<p>This is a kind of meta capability that our code shouldn‚Äôt have to worry about. 
Additionally, we are usually happier testing the code without all this extra noise.</p>

<h2 id="the-aspect">The Aspect</h2>

<p>The source is available <a href="https://github.com/AndreasVolkmann/playground/blob/master/src/main/kotlin/me/avo/cosmos/aspect/FeatureAspect.kt">here</a>.</p>

<div class="language-kotlin highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nd">@Aspect</span>
<span class="nd">@Component</span>
<span class="kd">class</span> <span class="nc">FeatureAspect</span><span class="p">(</span>
    <span class="k">private</span> <span class="kd">val</span> <span class="py">featureSwitchManager</span><span class="p">:</span> <span class="nc">FeatureSwitchManager</span>
<span class="p">)</span> <span class="p">{</span>

    <span class="nd">@Pointcut</span><span class="p">(</span><span class="n">value</span> <span class="p">=</span> <span class="s">"execution(public * *(..))"</span><span class="p">)</span>
    <span class="k">fun</span> <span class="nf">anyPublicMethod</span><span class="p">()</span> <span class="p">=</span> <span class="nc">Unit</span>

    <span class="nd">@Around</span><span class="p">(</span><span class="s">"anyPublicMethod() &amp;&amp; @annotation(annotation)"</span><span class="p">)</span>
    <span class="k">fun</span> <span class="nf">proceedIfEnabled</span><span class="p">(</span><span class="n">joinPoint</span><span class="p">:</span> <span class="nc">ProceedingJoinPoint</span><span class="p">,</span> <span class="k">annotation</span><span class="p">:</span> <span class="nc">FeatureSwitch</span><span class="p">):</span> <span class="nc">Any</span><span class="p">?</span> <span class="p">{</span>
        <span class="kd">val</span> <span class="py">featureName</span> <span class="p">=</span> <span class="k">annotation</span><span class="p">.</span><span class="n">name</span><span class="p">.</span><span class="nf">takeIf</span><span class="p">(</span><span class="nc">String</span><span class="o">::</span><span class="n">isNotBlank</span><span class="p">)</span>
            <span class="o">?:</span> <span class="k">throw</span> <span class="nc">FeatureNameBlankException</span><span class="p">(</span><span class="n">joinPoint</span><span class="p">.</span><span class="n">signature</span><span class="p">)</span>

        <span class="k">return</span> <span class="k">when</span> <span class="p">(</span><span class="n">featureSwitchManager</span><span class="p">.</span><span class="nf">isEnabled</span><span class="p">(</span><span class="n">featureName</span><span class="p">))</span> <span class="p">{</span>
            <span class="k">true</span> <span class="p">-&gt;</span> <span class="n">joinPoint</span><span class="p">.</span><span class="nf">proceed</span><span class="p">()</span>
            <span class="k">false</span> <span class="p">-&gt;</span> <span class="k">null</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<p>The implementation is super simple. 
We define a pointcut for any public methods with the <code class="language-plaintext highlighter-rouge">@FeatureSwitch</code> annotation,
and pass the provided feature name to the <code class="language-plaintext highlighter-rouge">FeatureSwitchManager</code>, implementing the actual feature check.</p>

<p>An example of a consuming service:</p>

<div class="language-kotlin highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nd">@Service</span>
<span class="kd">class</span> <span class="nc">MessageService</span> <span class="p">{</span>

    <span class="nd">@FeatureSwitch</span><span class="p">(</span><span class="s">"MessageService"</span><span class="p">)</span>
    <span class="k">fun</span> <span class="nf">run</span><span class="p">()</span> <span class="p">{</span>
        <span class="n">logger</span><span class="p">.</span><span class="nf">info</span><span class="p">(</span><span class="s">"Running message service!"</span><span class="p">)</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<p>Now the run method can be enabled by passing <code class="language-plaintext highlighter-rouge">true</code> in the application properties:</p>
<div class="language-yml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="na">MessageService</span><span class="pi">:</span>
  <span class="na">enabled</span><span class="pi">:</span> <span class="no">true</span>
</code></pre></div></div>

<p>And there you have it.
A simple AOP solution, taking care of feature switch boilerplate code.</p>]]></content><author><name>Andreas Volkmann</name><email>avolkmann@me.com</email></author><category term="blog" /><summary type="html"><![CDATA[Handle feature switch checks with AOP.]]></summary></entry><entry><title type="html">Spring AOP - CustomizableTraceInterceptor</title><link href="https://andreasvolkmann.github.io//blog/2020-09-27-spring-aop-logging/" rel="alternate" type="text/html" title="Spring AOP - CustomizableTraceInterceptor" /><published>2020-09-27T00:00:00+02:00</published><updated>2020-09-27T00:00:00+02:00</updated><id>https://andreasvolkmann.github.io//blog/spring-aop-logging</id><content type="html" xml:base="https://andreasvolkmann.github.io//blog/2020-09-27-spring-aop-logging/"><![CDATA[<ol id="markdown-toc">
  <li><a href="#logger-configuration" id="markdown-toc-logger-configuration">Logger configuration</a></li>
  <li><a href="#conclusion" id="markdown-toc-conclusion">Conclusion</a></li>
</ol>

<p>The more I learn about Spring, the more I come to understand and appreciate its true power, 
with one major appeal being developer productivity.</p>

<p>In my <a href="https://andreasvolkmann.github.io/blog/2020-02-20-spring-kotlin-gradle-aop/">previous post</a> 
I discussed some useful things we can do with aspect oriented programming, including logging. 
Spring covers many of these use cases out of the box, without any additional concepts or dependencies.
Let‚Äôs explore how to configure a trace interceptor and how this can make us more productive.</p>

<p>Oftentimes, when we encounter a bug in the live application, 
we want to get a deeper understanding of what lead to the current state 
and turn to the logs.
Now, during development we may not have decided upon and set up detailed logging, 
which leads us to add some additional logging or print statements 
to get insights into the erroneous process.</p>

<p>This costs time, is annoying, and is ultimately not a very lean process, as a better alternative is available.
The premise is the following:</p>
<blockquote>
  <p>Automatically provide meaningful insights into the app. 
Configure once, applied seamlessly to any existing or new code without additional work.</p>
</blockquote>

<p>Say you implement a new part of your app, including a service with one central method:</p>
<div class="language-kotlin highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nd">@Service</span>
<span class="kd">class</span> <span class="nc">TestService</span> <span class="p">{</span>

    <span class="k">fun</span> <span class="nf">testMultiply</span><span class="p">(</span><span class="n">x</span><span class="p">:</span> <span class="nc">Int</span><span class="p">,</span> <span class="n">y</span><span class="p">:</span> <span class="nc">Int</span><span class="p">):</span> <span class="nc">Int</span> <span class="p">{</span>
        <span class="nc">Thread</span><span class="p">.</span><span class="nf">sleep</span><span class="p">(</span><span class="mi">250</span><span class="p">)</span>
        <span class="nf">println</span><span class="p">(</span><span class="s">"TEST!"</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">x</span> <span class="p">*</span> <span class="n">y</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<p>Now, during testing it turns out there is a bug which leads to inconsistent results, 
even though you are sure the input params are as expected.</p>

<p>Wouldn‚Äôt it be nice to have the following in your logs:</p>
<div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="s">2020-09-27 13:32:51.404 TRACE 2220 --- [Test worker] m.a.y.s.TestService</span><span class="err">:</span> <span class="s">Entering testMultiply(6,7)</span>
<span class="s">TEST!</span>
<span class="s">2020-09-27 13:32:51.654 TRACE 2220 --- [Test worker] m.a.y.s.TestService</span><span class="err">:</span> <span class="s">Leaving testMultiply(), returned 42, running time = 250 ms</span>
</code></pre></div></div>

<p>This includes a message on entering and leaving the method, 
with information about the parameters, the return value and the time spent.
This can be customized further, but is usually a good starting point.</p>

<h3 id="logger-configuration">Logger configuration</h3>

<p>Here is the corresponding logger configuration. Source available <a href="https://github.com/AndreasVolkmann/Yunyin/blob/master/src/main/kotlin/me/avo/yunyin/config/LoggerConfig.kt">here</a>.</p>

<div class="language-kotlin highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nd">@Configuration</span>
<span class="kd">class</span> <span class="nc">LoggerConfig</span> <span class="p">{</span>

    <span class="nd">@Bean</span> <span class="k">fun</span> <span class="nf">customizableTraceInterceptor</span><span class="p">()</span> <span class="p">=</span> <span class="nc">CustomizableTraceInterceptor</span><span class="p">().</span><span class="nf">apply</span> <span class="p">{</span>
        <span class="nf">setUseDynamicLogger</span><span class="p">(</span><span class="k">true</span><span class="p">)</span>
        <span class="nf">setEnterMessage</span><span class="p">(</span><span class="s">"Entering $[methodName]($[arguments])"</span><span class="p">)</span>
        <span class="nf">setExitMessage</span><span class="p">(</span><span class="s">"Leaving $[methodName](), returned $[returnValue], running time = $[invocationTime] ms"</span><span class="p">)</span>
        <span class="nf">setExceptionMessage</span><span class="p">(</span><span class="s">"Error $[methodName](), exception $[exception], running time = $[invocationTime] ms"</span><span class="p">)</span>
    <span class="p">}</span>

    <span class="nd">@Bean</span> <span class="k">fun</span> <span class="nf">loggingAdvisor</span><span class="p">():</span> <span class="nc">Advisor</span> <span class="p">{</span>
        <span class="kd">val</span> <span class="py">pointcut</span> <span class="p">=</span> <span class="nc">AspectJExpressionPointcut</span><span class="p">().</span><span class="nf">apply</span> <span class="p">{</span>
            <span class="n">expression</span> <span class="p">=</span> <span class="s">"""
                execution (* (@org.springframework.stereotype.Service *).*(..)) 
             || execution (* (@org.springframework.stereotype.Component *).*(..))
            """</span><span class="p">.</span><span class="nf">trimIndent</span><span class="p">()</span>
        <span class="p">}</span>
        <span class="k">return</span> <span class="nc">DefaultPointcutAdvisor</span><span class="p">(</span><span class="n">pointcut</span><span class="p">,</span> <span class="nf">customizableTraceInterceptor</span><span class="p">())</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<p>The details of the pointcut expression depend on what classes you want to target. 
I just wanted to know about all services and components.</p>

<p>Notice that we do not need any explicit Spring AOP dependency 
or any other application configuration. 
The entire trace logging is self-contained and can be deployed from day one. 
You can copy-paste this class, and it works immediately.</p>

<p>By default, the traces are logged as trace, so set the logging level accordingly.
My <code class="language-plaintext highlighter-rouge">application.yml</code> contains the following during development, 
where the last part is my root package name.</p>
<div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="na">logging</span><span class="pi">:</span>
  <span class="na">level</span><span class="pi">:</span>
    <span class="na">me.avo.yunyin</span><span class="pi">:</span> <span class="s">TRACE</span>
</code></pre></div></div>

<h3 id="conclusion">Conclusion</h3>
<p>No, or greatly reduced need to write debug statements!
Thanks to proxying, your code stays clean, whilst Spring works its magic.</p>

<p>For production use, you will of course have to adapt your logging, 
but during development this is value for no money.</p>

<p>I will experiment further to see how far I can push this, 
but this will definitely be a part of every future app I work on.</p>]]></content><author><name>Andreas Volkmann</name><email>avolkmann@me.com</email></author><category term="blog" /><summary type="html"><![CDATA[Immediate, automated insights into your application.]]></summary></entry><entry><title type="html">Aspect Oriented Programming: Spring, Kotlin, Gradle</title><link href="https://andreasvolkmann.github.io//blog/2020-02-20-spring-kotlin-gradle-aop/" rel="alternate" type="text/html" title="Aspect Oriented Programming: Spring, Kotlin, Gradle" /><published>2020-02-20T00:00:00+01:00</published><updated>2020-02-20T00:00:00+01:00</updated><id>https://andreasvolkmann.github.io//blog/spring-kotlin-gradle-aop</id><content type="html" xml:base="https://andreasvolkmann.github.io//blog/2020-02-20-spring-kotlin-gradle-aop/"><![CDATA[<ol id="markdown-toc">
  <li><a href="#setup" id="markdown-toc-setup">Setup</a></li>
  <li><a href="#aspects" id="markdown-toc-aspects">Aspects</a>    <ol>
      <li><a href="#pointcuts" id="markdown-toc-pointcuts">Pointcuts</a></li>
    </ol>
  </li>
  <li><a href="#compile-time-checks" id="markdown-toc-compile-time-checks">Compile-time checks</a></li>
</ol>

<p>I‚Äôve seen a lot of resources regarding AOP for Java and / or Maven, but couldn‚Äôt find a lot about the Kotlin+Gradle combo.
As for the Spring side, <a href="https://start.spring.io/">the Spring Initializr </a> doesn‚Äôt even list the aop starter, which is apparently by design.
So I decided to show a working solution for the mentioned stack. The code referenced can be found <a href="https://github.com/AndreasVolkmann/Spring-Reactive-Security">here</a>.</p>

<p>Aspect oriented programming is a great way of defining cross-cutting concerns that can simplify your project and help establish your architecture.</p>

<h3 id="setup">Setup</h3>
<p>First thing is to add the required dependencies to the build.</p>
<ul>
  <li>The spring aop starter is needed for defining aspects.</li>
  <li>The aspectj plugin is needed for compile-time checks.</li>
</ul>

<p>See <a href="https://github.com/AndreasVolkmann/Spring-Reactive-Security/blob/master/build.gradle.kts#L7">the reference build file</a>.</p>

<p>There are a bunch of gradle plugins, but most are outdated and lack proper documentation.
The freefair plugin was the only one I could get to work, <a href="https://docs.freefair.io/gradle-plugins/current/reference/#_aspectj">documentation here</a>.
Just add the post-compile-weaving plugin and set your aspectj version in <code class="language-plaintext highlighter-rouge">gradle.properties</code>.</p>

<h3 id="aspects">Aspects</h3>

<p>Now we can start writing a custom aspect.
<a href="https://github.com/AndreasVolkmann/Spring-Reactive-Security/blob/master/src/main/kotlin/com/example/demo/config/aspect/ActivityAspect.kt">The example</a>
shows an aspect that monitors all activities by logging start and end events including the time elapsed and whether it succeeded or failed.
Using <code class="language-plaintext highlighter-rouge">@Around</code> advice we can wrap all methods that match the defined pointcut in a try-catch-finally.</p>

<div class="language-kotlin highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nd">@Aspect</span>
<span class="nd">@Component</span>
<span class="kd">class</span> <span class="nc">ActivityAspect</span> <span class="p">{</span>

    <span class="k">private</span> <span class="kd">val</span> <span class="py">logger</span> <span class="p">=</span> <span class="nc">LoggerFactory</span><span class="p">.</span><span class="nf">getLogger</span><span class="p">(</span><span class="k">this</span><span class="o">::</span><span class="k">class</span><span class="p">.</span><span class="n">java</span><span class="p">)</span>

    <span class="nd">@Around</span><span class="p">(</span><span class="s">"Architecture.activity() || Architecture.repository() || Architecture.service()"</span><span class="p">)</span>
    <span class="k">fun</span> <span class="nf">monitorActivity</span><span class="p">(</span><span class="n">proceedingJoinPoint</span><span class="p">:</span> <span class="nc">ProceedingJoinPoint</span><span class="p">):</span> <span class="nc">Any</span><span class="p">?</span> <span class="p">{</span>
        <span class="kd">val</span> <span class="py">name</span> <span class="p">=</span> <span class="n">proceedingJoinPoint</span><span class="p">.</span><span class="n">staticPart</span><span class="p">.</span><span class="n">signature</span><span class="p">.</span><span class="nf">toShortString</span><span class="p">()</span>
        <span class="kd">var</span> <span class="py">state</span> <span class="p">=</span> <span class="s">"SUCCESS"</span>
        <span class="n">logger</span><span class="p">.</span><span class="nf">info</span><span class="p">(</span><span class="s">"Activity start: $name"</span><span class="p">)</span>
        <span class="kd">val</span> <span class="py">startTime</span> <span class="p">=</span> <span class="nc">System</span><span class="p">.</span><span class="nf">currentTimeMillis</span><span class="p">()</span>
        <span class="k">try</span> <span class="p">{</span>
            <span class="k">return</span> <span class="n">proceedingJoinPoint</span><span class="p">.</span><span class="nf">proceed</span><span class="p">()</span>
        <span class="p">}</span>
        <span class="k">catch</span> <span class="p">(</span><span class="n">ex</span><span class="p">:</span> <span class="nc">Exception</span><span class="p">)</span> <span class="p">{</span>
            <span class="n">state</span> <span class="p">=</span> <span class="s">"ERROR"</span>
            <span class="k">throw</span> <span class="n">ex</span>
        <span class="p">}</span>
        <span class="k">finally</span> <span class="p">{</span>
            <span class="kd">val</span> <span class="py">timeElapsed</span> <span class="p">=</span> <span class="nc">System</span><span class="p">.</span><span class="nf">currentTimeMillis</span><span class="p">()</span> <span class="p">-</span> <span class="n">startTime</span>
            <span class="n">logger</span><span class="p">.</span><span class="nf">info</span><span class="p">(</span><span class="s">"Activity end: $name ($state $timeElapsed ms)"</span><span class="p">)</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<h4 id="pointcuts">Pointcuts</h4>
<p>In order to define what methods the advice is applied to, pointcuts can be used to describe the architecture of the application.
<a href="https://github.com/AndreasVolkmann/Spring-Reactive-Security/blob/master/src/main/kotlin/com/example/demo/config/aspect/Architecture.kt">In the example</a>
we want to monitor all public methods in any service or repository, as well as any method annotated with a custom <code class="language-plaintext highlighter-rouge">@Activity</code> annotation.</p>

<div class="language-kotlin highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">class</span> <span class="nc">Architecture</span> <span class="p">{</span>

    <span class="nd">@Pointcut</span><span class="p">(</span><span class="s">"execution(* (@org.springframework.stereotype.Repository *).*(..))"</span><span class="p">)</span>
    <span class="k">fun</span> <span class="nf">service</span><span class="p">()</span> <span class="p">=</span> <span class="nc">Unit</span>

    <span class="nd">@Pointcut</span><span class="p">(</span><span class="s">"execution (* (@org.springframework.stereotype.Service *).*(..))"</span><span class="p">)</span>
    <span class="k">fun</span> <span class="nf">repository</span><span class="p">()</span> <span class="p">=</span> <span class="nc">Unit</span>

    <span class="nd">@Pointcut</span><span class="p">(</span><span class="s">"(@annotation(Activity) &amp;&amp; execution(* *(..)))"</span><span class="p">)</span>
    <span class="k">fun</span> <span class="nf">activity</span><span class="p">()</span> <span class="p">=</span> <span class="nc">Unit</span>
<span class="p">}</span>
</code></pre></div></div>

<p>Here is a demo service that would match these pointcuts:</p>
<div class="language-kotlin highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nd">@Service</span>
<span class="kd">class</span> <span class="nc">DemoService</span> <span class="p">{</span>

    <span class="nd">@Activity</span> <span class="c1">// optional, can be used on methods outside of services / repositories</span>
    <span class="k">fun</span> <span class="nf">run</span><span class="p">(</span><span class="n">someBool</span><span class="p">:</span> <span class="nc">Boolean</span><span class="p">):</span> <span class="nc">String</span> <span class="p">{</span>
        <span class="o">..</span><span class="p">.</span>
    <span class="p">}</span>

    <span class="k">fun</span> <span class="nf">noAnnotation</span><span class="p">()</span> <span class="p">{</span>
        <span class="o">..</span><span class="p">.</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<h3 id="compile-time-checks">Compile-time checks</h3>

<p>AspectJ can be used to define compile-time checks that produce errors or warnings when matched.
For example, we can introduce a check that ensures that no code from the <code class="language-plaintext highlighter-rouge">java.sql</code> or <code class="language-plaintext highlighter-rouge">javax.sql</code>
package is called outside of a repository.</p>

<div class="language-kotlin highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nd">@Aspect</span>
<span class="kd">class</span> <span class="nc">CheckAspect</span> <span class="p">{</span>

    <span class="nd">@DeclareError</span><span class="p">(</span><span class="s">"!Architecture.repository() &amp;&amp; (call (* java.sql..*.*(..)) || call (* javax.sql..*.*(..)))"</span><span class="p">)</span>
    <span class="kd">val</span> <span class="py">jdbcOutsideRepository</span> <span class="p">=</span> <span class="s">"Only call jdbc code from within repositories."</span>
<span class="p">}</span>
</code></pre></div></div>

<p>When compiling the following function, the compiler will throw an error.</p>
<div class="language-kotlin highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">fun</span> <span class="nf">methodUsingJavaxSql</span><span class="p">()</span> <span class="p">{</span>
    <span class="n">javax</span><span class="p">.</span><span class="n">sql</span><span class="p">.</span><span class="n">rowset</span><span class="p">.</span><span class="nc">RowSetMetaDataImpl</span><span class="p">().</span><span class="nf">getCatalogName</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
<span class="p">}</span>
</code></pre></div></div>

<p>I am really happy with the results and the fact that the Spring team is pushing and actively promoting Kotlin as the language of choice.
One issue that still remains is handling suspending functions with AOP, since <code class="language-plaintext highlighter-rouge">proceed</code> will return when suspending.
Hopefully the fix makes it into the next release. <a href="https://github.com/spring-projects/spring-framework/issues/22462">Tracking issue here</a>.</p>]]></content><author><name>Andreas Volkmann</name><email>avolkmann@me.com</email></author><category term="blog" /><summary type="html"><![CDATA[System architecture and compile-time checks using AOP.]]></summary></entry><entry><title type="html">M3U8 playlists and .ts segments</title><link href="https://andreasvolkmann.github.io//blog/2018-04-27-m3u8-and-ts-segments/" rel="alternate" type="text/html" title="M3U8 playlists and .ts segments" /><published>2018-04-27T00:00:00+02:00</published><updated>2018-04-27T00:00:00+02:00</updated><id>https://andreasvolkmann.github.io//blog/m3u8-and-ts-segments</id><content type="html" xml:base="https://andreasvolkmann.github.io//blog/2018-04-27-m3u8-and-ts-segments/"><![CDATA[<ol id="markdown-toc">
  <li><a href="#master-playlist" id="markdown-toc-master-playlist">Master Playlist</a></li>
  <li><a href="#media-playlist" id="markdown-toc-media-playlist">Media Playlist</a></li>
  <li><a href="#encryption" id="markdown-toc-encryption">Encryption</a></li>
  <li><a href="#demux" id="markdown-toc-demux">Demux</a></li>
  <li><a href="#merging" id="markdown-toc-merging">Merging</a></li>
</ol>

<p>I was recently working on my <a href="https://github.com/AndreasVolkmann/nhk-easy-kumo">NHK-Easy web crawler project</a>, since the site got an update with a number of breaking changes. One of these changes was concerning the audio of the articles.</p>

<p>Previously, each article had a corresponding static .mp3 resource. The update introduced a new HLS (HTTP Live Streaming) media player, accompanied by a M3U8 playlist. Furthermore, I observed that the audio was now split into several ts file segments, which were loaded on demand.</p>

<p>I had never worked with these file types before, so off I went to google. However, it wasn‚Äôt exactly easy to find answers to my questions, which is why I decided to summarize my findings here, in case other people have similar issues. Also, I wanted to have a go at writing my first post.</p>

<blockquote>
  <p>Given a master M3U8 playlist, the goal is to end up with a single mp3 file.</p>
</blockquote>

<p>  <hy-img root-margin="512px"  src="/assets/img/m3u8.png" alt="Overview of M3U8 playlist structure." >    <noscript><img data-ignore  src="/assets/img/m3u8.png" alt="Overview of M3U8 playlist structure." /></noscript>    <span class="loading" slot="loading" hidden>      <span class="icon-cog"></span>    </span>  </hy-img></p>

<h3 id="master-playlist">Master Playlist</h3>

<p>The first step when dealing with M3U8, is parsing the master playlist.</p>

<p>I found the open-m3u8 library by iHeartRadio works best. The alternative is Comcast‚Äôs hlsparserj, but it lacks features and requires more manual work.</p>

<p>Once the master playlist is parsed, one can read its content, which consists of one or more media playlists.</p>

<h3 id="media-playlist">Media Playlist</h3>

<p>A typical media playlist could look like the following.</p>

<div class="language-css highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nf">#EXTM3U</span>
<span class="nf">#EXT-X-TARGETDURATION</span><span class="o">:</span><span class="err">6</span>
<span class="nf">#EXT-X-ALLOW-CACHE</span><span class="nd">:YES</span>
<span class="nf">#EXT-X-KEY</span><span class="nd">:METHOD</span><span class="o">=</span><span class="nt">AES-128</span><span class="o">,</span><span class="nt">URI</span><span class="o">=</span><span class="s1">"https://site.net/path/to/resource.mp4/crypt.key?id=somekey"</span>
<span class="nf">#EXT-X-PLAYLIST-TYPE</span><span class="nd">:VOD</span>
<span class="nf">#EXT-X-VERSION</span><span class="o">:</span><span class="err">3</span>
<span class="nf">#EXT-X-MEDIA-SEQUENCE</span><span class="o">:</span><span class="err">1</span>
<span class="nf">#EXTINF</span><span class="o">:</span><span class="err">6</span><span class="o">.</span><span class="err">000</span><span class="o">,</span>
<span class="nt">https</span><span class="o">://</span><span class="nt">site</span><span class="nc">.net</span><span class="o">/</span><span class="nt">path</span><span class="o">/</span><span class="nt">to</span><span class="o">/</span><span class="nt">resource</span><span class="nc">.mp4</span><span class="o">/</span><span class="nt">segment1_0_a</span><span class="nc">.ts</span>
<span class="nf">#EXTINF</span><span class="o">:</span><span class="err">6</span><span class="o">.</span><span class="err">000</span><span class="o">,</span>
<span class="nt">https</span><span class="o">://</span><span class="nt">site</span><span class="nc">.net</span><span class="o">/</span><span class="nt">path</span><span class="o">/</span><span class="nt">to</span><span class="o">/</span><span class="nt">resource</span><span class="nc">.mp4</span><span class="o">/</span><span class="nt">segment2_0_a</span><span class="nc">.ts</span>
<span class="nf">#EXTINF</span><span class="o">:</span><span class="err">6</span><span class="o">.</span><span class="err">000</span><span class="o">,</span>
<span class="nt">https</span><span class="o">://</span><span class="nt">site</span><span class="nc">.net</span><span class="o">/</span><span class="nt">path</span><span class="o">/</span><span class="nt">to</span><span class="o">/</span><span class="nt">resource</span><span class="nc">.mp4</span><span class="o">/</span><span class="nt">segment3_0_a</span><span class="nc">.ts</span>
<span class="nf">#EXTINF</span><span class="o">:</span><span class="err">1</span><span class="o">.</span><span class="err">992</span><span class="o">,</span>
<span class="nt">https</span><span class="o">://</span><span class="nt">site</span><span class="nc">.net</span><span class="o">/</span><span class="nt">path</span><span class="o">/</span><span class="nt">to</span><span class="o">/</span><span class="nt">resource</span><span class="nc">.mp4</span><span class="o">/</span><span class="nt">segment4_0_a</span><span class="nc">.ts</span>
<span class="nf">#EXT-X-ENDLIST</span>
</code></pre></div></div>

<p>It contains an url for each segment that the stream is made up of. Additionally, there are a number of meta tags, of which one is particularly important.</p>

<h3 id="encryption">Encryption</h3>

<p>What took me the longest to figure out was that the segments were encrypted. According to specification, MPEG-TS files (.ts) start with a BOM (Byte Order Mark) in the form of the ASCII char <code class="language-plaintext highlighter-rouge">G</code>. What confused me was, that there was no <code class="language-plaintext highlighter-rouge">G</code>, since the files were encrypted. Lesson learned, go read <a href="https://tools.ietf.org/html/draft-pantos-http-live-streaming-23#section-3">the specification</a>.</p>

<p>Here is how I handle the encryption.</p>

<div class="language-kotlin highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">fun</span> <span class="nf">getCipher</span><span class="p">(</span><span class="n">data</span><span class="p">:</span> <span class="nc">EncryptionData</span><span class="p">):</span> <span class="nc">Cipher</span> <span class="p">{</span>
    <span class="kd">val</span> <span class="py">bytes</span> <span class="p">=</span> <span class="nc">URL</span><span class="p">(</span><span class="n">data</span><span class="p">.</span><span class="n">uri</span><span class="p">).</span><span class="nf">readBytes</span><span class="p">()</span>
    <span class="kd">val</span> <span class="py">chainmode</span> <span class="p">=</span> <span class="s">"CBC"</span>
    <span class="kd">val</span> <span class="py">method</span> <span class="p">=</span> <span class="k">when</span> <span class="p">(</span><span class="n">data</span><span class="p">.</span><span class="n">method</span><span class="p">)</span> <span class="p">{</span>
        <span class="nc">EncryptionMethod</span><span class="p">.</span><span class="nc">AES</span> <span class="p">-&gt;</span> <span class="s">"AES/$chainmode/NoPadding"</span>
        <span class="k">else</span> <span class="p">-&gt;</span> <span class="n">data</span><span class="p">.</span><span class="n">method</span><span class="p">.</span><span class="n">name</span>
    <span class="p">}</span>
    <span class="kd">val</span> <span class="py">keySpec</span> <span class="p">=</span> <span class="nc">SecretKeySpec</span><span class="p">(</span><span class="n">bytes</span><span class="p">,</span> <span class="n">data</span><span class="p">.</span><span class="n">method</span><span class="p">.</span><span class="n">name</span><span class="p">)</span>
    <span class="n">logger</span><span class="p">.</span><span class="nf">trace</span><span class="p">(</span><span class="s">"Decrypting using method ${data.method} ($method)"</span><span class="p">)</span>
    <span class="k">return</span> <span class="nc">Cipher</span>
        <span class="p">.</span><span class="nf">getInstance</span><span class="p">(</span><span class="n">method</span><span class="p">)</span>
        <span class="p">.</span><span class="nf">apply</span> <span class="p">{</span> <span class="nf">init</span><span class="p">(</span><span class="nc">Cipher</span><span class="p">.</span><span class="nc">DECRYPT_MODE</span><span class="p">,</span> <span class="n">keySpec</span><span class="p">,</span> <span class="nc">IvParameterSpec</span><span class="p">(</span><span class="nc">ByteArray</span><span class="p">(</span><span class="mi">16</span><span class="p">)))</span> <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<p><code class="language-plaintext highlighter-rouge">EncryptionData</code> can be obtained from any track of the media playlist.</p>

<p>Critical for the success of decryption were the <code class="language-plaintext highlighter-rouge">chainmode</code> and the <code class="language-plaintext highlighter-rouge">NoPadding</code> argument.</p>

<ul>
  <li>Without any of those, e.g. just <code class="language-plaintext highlighter-rouge">AES</code>, the decryption would throw.</li>
  <li>With <code class="language-plaintext highlighter-rouge">NoPadding</code>, but a different <code class="language-plaintext highlighter-rouge">chainmode</code>, decryption would succeed, but the files were corrupted.</li>
</ul>

<p>I simply used trial and error until I found the right combination.</p>

<h3 id="demux">Demux</h3>

<p>MPEG-TS files are not the most ordinary media format and are therefore more difficult to work with. Instead of .ts files, it would be nice if we could just work with the audio as wav files. I have tried to find a way to do this in java, but ended up using FFMPEG because there was no suitable library for the job. There is <a href="https://github.com/jcodec/jcodec">JCodec</a>, but the api is awkward and it doesn‚Äôt seem like the required format is supported. FFMPEG is pretty easy to use via cli and supports a range of formats.</p>

<p>To demux a .ts segment to a .wav file, simply use the below code, where the target is a .wav File.</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">ffmpeg</span> <span class="o">-</span><span class="n">i</span> <span class="err">$</span><span class="o">{</span><span class="n">source</span><span class="o">.</span><span class="na">absolutePath</span><span class="o">}</span> <span class="err">$</span><span class="o">{</span><span class="n">target</span><span class="o">.</span><span class="na">absolutePath</span><span class="o">}</span>
</code></pre></div></div>

<p>Converting wav to mp3 is similarly easy:</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">ffmpeg</span> <span class="o">-</span><span class="n">i</span> <span class="err">$</span><span class="o">{</span><span class="n">file</span><span class="o">.</span><span class="na">absolutePath</span><span class="o">}</span> <span class="o">-</span><span class="n">acodec</span> <span class="n">libmp3lame</span> <span class="err">$</span><span class="o">{</span><span class="n">target</span><span class="o">.</span><span class="na">absolutePath</span><span class="o">}</span>
</code></pre></div></div>

<h3 id="merging">Merging</h3>

<p>Last step: merging the individual segments into one file.</p>

<p>I use the following to merge audio streams.</p>

<div class="language-kotlin highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">fun</span> <span class="nf">joinAudioStreams</span><span class="p">(</span><span class="n">streams</span><span class="p">:</span> <span class="nc">Collection</span><span class="p">&lt;</span><span class="nc">AudioInputStream</span><span class="p">&gt;):</span> <span class="nc">AudioInputStream</span> <span class="p">{</span>
    <span class="kd">val</span> <span class="py">vector</span> <span class="p">=</span> <span class="nc">Vector</span><span class="p">&lt;</span><span class="nc">InputStream</span><span class="p">&gt;(</span><span class="n">streams</span><span class="p">).</span><span class="nf">elements</span><span class="p">()</span>
    <span class="kd">val</span> <span class="py">format</span> <span class="p">=</span> <span class="n">streams</span><span class="p">.</span><span class="nf">first</span><span class="p">().</span><span class="n">format</span>
    <span class="k">return</span> <span class="nc">AudioInputStream</span><span class="p">(</span>
        <span class="nc">SequenceInputStream</span><span class="p">(</span><span class="n">vector</span><span class="p">),</span>
        <span class="n">format</span><span class="p">,</span>
        <span class="n">streams</span>
            <span class="p">.</span><span class="nf">map</span> <span class="p">{</span> <span class="n">it</span><span class="p">.</span><span class="n">frameLength</span> <span class="p">}</span>
            <span class="p">.</span><span class="nf">reduce</span><span class="p">(</span><span class="nc">Long</span><span class="o">::</span><span class="n">plus</span><span class="p">)</span>
    <span class="p">)</span>
<span class="p">}</span>
</code></pre></div></div>

<p>AudioInputStreams are obtained from files using <code class="language-plaintext highlighter-rouge">AudioSystem.getAudioInputStream</code> and writing to file is done with <code class="language-plaintext highlighter-rouge">AudioSystem.write</code>.</p>

<p>And that‚Äôs basically how I went from M3U8 playlists and encrypted ts segments to a single mp3.</p>]]></content><author><name>Andreas Volkmann</name><email>avolkmann@me.com</email></author><category term="blog" /><summary type="html"><![CDATA[Converting a M3U8 playlist to an mp3 file]]></summary></entry></feed>