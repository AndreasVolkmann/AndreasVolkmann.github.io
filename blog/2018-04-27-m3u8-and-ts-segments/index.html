<!DOCTYPE html>
<html lang="en"><!--
 __  __                __                                     __
/\ \/\ \              /\ \             __                    /\ \
\ \ \_\ \   __  __    \_\ \      __   /\_\      __       ___ \ \ \/'\
 \ \  _  \ /\ \/\ \   /'_` \   /'__`\ \/\ \   /'__`\    /'___\\ \ , <
  \ \ \ \ \\ \ \_\ \ /\ \L\ \ /\  __/  \ \ \ /\ \L\.\_ /\ \__/ \ \ \\`\
   \ \_\ \_\\/`____ \\ \___,_\\ \____\ _\ \ \\ \__/.\_\\ \____\ \ \_\ \_\
    \/_/\/_/ `/___/> \\/__,_ / \/____//\ \_\ \\/__/\/_/ \/____/  \/_/\/_/
                /\___/                \ \____/
                \/__/                  \/___/

Powered by Hydejack v8.5.1 <https://hydejack.com/>
--><head><meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no"><meta http-equiv="x-ua-compatible" content="ie=edge"><meta name="robots" content="noindex"><title>M3U8 playlists and .ts segments | Andreas Volkmann</title><meta name="generator" content="Jekyll v3.8.5" /><meta property="og:title" content="M3U8 playlists and .ts segments" /><meta name="author" content="Andreas Volkmann" /><meta property="og:locale" content="en" /><meta name="description" content="Converting a M3U8 playlist to an mp3 file" /><meta property="og:description" content="Converting a M3U8 playlist to an mp3 file" /><link rel="canonical" href="https://andreasvolkmann.github.io//blog/2018-04-27-m3u8-and-ts-segments/" /><meta property="og:url" content="https://andreasvolkmann.github.io//blog/2018-04-27-m3u8-and-ts-segments/" /><meta property="og:site_name" content="Andreas Volkmann" /><meta property="og:type" content="article" /><meta property="article:published_time" content="2018-04-27T00:00:00+02:00" /> <script type="application/ld+json"> {"url":"https://andreasvolkmann.github.io//blog/2018-04-27-m3u8-and-ts-segments/","publisher":{"@type":"Organization","logo":{"@type":"ImageObject","url":"https://andreasvolkmann.github.io//assets/icons/icon.png"},"name":"Andreas Volkmann"},"author":{"@type":"Person","name":"Andreas Volkmann"},"description":"Converting a M3U8 playlist to an mp3 file","headline":"M3U8 playlists and .ts segments","dateModified":"2018-04-27T00:00:00+02:00","datePublished":"2018-04-27T00:00:00+02:00","@type":"BlogPosting","mainEntityOfPage":{"@type":"WebPage","@id":"https://andreasvolkmann.github.io//blog/2018-04-27-m3u8-and-ts-segments/"},"@context":"http://schema.org"}</script><meta name="keywords" content="andreas,volkmann"><meta name="mobile-web-app-capable" content="yes"><meta name="apple-mobile-web-app-capable" content="yes"><meta name="apple-mobile-web-app-title" content="Andreas Volkmann"><meta name="apple-mobile-web-app-status-bar-style" content="black"><meta name="application-name" content="Andreas Volkmann"><meta name="msapplication-config" content="/assets/ieconfig.xml"><meta name="theme-color" content="rgb(25,55,71)"><meta name="generator" content="Hydejack v8.5.1" /><link type="application/atom+xml" rel="alternate" href="https://andreasvolkmann.github.io//feed.xml" title="Andreas Volkmann" /><link rel="alternate" href="https://andreasvolkmann.github.io//blog/2018-04-27-m3u8-and-ts-segments/" hreflang="en"><link rel="shortcut icon" href="/assets/icons/favicon.ico"><link rel="apple-touch-icon" href="/assets/icons/icon.png"><link rel="manifest" href="/assets/manifest.json"><link rel="dns-prefetch" href="https://fonts.googleapis.com"><link rel="dns-prefetch" href="https://fonts.gstatic.com"><link rel="dns-prefetch" href="/" id="_baseURL"><link rel="dns-prefetch" href="/assets/js/hydejack-legacy-8.5.1.js" id="_hrefJS"><link rel="dns-prefetch" href="/sw.js" id="_hrefSW"><link rel="dns-prefetch" href="/assets/bower_components/fontfaceobserver/fontfaceobserver.standalone.js" id="_hrefFFO"><link rel="dns-prefetch" href="/assets/bower_components/katex/dist/katex.min.js" id="_hrefKatexJS"><link rel="dns-prefetch" href="/assets/bower_components/katex/dist/katex.min.css" id="_hrefKatexCSS"><link rel="dns-prefetch" href="/assets/bower_components/katex/dist/contrib/copy-tex.min.js" id="_hrefKatexCopyJS"><link rel="dns-prefetch" href="/assets/bower_components/katex/dist/contrib/copy-tex.min.css" id="_hrefKatexCopyCSS"><link rel="dns-prefetch" href="/assets/img/swipe.svg" id="_hrefSwipeSVG"> <script> !function(e,t){"use strict";function n(e,t,n,r){e.addEventListener?e.addEventListener(t,n,r):e.attachEvent?e.attachEvent("on"+t,n):e["on"+t]=n}e.loadJS=function(e,r){var o=t.createElement("script");o.src=e,r&&n(o,"load",r,{once:!0});var a=t.scripts[0];return a.parentNode.insertBefore(o,a),o},e._loaded=!1,e.loadJSDeferred=function(r,o){function a(){e._loaded=!0,o&&n(d,"load",o,{once:!0});var r=t.scripts[0];r.parentNode.insertBefore(d,r)}var d=t.createElement("script");return d.src=r,e._loaded?a():n(e,"load",a,{once:!0}),d},e.setRel=e.setRelStylesheet=function(e){function n(){this.rel="stylesheet"}var r=t.getElementById(e);r.addEventListener?r.addEventListener("load",n,{once:!0}):r.onload=n}}(window,document); ; !function(a){"use strict";var b=function(b,c,d){function e(a){return h.body?a():void setTimeout(function(){e(a)})}function f(){i.addEventListener&&i.removeEventListener("load",f),i.media=d||"all"}var g,h=a.document,i=h.createElement("link");if(c)g=c;else{var j=(h.body||h.getElementsByTagName("head")[0]).childNodes;g=j[j.length-1]}var k=h.styleSheets;i.rel="stylesheet",i.href=b,i.media="only x",e(function(){g.parentNode.insertBefore(i,c?g:g.nextSibling)});var l=function(a){for(var b=i.href,c=k.length;c--;)if(k[c].href===b)return a();setTimeout(function(){l(a)})};return i.addEventListener&&i.addEventListener("load",f),i.onloadcssdefined=l,l(f),i};"undefined"!=typeof exports?exports.loadCSS=b:a.loadCSS=b}("undefined"!=typeof global?global:this); ; !function(a){if(a.loadCSS){var b=loadCSS.relpreload={};if(b.support=function(){try{return a.document.createElement("link").relList.supports("preload")}catch(b){return!1}},b.poly=function(){for(var b=a.document.getElementsByTagName("link"),c=0;c<b.length;c++){var d=b[c];"preload"===d.rel&&"style"===d.getAttribute("as")&&(a.loadCSS(d.href,d,d.getAttribute("media")),d.rel=null)}},!b.support()){b.poly();var c=a.setInterval(b.poly,300);a.addEventListener&&a.addEventListener("load",function(){b.poly(),a.clearInterval(c)}),a.attachEvent&&a.attachEvent("onload",function(){a.clearInterval(c)})}}}(this); ; !function(w, d) { w._noPushState = false; w._noDrawer = false; }(window, document); </script> <!--[if gt IE 8]><!----><style> body{--code-font-family: Menlo,Monaco,Consolas,monospace;--font-weight: 400;--font-weight-bold: 700;--font-weight-heading: 400;--text-muted: #888;--gray-bg: rgba(0,0,0,0.025);--gray-text: #666;--menu-text: #bbb;--body-color: #333;--body-bg: #fff;--border-color: #ebebeb}.clearfix,.sidebar-social::after{content:"";display:table;clear:both}.color-transition,body,p,hr,.hr,table:not(.highlight) td,table:not(.highlight) th,.message{transition:background-color 1s ease, border-color 1s ease}.no-color-transition{transition:none !important}*{box-sizing:border-box}html,body{margin:0;padding:0}html{font-size:16px;line-height:1.75}body{color:var(--body-color);background-color:var(--body-bg);font-weight:var(--font-weight);overflow-y:scroll}a{text-decoration:none}.lead{margin-left:-1rem;margin-right:-1rem}.content img,.img,.content video,.video{max-width:100%}.content img.lead,.img.lead,.content video.lead,.video.lead{max-width:calc(100% + 2rem);width:calc(100% + 2rem)}h1,h2,h3,h4,h5,h6,.h1,.h2,.h3,.h4,.h5,.h6{font-weight:var(--font-weight-heading);margin:5rem 0 1rem}h1,.h1{font-size:2rem;line-height:1.3}h2,.h2{font-size:1.5rem;line-height:1.4}h3,.h3{font-size:1.17em;line-height:1.5}h4,h5,h6,.h4,.h5,.h6{font-size:1rem;margin-bottom:0.5rem}p{margin-top:0;margin-bottom:1rem}p.lead{font-size:1.2em;margin-top:1.5rem;margin-bottom:1.5rem;padding:0 1rem}ul,ol,dl{margin-top:0;margin-bottom:1rem}ul,ol{padding-left:1.25rem}hr{position:relative;margin:3rem 0;border:0;border-top:1px solid var(--border-color)}.hr{border-bottom:1px solid var(--border-color);padding-bottom:1rem;margin-bottom:2rem}table:not(.highlight){border-collapse:collapse;margin-bottom:2rem;margin-left:-1rem}table:not(.highlight) td,table:not(.highlight) th{padding:.25rem .5rem;border:1px solid var(--border-color)}table:not(.highlight) td:first-child,table:not(.highlight) th:first-child{padding-left:1rem}table:not(.highlight) td:last-child,table:not(.highlight) th:last-child{padding-right:1rem}.page{margin-bottom:3em}.page li+li{margin-top:.25rem}.page>header{margin-bottom:2rem}.page-title,.post-title{margin-top:0}.post-date{display:block;margin-top:-0.5rem;margin-bottom:1rem;color:var(--text-muted)}.related-posts{padding-left:0;list-style:none;margin-bottom:2rem}.related-posts>li,.related-posts>li+li{margin-top:1rem}.message{margin-bottom:1rem;padding:1rem;color:var(--gray-text);background-color:var(--gray-bg);margin-left:-1rem;margin-right:-1rem}@media screen{body::before{content:'';width:.5rem;background:var(--border-color);position:fixed;left:0;top:0;bottom:0}}@media screen and (min-width: 64em){body::before{width:21rem}}@media screen and (min-width: 1666px){body::before{width:calc(50% - 28rem)}}@media screen and (min-width: 42em){html{font-size:17px}}@media screen and (min-width: 124em){html{font-size:18px}}.fade-in{animation-duration:500ms;animation-timing-function:ease;animation-name:fade-in;animation-fill-mode:forwards}@keyframes fade-in{from{transform:translateY(-3rem);opacity:0}50%{transform:translateY(-3rem);opacity:0}to{transform:translateY(0);opacity:1}}.fl{float:left}.fr{float:right}.mb4{margin-bottom:4rem}.mb6{margin-bottom:6rem}.mt0{margin-top:0}.mt2{margin-top:2rem}.mt3{margin-top:3rem}.mt4{margin-top:4rem}.pb0{padding-bottom:0}.sixteen-nine{position:relative}.sixteen-nine::before{display:block;content:"";width:100%;padding-top:56.25%}.sixteen-nine>*{position:absolute;top:0;left:0;right:0;bottom:0}.sr-only{display:none}.border{border:1px solid var(--border-color)}hy-push-state a,.a{position:relative;padding-bottom:.15rem;border-bottom:1px solid}hy-push-state a.no-hover,.a.no-hover{border-bottom:none;padding-bottom:0}.content .img{overflow:hidden}.content .img img{margin:0;width:100%;height:100%;background-color:var(--gray-bg)}hy-drawer{width:100%;position:relative;overflow:hidden}@media screen and (min-width: 64em){hy-drawer{position:fixed;width:21rem;top:0;left:0;bottom:0;margin-left:0}hy-drawer.cover{position:relative;width:100%}}@media screen and (min-width: 1666px){hy-drawer{width:calc(50% - 28rem)}}.sidebar{position:relative;display:flex;justify-content:center;align-items:center;color:rgba(255,255,255,0.75);text-align:center;z-index:2;min-height:100vh}.sidebar a{color:#fff;border-bottom-color:rgba(255,255,255,0.2)}.sidebar-bg{position:absolute;top:0;left:calc(50% - 50vw);width:100vw;height:100%;background:#202020 center / cover}.sidebar-bg::after{content:"";position:absolute;top:0;left:0;bottom:0;right:0;background:rgba(0,0,0,0.05)}.sidebar-bg.sidebar-overlay::after{background:linear-gradient(to bottom, rgba(32,32,32,0) 0%, rgba(32,32,32,0.5) 50%, rgba(32,32,32,0) 100%)}.sidebar-sticky{position:relative;z-index:3;max-width:21rem;padding:1.5rem;contain:content}.sidebar-about .avatar{margin-bottom:1.5rem}.sidebar-about>h2{margin-top:0}.sidebar-nav>ul{list-style:none;padding-left:0}a.sidebar-nav-item{display:inline-block;font-weight:var(--font-weight-heading);line-height:1.75;padding:.25rem;border-bottom:1px solid rgba(255,255,255,0.2)}.sidebar-social>ul{display:inline-block;list-style:none;padding-left:0;margin-bottom:0}.sidebar-social>ul>li{float:left}.sidebar-social>ul>li>a{display:inline-block;text-align:center;font-size:1.4rem;width:3rem;height:4rem;padding:.5rem 0;line-height:3rem}.sidebar-social>ul li+li{margin-top:0}.fixed-common,.fixed-top,.fixed-bottom{position:fixed;left:0;width:100%;z-index:2}.fixed-top{top:0}.fixed-bottom{bottom:0}.navbar>.content{padding-top:0;padding-bottom:0;min-height:0;color:var(--menu-text)}.nav-btn-bar{margin:0 -1rem 0 -.875rem}.nav-btn{background:none;border:none;padding:1.75rem .875rem;color:var(--menu-text) !important;cursor:pointer}.animation-main{opacity:0;pointer-events:none}.content{position:relative;margin-left:auto;margin-right:auto;padding:6rem 1rem 12rem}@media screen{.content{padding-left:1.5rem;max-width:38rem;min-height:100vh}}@media screen and (min-width: 54em){.content{max-width:42rem}}@media screen and (min-width: 64em){.content{padding-left:1rem;margin-left:24rem;margin-right:3rem}}@media screen and (min-width: 88em){.content{margin-left:25rem;margin-right:4rem;max-width:48rem}}@media screen and (min-width: 1666px){.content{margin:auto}}.avatar{width:6.5rem;height:6.5rem;border-radius:100%;overflow:hidden}@media screen and (min-width: 88em){.avatar{width:7rem;height:7rem}}.content .avatar{float:right;margin-left:.5rem}html{font-family:Noto Sans,Helvetica,Arial,sans-serif}h1,h2,h3,h4,h5,h6,.h1,.h2,.h3,.h4,.h5,.h6,.heading{font-family:Roboto Slab,Helvetica,Arial,sans-serif}</style><link rel="preload" as="style" href="/assets/css/hydejack-8.5.1.css" id="_stylePreload"><link rel="preload" as="style" href="/assets/icomoon/style.css" id="_iconsPreload"><link rel="preload" as="style" href="https://fonts.googleapis.com/css?family=Roboto+Slab:400|Noto+Sans:400,400i,700,700i&display=swap" id="_fontsPreload"> <script>setRel('_stylePreload');setRel('_iconsPreload');/**/setRel('_fontsPreload');/**/</script> <noscript><link rel="stylesheet" href="/assets/css/hydejack-8.5.1.css"><link rel="stylesheet" href="/assets/icomoon/style.css"><link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto+Slab:400|Noto+Sans:400,400i,700,700i&display=swap"> </noscript><style id="_pageStyle"> .content a:not(.btn){color:#4fb1ba;border-color:rgba(79,177,186,0.2)}.content a:not(.btn):hover{border-color:#4fb1ba}:focus{outline-color:#4fb1ba !important}.btn-primary{color:#fff;background-color:#4fb1ba;border-color:#4fb1ba}.btn-primary:focus,.btn-primary.focus,.form-control:focus,.form-control.focus{box-shadow:0 0 0 3px rgba(79,177,186,0.5)}.btn-primary:hover,.btn-primary.hover{color:#fff;background-color:#409ba3;border-color:#409ba3}.btn-primary:disabled,.btn-primary.disabled{color:#fff;background-color:#4fb1ba;border-color:#4fb1ba}.btn-primary:active,.btn-primary.active{color:#fff;background-color:#409ba3;border-color:#409ba3}::selection{color:#fff;background:#4fb1ba}::-moz-selection{color:#fff;background:#4fb1ba}</style><!--<![endif]--><body class="no-color-transition"><div id="_navbar" class="navbar fixed-top"><div class="content"><div class="nav-btn-bar"> <span class="sr-only">Jump to:</span> <a id="_menu" class="nav-btn no-hover fl" href="#_navigation"> <span class="sr-only">Navigation</span> <span class="icon-menu"></span> </a></div></div></div><hr class="sr-only" hidden /> <hy-push-state replace-ids="_main" link-selector="a[href]:not([href*='/assets/']):not(.external):not(.no-push-state)" duration="250" script-selector="script:not([type^='math/tex'])" prefetch ><main id="_main" class="content fade-in layout-post" role="main" data-color="rgb(79,177,186)" data-theme-color="rgb(25,55,71)" data-image="/assets/img/sidebar-bg.jpg" data-overlay ><article id="post-blog-m3u8-and-ts-segments" class="page post mb6" role="article"><header><h1 class="post-title"> M3U8 playlists and .ts segments</h1><p class="post-date heading"> <time datetime="2018-04-27T00:00:00+02:00">27 Apr 2018</time> in <span>Blog</span><p class="message" > Converting a M3U8 playlist to an mp3 file</header><p>I was recently working on my <a href="https://github.com/AndreasVolkmann/nhk-easy-kumo">NHK-Easy web crawler project</a>, since the site got an update with a number of breaking changes. One of these changes was concerning the audio of the articles.<p>Previously, each article had a corresponding static .mp3 resource. The update introduced a new HLS (HTTP Live Streaming) media player, accompanied by a M3U8 playlist. Furthermore, I observed that the audio was now split into several ts file segments, which were loaded on demand.<p>I had never worked with these file types before, so off I went to google. However, it wasn’t exactly easy to find answers to my questions, which is why I decided to summarize my findings here, in case other people have similar issues. Also, I wanted to have a go at writing my first post.<blockquote><p>Given a master M3U8 playlist, the goal is to end up with a single mp3 file.</blockquote><p>  <hy-img root-margin="512px"  src="/assets/img/m3u8.png" alt="Overview of M3U8 playlist structure." >    <noscript><img data-ignore  src="/assets/img/m3u8.png" alt="Overview of M3U8 playlist structure." /></noscript>    <span class="loading" slot="loading" hidden>      <span class="icon-cog"></span>    </span>  </hy-img><h3 id="master-playlist">Master Playlist</h3><p>The first step when dealing with M3U8, is parsing the master playlist.<p>I found the open-m3u8 library by iHeartRadio works best. The alternative is Comcast’s hlsparserj, but it lacks features and requires more manual work.<p>Once the master playlist is parsed, one can read its content, which consists of one or more media playlists.<h3 id="media-playlist">Media Playlist</h3><p>A typical media playlist could look like the following.<div class="language-css highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nf">#EXTM3U</span>
<span class="nf">#EXT-X-TARGETDURATION</span><span class="nd">:6</span>
<span class="nf">#EXT-X-ALLOW-CACHE</span><span class="nd">:YES</span>
<span class="nf">#EXT-X-KEY</span><span class="nd">:METHOD</span><span class="o">=</span><span class="nt">AES-128</span><span class="o">,</span><span class="nt">URI</span><span class="o">=</span><span class="s1">"https://site.net/path/to/resource.mp4/crypt.key?id=somekey"</span>
<span class="nf">#EXT-X-PLAYLIST-TYPE</span><span class="nd">:VOD</span>
<span class="nf">#EXT-X-VERSION</span><span class="nd">:3</span>
<span class="nf">#EXT-X-MEDIA-SEQUENCE</span><span class="nd">:1</span>
<span class="nf">#EXTINF</span><span class="nd">:6</span><span class="nc">.000</span><span class="o">,</span>
<span class="nt">https</span><span class="o">://</span><span class="nt">site</span><span class="nc">.net</span><span class="o">/</span><span class="nt">path</span><span class="o">/</span><span class="nt">to</span><span class="o">/</span><span class="nt">resource</span><span class="nc">.mp4</span><span class="o">/</span><span class="nt">segment1_0_a</span><span class="nc">.ts</span>
<span class="nf">#EXTINF</span><span class="nd">:6</span><span class="nc">.000</span><span class="o">,</span>
<span class="nt">https</span><span class="o">://</span><span class="nt">site</span><span class="nc">.net</span><span class="o">/</span><span class="nt">path</span><span class="o">/</span><span class="nt">to</span><span class="o">/</span><span class="nt">resource</span><span class="nc">.mp4</span><span class="o">/</span><span class="nt">segment2_0_a</span><span class="nc">.ts</span>
<span class="nf">#EXTINF</span><span class="nd">:6</span><span class="nc">.000</span><span class="o">,</span>
<span class="nt">https</span><span class="o">://</span><span class="nt">site</span><span class="nc">.net</span><span class="o">/</span><span class="nt">path</span><span class="o">/</span><span class="nt">to</span><span class="o">/</span><span class="nt">resource</span><span class="nc">.mp4</span><span class="o">/</span><span class="nt">segment3_0_a</span><span class="nc">.ts</span>
<span class="nf">#EXTINF</span><span class="nd">:1</span><span class="nc">.992</span><span class="o">,</span>
<span class="nt">https</span><span class="o">://</span><span class="nt">site</span><span class="nc">.net</span><span class="o">/</span><span class="nt">path</span><span class="o">/</span><span class="nt">to</span><span class="o">/</span><span class="nt">resource</span><span class="nc">.mp4</span><span class="o">/</span><span class="nt">segment4_0_a</span><span class="nc">.ts</span>
<span class="nf">#EXT-X-ENDLIST</span>
</code></pre></div></div><p>It contains an url for each segment that the stream is made up of. Additionally, there are a number of meta tags, of which one is particularly important.<h3 id="encryption">Encryption</h3><p>What took me the longest to figure out was that the segments were encrypted. According to specification, MPEG-TS files (.ts) start with a BOM (Byte Order Mark) in the form of the ASCII char <code class="highlighter-rouge">G</code>. What confused me was, that there was no <code class="highlighter-rouge">G</code>, since the files were encrypted. Lesson learned, go read <a href="https://tools.ietf.org/html/draft-pantos-http-live-streaming-23#section-3">the specification</a>.<p>Here is how I handle the encryption.<div class="language-kotlin highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">fun</span> <span class="nf">getCipher</span><span class="p">(</span><span class="nv">data</span><span class="p">:</span> <span class="nc">EncryptionData</span><span class="p">):</span> <span class="nc">Cipher</span> <span class="p">{</span>
    <span class="kd">val</span> <span class="py">bytes</span> <span class="p">=</span> <span class="n">URL</span><span class="p">(</span><span class="n">data</span><span class="p">.</span><span class="n">uri</span><span class="p">).</span><span class="n">readBytes</span><span class="p">()</span>
    <span class="kd">val</span> <span class="py">chainmode</span> <span class="p">=</span> <span class="s">"CBC"</span>
    <span class="kd">val</span> <span class="py">method</span> <span class="p">=</span> <span class="k">when</span> <span class="p">(</span><span class="n">data</span><span class="p">.</span><span class="n">method</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">EncryptionMethod</span><span class="p">.</span><span class="n">AES</span> <span class="p">-&gt;</span> <span class="s">"AES/$chainmode/NoPadding"</span>
        <span class="k">else</span> <span class="p">-&gt;</span> <span class="n">data</span><span class="p">.</span><span class="n">method</span><span class="p">.</span><span class="n">name</span>
    <span class="p">}</span>
    <span class="kd">val</span> <span class="py">keySpec</span> <span class="p">=</span> <span class="n">SecretKeySpec</span><span class="p">(</span><span class="n">bytes</span><span class="p">,</span> <span class="n">data</span><span class="p">.</span><span class="n">method</span><span class="p">.</span><span class="n">name</span><span class="p">)</span>
    <span class="n">logger</span><span class="p">.</span><span class="n">trace</span><span class="p">(</span><span class="s">"Decrypting using method ${data.method} ($method)"</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">Cipher</span>
        <span class="p">.</span><span class="n">getInstance</span><span class="p">(</span><span class="n">method</span><span class="p">)</span>
        <span class="p">.</span><span class="n">apply</span> <span class="p">{</span> <span class="n">init</span><span class="p">(</span><span class="n">Cipher</span><span class="p">.</span><span class="n">DECRYPT_MODE</span><span class="p">,</span> <span class="n">keySpec</span><span class="p">,</span> <span class="n">IvParameterSpec</span><span class="p">(</span><span class="n">ByteArray</span><span class="p">(</span><span class="m">16</span><span class="p">)))</span> <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div><p><code class="highlighter-rouge">EncryptionData</code> can be obtained from any track of the media playlist.<p>Critical for the success of decryption were the <code class="highlighter-rouge">chainmode</code> and the <code class="highlighter-rouge">NoPadding</code> argument.<ul><li>Without any of those, e.g. just <code class="highlighter-rouge">AES</code>, the decryption would throw.<li>With <code class="highlighter-rouge">NoPadding</code>, but a different <code class="highlighter-rouge">chainmode</code>, decryption would succeed, but the files were corrupted.</ul><p>I simply used trial and error until I found the right combination.<h3 id="demux">Demux</h3><p>MPEG-TS files are not the most ordinary media format and are therefore more difficult to work with. Instead of .ts files, it would be nice if we could just work with the audio as wav files. I have tried to find a way to do this in java, but ended up using FFMPEG because there was no suitable library for the job. There is <a href="https://github.com/jcodec/jcodec">JCodec</a>, but the api is awkward and it doesn’t seem like the required format is supported. FFMPEG is pretty easy to use via cli and supports a range of formats.<p>To demux a .ts segment to a .wav file, simply use the below code, where the target is a .wav File.<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">ffmpeg</span> <span class="o">-</span><span class="n">i</span> <span class="err">$</span><span class="o">{</span><span class="n">source</span><span class="o">.</span><span class="na">absolutePath</span><span class="o">}</span> <span class="err">$</span><span class="o">{</span><span class="n">target</span><span class="o">.</span><span class="na">absolutePath</span><span class="o">}</span>
</code></pre></div></div><p>Converting wav to mp3 is similarly easy:<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">ffmpeg</span> <span class="o">-</span><span class="n">i</span> <span class="err">$</span><span class="o">{</span><span class="n">file</span><span class="o">.</span><span class="na">absolutePath</span><span class="o">}</span> <span class="o">-</span><span class="n">acodec</span> <span class="n">libmp3lame</span> <span class="err">$</span><span class="o">{</span><span class="n">target</span><span class="o">.</span><span class="na">absolutePath</span><span class="o">}</span>
</code></pre></div></div><h3 id="merging">Merging</h3><p>Last step: merging the individual segments into one file.<p>I use the following to merge audio streams.<div class="language-kotlin highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">fun</span> <span class="nf">joinAudioStreams</span><span class="p">(</span><span class="nv">streams</span><span class="p">:</span> <span class="nc">Collection</span><span class="p">&lt;</span><span class="nc">AudioInputStream</span><span class="p">&gt;):</span> <span class="nc">AudioInputStream</span> <span class="p">{</span>
    <span class="kd">val</span> <span class="py">vector</span> <span class="p">=</span> <span class="n">Vector</span><span class="p">&lt;</span><span class="n">InputStream</span><span class="p">&gt;(</span><span class="n">streams</span><span class="p">).</span><span class="n">elements</span><span class="p">()</span>
    <span class="kd">val</span> <span class="py">format</span> <span class="p">=</span> <span class="n">streams</span><span class="p">.</span><span class="n">first</span><span class="p">().</span><span class="n">format</span>
    <span class="k">return</span> <span class="n">AudioInputStream</span><span class="p">(</span>
        <span class="n">SequenceInputStream</span><span class="p">(</span><span class="n">vector</span><span class="p">),</span>
        <span class="n">format</span><span class="p">,</span>
        <span class="n">streams</span>
            <span class="p">.</span><span class="n">map</span> <span class="p">{</span> <span class="n">it</span><span class="p">.</span><span class="n">frameLength</span> <span class="p">}</span>
            <span class="p">.</span><span class="n">reduce</span><span class="p">(</span><span class="n">Long</span><span class="o">::</span><span class="n">plus</span><span class="p">)</span>
    <span class="p">)</span>
<span class="p">}</span>
</code></pre></div></div><p>AudioInputStreams are obtained from files using <code class="highlighter-rouge">AudioSystem.getAudioInputStream</code> and writing to file is done with <code class="highlighter-rouge">AudioSystem.write</code>.<p>And that’s basically how I went from M3U8 playlists and encrypted ts segments to a single mp3.</article><hr class="dingbat related" /><aside class="about related mt4 mb4" role="complementary"><div class="author mt4"> <hy-img src="https://placehold.it/128x128" class="avatar" alt="Andreas Volkmann" srcset="https://placehold.it/128x128 1x,https://placehold.it/256x256 2x" root-margin="512px" > <noscript><img data-ignore src="https://placehold.it/128x128" class="avatar" alt="Andreas Volkmann" srcset="https://placehold.it/128x128 1x,https://placehold.it/256x256 2x" /></noscript> <span class="loading" slot="loading" hidden> <span class="icon-cog"></span> </span> </hy-img><h2 class="page-title hr"> About</h2><p>Any opinions expressed on this site are my own and do not represent the views of my employer.<div class="sidebar-social"> <span class="sr-only">Social:</span><ul><li> <a href="https://github.com/AndreasVolkmann" title="GitHub" class="no-mark-external"> <span class="icon-github"></span> <span class="sr-only">GitHub</span> </a><li> <a href="https://soundcloud.com/shin-kudo" title="SoundCloud" class="no-mark-external"> <span class="icon-soundcloud"></span> <span class="sr-only">SoundCloud</span> </a><li> <a href="http://www.last.fm/user/shadowgonzo" title="Last.fm" class="no-mark-external"> <span class="icon-lastfm"></span> <span class="sr-only">Last.fm</span> </a><li> <a href="http://stackoverflow.com/users/5335131/andreas-volkmann" title="Stack Overflow" class="no-mark-external"> <span class="icon-stackoverflow"></span> <span class="sr-only">Stack Overflow</span> </a><li> <a href="https://www.linkedin.com/in/andreas-volkmann-a5553a106" title="LinkedIn" class="no-mark-external"> <span class="icon-linkedin2"></span> <span class="sr-only">LinkedIn</span> </a></ul></div></div></aside><aside class="related mb4" role="complementary"><h2 class="hr">Related Posts</h2><ul class="related-posts"><li> <a href="/blog/2020-02-20-spring-kotlin-gradle-aop/" class="h4 flip-title"><span>Aspect Oriented Programming: Spring, Kotlin, Gradle</span></a> <time class="heading faded fine" datetime="2020-02-20T00:00:00+01:00">20 Feb 2020</time></ul></aside><footer role="contentinfo"><hr/><p><small class="copyright">© 2020. All rights reserved. </small><hr class="sr-only"/></footer></main><hy-drawer class="" align="left" threshold="10" touch-events prevent-default ><header id="_sidebar" class="sidebar" role="banner"><div class="sidebar-bg sidebar-overlay" style="background-color:rgb(25,55,71);background-image:url(/assets/img/sidebar-bg.jpg)"></div><div class="sidebar-sticky"><div class="sidebar-about"> <a class="no-hover" href="/" tabindex="-1"> <img src="/assets/icons/icon.png" class="avatar" alt="Andreas Volkmann" data-ignore /> </a><h2 class="h1"><a href="/">Andreas Volkmann</a></h2><p class=""> Personal page.</div><nav class="sidebar-nav heading" role="navigation"> <span class="sr-only">Navigation:</span><ul><li> <a id="_navigation" href="/posts/" class="sidebar-nav-item" > Blog </a><li> <a href="/about/" class="sidebar-nav-item" > About </a></ul></nav><div class="sidebar-social"> <span class="sr-only">Social:</span><ul><li> <a href="https://github.com/AndreasVolkmann" title="GitHub" class="no-mark-external"> <span class="icon-github"></span> <span class="sr-only">GitHub</span> </a><li> <a href="https://soundcloud.com/shin-kudo" title="SoundCloud" class="no-mark-external"> <span class="icon-soundcloud"></span> <span class="sr-only">SoundCloud</span> </a><li> <a href="http://www.last.fm/user/shadowgonzo" title="Last.fm" class="no-mark-external"> <span class="icon-lastfm"></span> <span class="sr-only">Last.fm</span> </a><li> <a href="http://stackoverflow.com/users/5335131/andreas-volkmann" title="Stack Overflow" class="no-mark-external"> <span class="icon-stackoverflow"></span> <span class="sr-only">Stack Overflow</span> </a><li> <a href="https://www.linkedin.com/in/andreas-volkmann-a5553a106" title="LinkedIn" class="no-mark-external"> <span class="icon-linkedin2"></span> <span class="sr-only">LinkedIn</span> </a></ul></div></div></header></hy-drawer><hr class="sr-only" hidden /> </hy-push-state> <!--[if gt IE 10]><!----> <script type="module">window.__ESM__=!0; import '/assets/js/hydejack-8.5.1.js';</script> <script nomodule>if (!window.__ESM__) loadJSDeferred(document.getElementById('_hrefJS').href);</script> <!--<![endif]--><h2 class="sr-only" hidden>Templates (for web app):</h2><template id="_animation-template" hidden><div class="animation-main fixed-top"><div class="content"><div class="page"></div></div></div></template> <template id="_loading-template" hidden><div class="loading nav-btn fr"> <span class="sr-only">Loading…</span> <span class="icon-cog"></span></div></template> <template id="_error-template" hidden><div class="page"><h1 class="page-title">Error</h1><p class="lead"> Sorry, an error occurred while loading <a class="this-link" href=""></a>.</div></template> <template id="_forward-template" hidden> <button id="_forward" class="forward nav-btn no-hover fl"> <span class="sr-only">Forward</span> <span class="icon-arrow-right2"></span> </button> </template> <template id="_back-template" hidden> <button id="_back" class="back nav-btn no-hover fl"> <span class="sr-only">Back</span> <span class="icon-arrow-left2"></span> </button> </template> <template id="_permalink-template" hidden> <a href="#" class="permalink"> <span class="sr-only">Permalink</span> <span class="icon-link"></span> </a> </template></html>
